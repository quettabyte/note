# DataCom HCIA 笔记

[TOC]

## 进制转换

1. 二进制
2. 十进制
3. 十六进制

## IPv4编制

1. 单播*Unicast*:用于点对点转发，目的IP为`A、B、C类`的数据帧称为单播帧，单播ipv4地址代表一个节点或者一个接口。
2. 广播*Broadcast*：用于点到所有，收到广播，必须接收，目的IP为`255.255.255.255`称为广播帧。
3. 组播/多播*Multicast*：用于点对多点，目的IP为`D类`的数据帧称为组播/多播帧，广播是一种特殊的组播。

### 特殊地址

1.  `0.0.0.0`

   未分配，保留，用途：dhcp、ppp交互。

2. `255.255.255.255`

   全网广播，影响面太大。

3. `169.254.0.0/16`

   ipv4链路本地（link-local），RFC3927定义，当dhcp获取不到地址，windows会自动获取169.254.0.0/16

   这个地址只能本链路（局域网）转发，不能穿越路由器。

4. `127.0.0.0/8`

   本地回环地址（localhost），代表本设备。

### 有类地址

```
A类：1.0.0.0 ~ 126.255.255.255
     范围：network.host.host.host
B类：128.0.0.0 ~ 191.255.255.255
     范围：network.network.host.host
C类：192.0.0.0 ~ 223.255.255.255
     范围：network.network.network.host
D类：224.0.0.0 ~ 239.255.255.255
     范围：network.group.group.group
E类：240.0.0.0 ~ 255.255.255.255
     保留，不分配使用
```

存在的问题：有类网络出现的场景在于刚开始ipv4地址没有大规模使用的情况

1.地址浪费。2.网络太大，效率低。3.全部在一个网络，有安全隐患。

### 无类地址

有类地址的问题可以通过subnet子网来解决 —— 隔离网络

**子网掩码**：subnet mask，在二进制表示中，必须连续，不能中断。

意义：标识对应ipv4地址中哪些bit表示网络，哪些表示主机，界定网络的范围

例如：`255.255.0.0`、`255.255.224.0`、`255.255.255.0`

> CIDR：无类域间路由
>
> 1、VLSM：把ipv4网络划小，目的是为了隔离
>
> 2、super 超网（summary）汇总：减少路由条目
>
> 汇总本质：减少路由条目，提高查表的效率，降低资源消耗

**题型**

计算子网网段、子网地址范围、可用地址范围、广播地址

题1：ip address：1.1.1.130，network mask：255.255.255.128

答：网络号（网段）：1.1.1.128，子网地址范围：1.1.1.128 ~ 1.1.1.255，可用地址范围：1.1.1.129 ~ 1.1.1.254，广播地址：1.1.1.255

## Ping通原理

接口或者终端获取到ip地址后，会首先向外发送免费ARP，用于地址冲突检测

免费ARP-Request（target ip为自己的ip），对方收到ARP-Request，检查targetip是否为自己的IP，如果是就是地址冲突，发arp-reply，如果不是证明地址没有冲突，不回应。

<img src="https://lnfeng-pic.oss-cn-wulanchabu.aliyuncs.com/datacom-note/2024-6-16-14-21-44.png" alt="2024-6-16-14-21-44.png" style="zoom: 80%;" />

1. 在AR1中执行`ping 10.10.12.2`。

2. 查询路由表，意义：过滤掉没有必要转发的流量，节省资源。

   ![2024-6-22-12-45-08.png](https://lnfeng-pic.oss-cn-wulanchabu.aliyuncs.com/datacom-note/2024-6-22-12-45-08.png)

3. 如果有路由就进行封装

   | DATA              | IP-Header                         | MAC-Header                              |
   | ----------------- | --------------------------------- | --------------------------------------- |
   | ICMP echo-request | sip:10.10.12.1； dip:10.10.12.2； | type:0x0806；SMAC:AR1；DMAC:查询ARP表； |

4. 查询ARP表中没有查到10.10.12.2的MAC地址，需要发送ARP请求获取10.10.12.2的MAC地址

5. 封装ARP-Request，发送数据

   | ARP                                                          | MAC-Header                                              |
   | ------------------------------------------------------------ | ------------------------------------------------------- |
   | Sender-mac:AR1；Sender-ip:10.10.12.1；Target-mac: 00:00:00:00:00:00；Target-ip:10.10.12.2； | type:0x0806；SMAC:AR1；DMAC:FF:FF:FF:FF:FF:FF（广播）； |

   > 正常ARP：Target ip为想知道该IP的MAC地址
   >
   > 免费ARP：Target ip为自己本身的IP

6. AR2收到bit流，格式化为以太帧。

7. 读取二层头部


* 如果是广播，dmac FFFFFFFFFFFF，由于IG=1，所以是广播或者组播，读完确定是广播，收

* 如果是组播，dmac 01005e000001，由于IG=1，所以是广播或者组播，读完确定是组播，检查接口是否侦听次组播组，如果侦听就收，如果不侦听，就不收
* 如果是单播，dmac 00005e000002，由于IG=0，所以是单播，读完之后，跟入接口去比较，如果dmac是入接口mac地址，那么收，如果dmac不是入接口mac地址，就不收

8. 如果收，检查type，由于type为0x0806，代表后面是arp的数据，二层头部拆除，提交数据给ARP进程。

9. ARP进程读取arp-request数据

* 读取target ip，检查target ip是否是我自己，如果target ip不是我自己的接口ip，忽略
* 如果target ip是我自己的接口ip，回复arp-reply。
* 查询自己的arp表中是否有sender ip的MAC地址，若没有，则添加到自己的ARP表项中。

10. 封装arp-reply数据

    | ARP                                                          | MAC-Header                                |
    | ------------------------------------------------------------ | ----------------------------------------- |
    | Sender-mac:AR2；Sender-ip:10.10.12.2；Target-mac: AR1；Target-ip:10.10.12.1； | type:0x0806；SMAC:AR2；DMAC:AR1（单播）； |

11. AR1收到bit流，同AR2收到bit流的流程相同，ARP进程读取arp-reply数据，更新ARP条目。

    ![2024-6-16-16-12-04.png](https://lnfeng-pic.oss-cn-wulanchabu.aliyuncs.com/datacom-note/2024-6-16-16-12-04.png)

### 扩展-三层设备转发原理

eg：访问`http://www.baidu.com`

```
1. 查询DNS， www.baidu.com------ipv4地址多少？4.5.6.7
2. 查询路由表： 4.5.6.7的路由
3. 如果有开始封装：
Http| tcp sport X dport 80 | sip 172.16.12.1 dip 4.5.6.7 | smac AR1 dmac ？
4. 查询arp
	查询网关mac地址
	Arp-request 
	Arp-reply
	更新网关mac
5. 数据转发
Http| tcp sport X dport 80 | sip 172.16.12.1 dip 4.5.6.7 | smac AR1 dmac AR2
```

## 网络设备管理

### 用户登录

1. 本地管理

   console（串口）：权限最大

   > [!Tip]
   >
   > 串口服务器（RJ45线序）：
   >
   > 服务器端：橙白、橙、绿白、蓝、蓝白、绿、棕白、棕（正常网络线序）
   >
   > 设备端：绿白、蓝、橙、蓝白、绿、橙白、棕白、棕

   <img src="https://lnfeng-pic.oss-cn-wulanchabu.aliyuncs.com/datacom-note/2024-6-21-11_33_33.png" alt="2024-6-21-11_33_33.png" style="zoom: 80%;" />

2. 远程管理

   Vty（virtual terminal）：虚拟终端

   * telnet：明文传输，不安全，端口号23
   * SSH：加密传输，端口号22

   | 用户级别 | 命令级别   | 级别名称 | 说明                                                         |
   | -------- | :--------- | -------- | ------------------------------------------------------------ |
   | 0        | 0          | 参观级   | ping、tracert、telnet等                                      |
   | 1        | 0、1       | 监控级   | display,并不是所有display命令都是监控级，例如：**dis cu**、**dis saved-cu**是3级 |
   | 2        | 0、1、2    | 配置级   | 业务配置命令。                                               |
   | 3 ~ 15   | 0、1、2、3 | 管理级   | 文件系统、用户管理命令、命令级别设置、业务故障诊断的debugging命令等。 |
   

#### 设置进行仅密码验证方式

```
<HUAWEI> system-view
[HUAWEI] user-interface vty 0
[HUAWEI-ui-vty0] authentication-mode password
[HUAWEI-ui-vty0] set authentication password cipher huawei@123
[HUAWEI-ui-vty0] user privilege level 0 默认
```

#### 设置进行AAA授权验证方式

```
<HUAWEI> system-view
[HUAWEI] user-interface vty 0
[HUAWEI-ui-vty0] authentication-mode aaa
[HUAWEI-ui-vty0] quit
[HUAWEI] aaa
[HUAWEI-aaa] local-user huawei password cipher huawei@123
[HUAWEI-aaa] local-user huawei privilege level 3
[HUAWEI-aaa] local-user huawei service-type telnet 只能用于telnet的认证
```

**AAA**架构：

1. authentication 认证 
2. authorization 授权 
3. accounting 审计 --- 网络设备不支持审计

> [!Note]
>
> AAA协议： Radius --- 公有协议、Htacas --- 华为私有

### 配置文件

current-configuration --- 当前运行的配置，保存在内存中，重启/掉电丢失

startup-configuration --- 启动配置

save --- 保存配置

* 默认把current-configuration保存为`vrpcfg.zip`（默认保存格式）
* `save xxx.cfg`自定义命名配置文件

delete --- 删除配置

```
<AR2>delete flash:/20240606-ar2.cfg
Delete flash:/20240606-ar2.cfg? (y/n)[n]:y
Info: Deleting file flash:/20240606-ar2.cfg...succeed.
```

可以指定配置文件启动

```
<AR2>startup saved-configuration flash:/20240606-ar2.cfg
[AR1]display startup 
MainBoard: 
  Startup system software:                   null
  Next startup system software:              null
  Backup system software for next startup:   null
  Startup saved-configuration file:          flash:/vrpcfg.zip
  Next startup saved-configuration file:     flash:/20240606-ar2.cfg
  Startup license file:                      null
  Next startup license file:                 null
  Startup patch package:                     null
  Next startup patch package:                null
  Startup voice-files:                       null
  Next startup voice-files:                  null
```

### 文件备份

1. 路由器是ftp server

   ```
   Ftp server enable --- 开启ftp server功能
   # aaa 
   local-user ftp password cipher 123 --- 用户名和密码用于认证
   local-user ftp privilege level 3 --- 权限
   local-user ftp ftp-directory flash: --- ftp家目录
   local-user ftp service-type ftp --- 专门用于ftp的认证
   ```

2. 路由器是ftp client

   **登录FTP服务器**

   ```
   <Huawei>ftp 172.16.23.3
   Trying 172.16.23.3 ...
   
   Press CTRL+K to abort
   Connected to 172.16.23.3.
   220 FTP service ready.
   User(172.16.23.3:(none)):ftp
   331 Password required for ftp.
   Enter password:
   230 User logged in.
   
   [Huawei-ftp]
   ```

   **常用命令**

   ```
   [Huawei-ftp] dir --- 查看服务器的文件
   [Huawei-ftp] get 20240622-ar3.cfg（服务器的文件） --- 从服务器get文件
   [Huawei-ftp] put 20240622-ar2.cfg（本地文件系统的文件）--- 向服务器put文件
   <Huawei> dir --- 确认文件get成功
   ```

## DHCP

1. Bootp协议：server prot：`67`，client port：`68`

2. DHCP（dynamic host configuration protocol）：动态主机配置协议

   封装在Bootp协议中，引入`option`选项，可以自定义获取信息内容option封装格式：TLV

**DHCP协商过程**

![2024-6-22-16-56-58.png](https://lnfeng-pic.oss-cn-wulanchabu.aliyuncs.com/datacom-note/2024-6-22-16-56-58.png)

1. Client: `Discovery` - - - >

   Sip: 0.0.0.0(未分配)|Dip: 255.255.255.255|Smac: AR1|Dmac:FF:FF:FF:FF:FF:FF

2. Server: `Offer` - - - >

   Sip: 192.168.1.254|Dip: 192.168.1.252(分配地址)|Smac: AR2|Dmac: AR1

3. Client: `Request` - - - >

   Sip: 0.0.0.0(未分配)|Dip: 255.255.255.255|Smac: AR1|Dmac: FF:FF:FF:FF:FF:FF

4. Server: `Ack` - - - >

   Sip: 192.168.1.254|Dip: 192.168.1.252(分配地址)|Smac: AR2|Dmac: AR1

5. DAD - - - > 免费ARP（地址冲突检测）

   地址冲突检测 (冲突)：

   ![2024-6-22-16-57-20.png](https://lnfeng-pic.oss-cn-wulanchabu.aliyuncs.com/datacom-note/2024-6-22-16-57-20.png)

   Client: `Decline` - - - >

   Sip: 0.0.0.0(未分配)|Dip: 255.255.255.255|Smac: AR1|Dmac: FF:FF:FF:FF:FF:FF

   报告server地址冲突，server会记录该ip已分配，不会向外分配该ip。

   Client: 重新发送`Discovery`获取地址。

6. 如果server收到request，发现租期有问题（没有租约，或者租约不一致

   Server: `Nak` - - - >

   client收到Nak报文,重新发送`Discovery`获取地址。

7. 如果客户端不需要IP地址，重启

   Client: `Release` - - - >

   Server收到Release报文后，释放地址，地址重新回到地址池。

8. 如果客户终端还需要更多的信息，那么会发送`Inform`消息，获取更多信息


### 基于接口部署

基于接口的dhcp部署方式，适用于客户端和server在同一个vlan，只能适用于中小企业

server：

```
<Huawei>system-view 
[Huawei]dhcp enable 
[Huawei]interface GigabitEthernet 0/0/0
[Huawei-GigabitEthernet0/0/0]ip address 192.168.1.254 24
[Huawei-GigabitEthernet0/0/0]dhcp select interface 
[Huawei-GigabitEthernet0/0/0]dhcp server exclude-ip-address 192.168.1.253
[Huawei-GigabitEthernet0/0/0]dhcp server lease day 2
[Huawei-GigabitEthernet0/0/0]dhcp server dns-list 114.114.114.114 8.8.8.8
[Huawei-GigabitEthernet0/0/0]dhcp server static-bind ip-address 192.168.1.252 mac-address 00e0-fcc5-6be9
```

client:

```
<Huawei>system-view 
[Huawei]dhcp enable 
[Huawei]interface GigabitEthernet 0/0/0
[Huawei-GigabitEthernet0/0/0]ip address dhcp-alloc
```

### 基于中继和全局的部署方式

![2024-6-22-18-51-02.png](https://lnfeng-pic.oss-cn-wulanchabu.aliyuncs.com/datacom-note/2024-6-22-18-51-02.png)

1. 客户端发送Discovery(广播)报文
2. 中继收到后根据配置将报文转换成单播发送到服务端
3. 服务端收到后，回复offer到中继
4. 中继在转发到客户端

`Client`：

![2024-6-22-18-50-35.png](https://lnfeng-pic.oss-cn-wulanchabu.aliyuncs.com/datacom-note/2024-6-22-18-50-35.png)

`Server`:

![2024-6-22-18-50-50.png](https://lnfeng-pic.oss-cn-wulanchabu.aliyuncs.com/datacom-note/2024-6-22-18-50-50.png)

**配置**

server：

```
[Huawei]dhcp enable
# 使用全局地址池
[Huawei]ip pool vlan24
[Huawei-ip-pool-vlan24]gateway-list 172.16.12.2 
[Huawei-ip-pool-vlan24]network 172.16.12.0 mask 255.255.255.0 
[Huawei-ip-pool-vlan24]static-bind ip-address 172.16.12.11 mac-address xx-xx...
[Huawei-ip-pool-vlan24]excluded-ip-address 172.16.12.253 172.16.12.254 
[Huawei-ip-pool-vlan24]dns-list 114.114.114.114 8.8.8.8

#配置接口
[Huawei]interface GigabitEthernet 0/0/0
[Huawei-GigabitEthernet0/0/0]ip add 192.168.24.4 24
[Huawei-GigabitEthernet0/0/0]dhcp select global

#配置路由
[Huawei]ip route-static  172.16.12.0 24 192.168.24.2
```

中继：

```
dhcp enable
#
interface GigabitEthernet0/0/0
 ip address 172.16.12.2 255.255.255.0 
 dhcp select relay
 dhcp relay server-ip 192.168.24.4
#
interface GigabitEthernet0/0/1
 ip address 192.168.24.2 255.255.255.0 
```

## PPP


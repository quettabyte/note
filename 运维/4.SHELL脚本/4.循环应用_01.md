## 循环应用

### 一、循环介绍

```
重复

for、while、until
```



### 二、for循环的应用

```
语法1：

for 变量 in 取值列表; do
	执行的操作
	执行的操作
done
```

```
语法2: 

for 变量 in 取值列表
do
	执行的操作
	执行的操作
done
```

```
#!/bin/bash
#

for i in 1 2 3; do
   echo "AAAA"
done
```

```
#!/bin/bash
#

for i in 1 2 3; do
    echo "第$i次循环开始"
    echo "-------------"
    echo "第$i次循环结束"
done
```

```
获取连续的数字:

# seq 5
# seq 2 5
# seq 1 2 10
```



#### 案例1: 创建测试文件

```
#!/bin/bash
#

if [ $# -ne 1 ]; then
   echo "帮助: $0 <目录名称>"
   exit 7
fi

# 判断目录是否存在

if [ ! -e $1 ]; then
    mkdir -p $1
fi

# 创建文件
for i in $(seq 20); do
    touch $1/$(openssl rand -hex 10)
done

```



#### 案例2: 批量创建用户user1....user20

```
#!/bin/bash
#

for i in $(seq 20); do
   name=user$i
   if id $name &> /dev/null; then
       echo "用户$name已存在"
   else
      useradd $name
      echo "redhat" | passwd --stdin $name &> /dev/null
      echo "用户$name创建完成, 初始密码为redhat"
   fi
done
```



#### 案例3: 批量创建用户user01, user02, user03....user09, user10, user11....user20 

```
#!/bin/bash
#

name=user0

for i in $(seq 20); do
   if [ $i -gt 9 ]; then
      name=user
   fi

   if id $name$i &> /dev/null; then
       echo "用户$name$i已存在"
   else
      useradd $name$i
      echo "用户$name$i创建完成"
   fi
done
```



#### 案例4: 批量创建用户

```
注意:
	for循环读取文件区分行时，会按照换行符、空白字符区分行

[root@es-master ~]# cat /tmp/userlist
martin
robin
lz
harry
tome
natasha
king
demon

#!/bin/bash
#

for i in $(cat /tmp/userlist); do
    if id $i &> /dev/null; then
        echo "用户$i已存在"
    else
        useradd $i
        echo "用户$i创建完成 "
    fi
done
```



#### 案例5: 检测在线主机

```
启用多线程

#!/bin/bash
#

network=192.168.183.

for i in $(seq 254); do
{
     ip=$network$i
     if ping -c 1 -W 1 $ip &> /dev/null; then
          echo "Host $ip is up"
     fi
}&
done
wait
```



#### 案例6: 实现文件批量重命名 

```
字符串替换: 

[root@es-master ~]# file_name=/data/10.txt
[root@es-master ~]# echo ${file_name/txt/mp3}
/data/10.mp3
```

```
#!/bin/bash
#

for file_name in $(find /data/ -name "*.txt"); do
     new_file_name=${file_name/txt/mp3}
     mv $file_name $new_file_name
done
```



#### 案例7: 校验文件 

```
#!/bin/bash
#

for file_name in $(find /data/bj/ -name "*" | sed '1d'); do
    #获取对应目录下同名的文件 
    dest_file_name=${file_name/bj/sh}
    if [ ! -e $dest_file_name ]; then
       echo "文件$dest_file_name缺失"
    else
       source_file_md5=$(md5sum $file_name | awk '{print $1}')
       dest_file_md5=$(md5sum $dest_file_name | awk '{print $1}')
       if [ $source_file_md5 != $dest_file_md5 ]; then
            echo "文件$dest_file_name数据不一致"
       fi
    fi
done
```



### 三、中断循环的语句 

```
continue
	中断本次循环，立即开始下一次循环
	
#!/bin/bash
#

for i in $(seq 5); do
    echo "第$i次循环开始"
    echo "-------------"
    if [ $i -eq 3 ]; then
       continue
    fi
    echo "第$i次循环结束"
done	

	
break
	中断整体循环
	
#!/bin/bash
#

for i in $(seq 5); do
    echo "第$i次循环开始"
    echo "-------------"
    if [ $i -eq 3 ]; then
       break
    fi
    echo "第$i次循环结束"
done
```



#### 案例: 获取在线的同网段主机的IP地址及MAC地址 

```
#!/bin/bash
#

network=192.168.183.

local_ip=$(ifconfig ens33 | grep "netmask" | awk '{print $2}')
local_mac=$(ifconfig ens33 | grep "ether" | awk '{print $2}')

echo "本机IP地址: $local_ip, 本机MAC地址: $local_mac"
echo "----------------------------------------------"


for i in $(seq 254); do
    ip=$network$i
    if [ $ip == $local_ip ]; then
       continue
    fi
    if ping -c 1 -W 1 $ip &> /dev/null; then
        mac_address=$(arping -c 1 -w 1 -I ens33 $ip | grep "^Unicast" | awk '{print $5}')
        echo "IP地址: $ip, MAC地址: $mac_address"
    fi
done
```



### 四、while循环应用

#### 1、常规语法 

```
语法:

while 条件; do
    执行的操作
    执行的操作
done
```

```
#!/bin/bash
#

i=1

while [ $i -le 5 ]; do
    touch /tmp/$(openssl rand -hex 10)
    let i++
done
```



#### 2、语法2

```
while true; do
	执行的操作
	执行的操作
done
```

```
#!/bin/bash
#

while true; do
    uptime
    sleep 1
done
```

```
#!/bin/bash
#

i=1

while true; do
    uptime
    sleep 1
    let i++
    if [ $i -eq 6 ]; then
       break
    fi
done
```

```
#!/bin/bash
#

cat << eof
------虚拟机管理-------

1. 创建虚拟机
2. 销毁虚拟机
3. 更新虚拟机配置
4. 退出

eof

while true; do
   read -p "选择: " choice
   case $choice in
     1)
       echo "执行创建"
       ;;
     2)
       echo "执行销毁"
       ;;
     3)
       echo "执行更新"
       ;;
     4)
       exit 0
       ;;
     *)
      echo "输入有误，检查"
      ;;
   esac
done
```



#### 3、语法3

```
适用于遍历文件、处理命令结果 
```

```
语法:

while read line; do
   执行的操作
   执行的操作
done < 文件名称
```

```
#!/bin/bash
#

while read line; do
   echo "---> $line"
done < /tmp/test01
```

#### 案例: 获取所有的系统用户

```
#!/bin/bash
#

echo "系统用户列表: "

while read line; do
     user_id=$(echo $line | awk -F: '{print $3}') 
     if [ $user_id -gt 1 -a $user_id -lt 1000 ]; then
        user_name=$(echo $line | awk -F: '{print $1}')
        echo $user_name
     fi    
done < /etc/passwd
```

#### 案例: 将/etc/passwd文件中的每行内容分段存入数据库

```
MariaDB [(none)]> create database test01;
Query OK, 1 row affected (0.00 sec)

MariaDB [(none)]> use test01;

MariaDB [test01]> create table user_info(
    -> id INT primary key not null auto_increment,
    -> name char(20),
    -> user_id int,
    -> group_id int,
    -> comment char(20),
    -> home_dir char(30),
    -> sh_name char(30));
Query OK, 0 rows affected (0.01 sec)
```

```
在shell终端执行SQL语句:

# mysql -u用户名 -e "SQL语句"
```

```
#!/bin/bash
#

while read line; do
     name=$(echo $line | awk -F: '{print $1}')
     user_id=$(echo $line | awk -F: '{print $3}')
     group_id=$(echo $line | awk -F: '{print $4}')
     comment=$(echo $line | awk -F: '{print $5}')
     home_dir=$(echo $line | awk -F: '{print $6}')
     sh_name=$(echo $line | awk -F: '{print $7}')
     mysql -uroot -e "insert into test01.user_info(name,user_id,group_id,comment,home_dir,sh_name) values('$name', $user_id, $group_id, '$comment', '$home_dir', '$sh_name')"
done < /etc/passwd
```

#### 案例: 检测磁盘

```
#!/bin/bash
#

df -hT | grep "^/" | while read line; do
     usage=$(echo $line | awk '{print $6}' | awk -F% '{print $1}')
     if [ $usage -gt 20 ]; then
        disk_name=$(echo $line | awk '{print $1}')
        mount_point=$(echo $line | awk '{print $7}')
        echo "磁盘名称: $disk_name, 挂载点: $mount_point"
     fi
done
```

#### 案例: 统计TCP连接状态的数量

```
#!/bin/bash
#

listen_number=0
es_number=0

while read line; do
    state=$(echo $line | awk '{print $6}')
    if [ $state == "LISTEN" ]; then
         let listen_number++
    elif [ $state == "ESTABLISHED" ]; then
         let es_number++
    fi
done < <(netstat -antp | grep "^tcp")

echo "Listen状态连接数量: $listen_number, Established状态连接数量: $es_number"
```








































## sed工具

### 一、sed工具介绍

```
作用: 
	流编辑器  stream editor
	修改文本内容 
```

```
原理: 
	默认情况下，sed不会修改原文件的， 所有的修改都是在内存中进行
	逐行修改
	sed会将文件内容逐行读入到内存(模式空间), 在内存中文件内容进行修改，修改完毕后默认还会将内存所有的内容重写向到显示器上
```

#### 1、正则表达式

##### 1) 匹配单个字符的元字符 

```
.   [art]	[a-z]	[A-Z]	[0-9]	[a-zA-Z0-9]
[[:space:]]
```

##### 2) 匹配字符出现的次数

```
*		任意次
	.*
\+		至少一次
\?		最多出现一次, 可有可无
\{3\}	精确出现3次
	\{3,\}		\{3,5\}
```

##### 3）分组

```
\(abc\)\?
```

##### 4) 匹配字符出现的位置

```
^string		以string开头
string$		以string结尾 
^$			空行
```



#### 2、sed使用格式

```
# sed [option] 'script' 文件名称 
```

```
# sed [option] 'lineCOMMAND' 文件名称

	line: 指定行， 可以不写，表示所有行
	COMMAND: 操作
```



#### 3、行的表示方法

```
1、行号 

	10	第10行
	
2、范围

	起始行号, 终止行号
		2,5
		2,+3
		2,/^#/	
	
				
3、正则表达式 

	/正则表达式/
	
		/^#/
	
4、/正则表达式1/,/正则表达式2/
```





### 二、常用操作指令

#### 1、d	删除整行 

```
[root@es-master ~]# sed '1d' /etc/hosts
```

```
[root@es-master ~]# netstat -antp | sed '1,2d'
```

```
[root@es-master ~]# sed '/^#/d' /etc/fstab 
```

```
[root@es-master ~]# sed '/^\//d' /etc/fstab 
```



#### 2、p	显示整行的内容 

```
[root@es-master ~]# sed -n '/^#/p' /etc/fstab 

	-n: 取消显示模式空间的内容
```

```
[root@es-master ~]# netstat -antp | sed -n '/^tcp/p'
```

```
[root@es-master ~]# sed -n '/Feb 20 09:03:30/,/Feb 20 09:03:35/p' /var/log/messages 
```



#### 3、a  \string	追加内容 

```
[root@es-master ~]# sed '$a \1.1.1.1 node01' /etc/hosts
```

```
[root@es-master ~]# sed '/^#/a \hello' /etc/fstab
```

```
[root@es-master ~]# sed '$a \export JAVA_HOME=/usr/local/jdk1.8.0' /etc/profile
```



#### 4、i  \string		插入内容 

```
[root@es-master ~]# sed '1i \----file start--------' /etc/hosts
```



#### 5、c  \string		整行替换

```
[root@es-master ~]# sed  '/^#Port/c \Port 44444' /etc/ssh/sshd_config 
```

```
[root@es-master ~]# sed  '/^SELINUX=/c \SELINUX=enforcing' /etc/sysconfig/selinux 
```



#### 6、w   文件名称		另存为

```
[root@es-master ~]# sed -n '/^#/w /tmp/file01' /etc/fstab 
```



#### 7、r    文件名称		合并文件 

```
[root@es-master ~]# sed  '$r /etc/redhat-release' /etc/hosts
```



#### 8、=		显示行号/统计行数 

```
[root@es-master ~]# sed -n '$=' /etc/hosts
```



#### 9、n	读取下一行 

```
[root@es-master ~]# sed -n 'n;p' /tmp/file01
```

```
[root@es-master ~]# sed -n 'p;n' /tmp/file01
```



#### 10、替换

```
s/旧内容/新内容/[修饰符]

	旧内容: 支持正则表达式
	修饰符:
		i	忽略大小写
		g	替换整行所有
```

```
[root@es-master ~]# sed 's/UUID/uuid/' /etc/fstab
```

```
[root@es-master ~]# sed 's/[0-9]/?/g' /etc/fstab
```

```
[root@es-master ~]# sed '/^Listen/s/80/9000/' /etc/httpd/conf/httpd.conf
```

```
[root@es-master ~]# sed 's/\//!/g' /etc/fstab

[root@es-master ~]# sed 's|/|!|g' /etc/fstab
```

```
[root@es-master ~]# sed  '/^Password/s|yes|no|' /etc/ssh/sshd_config
```

```
[root@es-master ~]# sed 's|^#||' /etc/fstab
```

```
[root@es-master ~]# history | sed 's|^[[:space:]]\+||'
```

##### 反向引用       \1    \2  \3 

```
[root@es-master ~]# sed 's|\(l..e\)|\1r|' /tmp/file01 
```

##### &: sed内部变量，代表匹配的所有旧内容

```
[root@es-master ~]# sed 's|l..e|&r|' /tmp/file01 
```

```
[root@es-master ~]# sed 's|l\(..e\)|L\1|' /tmp/file01 
```



### 三、常用选项

#### 1、-n		取消sed默认显示模式空间的数据

```
[root@es-master ~]# sed -n '/^#/p' /etc/fstab 
```



#### 2、-i		直接修改原文件

```
[root@es-master ~]# sed -i '/^192/d' /etc/hosts
```



#### 3、-e		多条件的操作

```
[root@es-master ~]# sed -e '/^$/d' -e '/^#/d' /etc/fstab 
```



#### 4、-f  操作文件 		多条件的操作

```
[root@es-master ~]# cat /tmp/sedOP
/^$/d
/^#/d
[root@es-master ~]# sed -f /tmp/sedOP /etc/fstab 
```



#### 5、-r    支持扩展正则表达式

```
[root@es-master ~]# sed -r 's|l(..e)|L\1|' /tmp/file01 
```



#### 6、--follow-symlinks	修改软链接文件

```
[root@es-master ~]# sed -i --follow-symlinks '1,3d' /tmp/f1 
```

```
[root@es-master ~]# sed -i --follow-symlinks '/^SELINUX=/s|enforcing|disabled|' /etc/sysconfig/selinux
```





## 函数应用

### 一、函数作用

```
作用:
	1、方便脚本二次开发 
	2、方便功能的重复使用 
```

#### 1、定义函数

```
语法1:

函数名称() {
	执行的操作
	执行的操作
}
```

```
语法2: 

function 函数名称() {
	执行的操作
	执行的操作
}
```

#### 2、调用函数

```
函数名称
```



#### 案例: 函数语法应用

```
#!/bin/bash
#

# 定义函数
star() {
   echo "*****"
}


# 调用函数
star
```

```
#!/bin/bash
#

star() {
    for i in $(seq 3); do
        echo "*"
    done
}


star
echo "------------"
star
```

#### 3、结合位置变量增强功能的灵活性 

```
#!/bin/bash
#

# 定义函数, $1：循环的次数
star() {
    for i in $(seq $1); do
        echo "*"
    done
}

# 调用函数
star 2
echo "----------------"
star 4
```



#### 案例：编写nginx服务控制脚本

##### 1、安装nginx软件

```
[root@es-master ~]# yum install -y gcc pcre-devel openssl-devel zlib-devel 

[root@es-master ~]# wget http://nginx.org/download/nginx-1.19.7.tar.gz

[root@es-master ~]# tar xf nginx-1.19.7.tar.gz 
[root@es-master ~]# cd nginx-1.19.7/
[root@es-master nginx-1.19.7]# ./configure --prefix=/usr/local/nginx 
[root@es-master nginx-1.19.7]# make 
[root@es-master nginx-1.19.7]# make install 
```

```
#!/bin/bash
#

nginx_cmd=/usr/local/nginx/sbin/nginx
nginx_pid_file=/usr/local/nginx/logs/nginx.pid

start() {
    $nginx_cmd
    if [ $? -eq 0 ]; then
       echo "nginx启动成功..."
    else
       echo "nginx启动失败..."
    fi
}


stop() {
   $nginx_cmd -s stop
}


restart() {
    stop
    sleep 1
    start
}

status() {
   if [ -e $nginx_pid_file ]; then
       echo "nginx(PID $(cat $nginx_pid_file)) is running."
   else
       echo "nginx is stopped"
   fi
}
reload() {
    kill -1 $(cat $nginx_pid_file)
}


# 判断是否有参数
if [ $# -ne 1 ]; then
    echo "帮助: $0 {start|stop|restart|reload|status}"
    exit 8
fi


case $1 in
   start)
      start
      ;;
   stop)
      stop
      ;;
   restart)
      restart
      ;;
   status)
      status
      ;;
   reload)
      reload
      ;;
   *)
      echo "参数错误"
      echo "帮助: $0 {start|stop|restart|reload|status}"
      ;;
esac
```














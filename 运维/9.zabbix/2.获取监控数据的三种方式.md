## 基于zabbix agent获取监控数据的三种方式

### 一、监控远程主机

#### 1、在被监控端安装部署zabbix agent

```
[root@node01 ~]# yum install -y zabbix-agent 

[root@node01 ~]# vim /etc/zabbix/zabbix_agentd.conf 
Server=192.168.140.10
ServerActive=192.168.140.10
Hostname=node01.linux.com

[root@node01 ~]# systemctl start zabbix-agent
[root@node01 ~]# systemctl enable zabbix-agent
 
[root@node01 ~]# netstat -antp | grep zabbix
tcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      7135/zabbix_agentd  
tcp6       0      0 :::10050                :::*                    LISTEN      7135/zabbix_agentd  
```

#### 2、在web管理界面添加被监控端 

![image-20210315100305895](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210315100305895.png)



#### 3、链接模板

![image-20210315101247723](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210315101247723.png)



#### 4、创建图形

![image-20210315101927631](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210315101927631.png)



#### 5、创建聚合图形

![image-20210315102236958](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210315102236958.png)

![image-20210315102409072](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210315102409072.png)





### 三、获取数据的三种方式

#### 1、链接模板 

```
服务器系统自身的监控
	CPU
		cpu使用率、cpu负载
	内存
		内存剩余量
	硬盘
		关键性硬盘的剩余量、IO
	网卡
		流量/IO(流入流量 、流出流量、总流量、错误数据包流量)
	进程数 
	用户数
```



#### 2、利用zabbix自带的键值key 

##### 1) 监控主机的网卡流入流量 

![image-20210315111703166](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210315111703166.png)



##### 2) 常用键值

```
1、内核数据相关
	kernel.maxfiles
	kernel.maxproc
	
2、网卡流量
	net.if.in[if,<mode>]	
		⇒ net.if.in[eth0,errors]
		⇒ net.if.in[eth0]
	net.if.out[if,<mode>]
	net.if.total[if,<mode>]
	
3、监控TCP服务状态

	net.tcp.listen[port]
		⇒ net.tcp.listen[80]
	net.tcp.port[<ip>,port]
		⇒ net.tcp.port[,3306]
		
4、监控UDP服务状态
	net.udp.listen[port]
		⇒ net.udp.listen[68]
		
5、进程状态
	proc.cpu.util[<name>,<user>,<type>,<cmdline>,<mode>,<zone>]
		- proc.cpu.util[mysqld]
		- proc.cpu.util[,www]
		- proc.cpu.util[nginx,nginx]
		
	proc.mem[<name>,<user>,<mode>,<cmdline>,<memtype>]
	
	proc.num[<name>,<user>,<state>,<cmdline>,<zone>]
		- proc.num[httpd]
		- proc.num[,,zomb]
		
6、磁盘容量

	vfs.fs.size[fs,<mode>]
		⇒ vfs.fs.size[/tmp,free]
		
7、检验文件

	vfs.file.cksum[file]
		⇒ vfs.file.cksum[/etc/passwd]

8、内存大小
	vm.memory.size[<mode>]
```



##### 





#### 3、自定义键值key

```
在被监控端进行自定义键值

UnsafeUserParameters=1		//允许key的名称中出现特殊符号 
UserParameter=<key>,<shell command>
```

##### 示例1：监控MySQL连接数

##### 1) 编辑agent配置文件，自定义key

```
UnsafeUserParameters=1
UserParameter=mysql_conn_number,mysql -uroot -e "show processlist" | sed '1d' | wc -l

[root@node01 ~]# systemctl restart zabbix-agent
```

##### 2) 在zabbix server端测试获取数据

```
[root@zabbix-server ~]# zabbix_get -s 192.168.140.11 -k mysql_conn_number
```

##### 3) 在web管理界面添加监控项、创建图形



##### 示例2: 监控MySQL用户数

```
UserParameter=mysql_user_number,mysql -uroot -e "select count(*) from mysql.user" | sed -n '2p'
```



#### 4、自定义带有参数的键值key

```
UserParameter=memory.size[*],awk  '/^$1/{print $$2}' /proc/meminfo

注意:
	$1		zabbix变量，用于代表键值的第一个参数
	$$2		对awk中的$2进行转义
```



```
注意: 
	确保zabbix用户对shell命令拥有读取、执行的权限
```









##### MySQL监控指标参考

```
1、服务状态
net.tcp.port

2、数据目录剩余容量
vfs.fs.size

3、连接数

4、MySQL服务器的运行状态

[root@node01 ~]# mysql ‐uroot ‐e "status"
mysql Ver 15.1 Distrib 5.5.65‐MariaDB, for Linux (x86_64) using readline 5.1

 Connection id: 759
 Current database:
 Current user: root@localhost
 SSL: Not in use
 Current pager: stdout
 Using outfile: ''
 Using delimiter: ;
 Server: MariaDB
 Server version: 5.5.65‐MariaDB MariaDB Server
 Protocol version: 10
 Connection: Localhost via UNIX socket
 Server characterset: latin1
 Db characterset: latin1
 Client characterset: utf8
 Conn. characterset: utf8
 UNIX socket: /var/lib/mysql/mysql.sock
 Uptime: 24 min 27 sec
 Threads: 1 Questions: 6053 Slow queries: 0 Opens: 201 Flush tables: 2 Open tables:
 Queries per second avg: 4.126

uptime: MySQL运行时长
Threads: 线程数
Slow queries：慢查询数量
Queries per second avg：执行查询操作平均时长

5、MySQL扩展运行状态

[root@node01 ~]# mysqladmin extended‐status

  Com_delete：数据库执行delete的次数
  Com_insert：数据库执行insert的次数
  Com_select：数据库执行select的次数
  Com_update：数据库执行update的次数

  Com_commit: 提交的事务的次数

  Threads_created 创建的线程数
  Threads_running 正在处理请求的线程数

  Subquery_cache_hit //子查询的缓存命中数
  Subquery_cache_miss //子查询的缓存丢失数

  Qcache_hits //所有查询的缓存命中

  Cpu_time //数据库消耗的CPU资源

  Bytes_received //网卡接收的数据量
  Bytes_sent //网卡发送的数据量

  Connections //处理的连接数
```





#### 任务1：

```
1、分别监控node01主机网卡的流入、流出、总流量及错误的数据包流量， 并创建图形
2、监控node01主机/etc/passwd文件数据变化， 并创建图形
3、在node01上分别安装ftp, httpd, mysql, ntp服务，监控所有服务的状态，并创建图形
4、在node01添加一块2G硬盘，创建200M分区，并挂载到/opt/data目录；监控该分区的剩余空间；
并创建图形
5、分别监控node01主机以apache用户、mysql用户启动的进程数， 并创建图形
6、分别监控node01主机httpd, mysql进程所占用的CPU使用率、及内存
7、监控物理内存剩余量、buffer/cache大小、并创建图形
8、部署MySQL主从复制，监控从服务器IO、SQL线程状态、复制延迟
```



#### 任务2

```
1、查询nginx, redis, tomcat监控指标 
```








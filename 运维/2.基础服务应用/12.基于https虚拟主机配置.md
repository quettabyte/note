## 基于https虚拟主机配置

### 一、https介绍

```
http
	明文, 80/tcp 
https
	密文, 443/tcp 
```



### 二、安全性保障

```
1、数据安全性 
	数据加密
2、数据完整性
3、验证身份的真实性、有效性
```



### 三、数据安全性

```
手段: 加密 
发送方加密数据，接收方解密数据 


对称加密算法
	加密、解密数据时使用的密钥是一样的
	代表性算法: 
		DES, 3DES,  AES

加密数据: 
[root@web_server ~]# openssl enc -e -des -in /tmp/file01 -out /tmp/file01_new 
enter des-cbc encryption password:
Verifying - enter des-cbc encryption password:

解密数据: 
[root@nfs_server ~]# openssl enc -d -des -in /tmp/file01_new -out /tmp/file01
enter des-cbc decryption password:


	
非对称加密算法
	加密、解密数据时使用的密钥是不一样的 
	基于密钥对实现
		公钥加密数据、私钥解密数据 
	代表性算法: 
		DSA、RSA
		
	借助gpg工具
		

对称加密算法
	速度快、安全较低 
	
非对称加密算法
	速度慢、安全较高 
	
实际应用:
	使用对称算法加密真实的数据，使用非对称加密算法加密对称算法使用的密钥

```



### 四、数据完整性

```
借助数学算法对数据进行校验

主机A利用算法对数据进行校验，生成校验码，同时将校验码、数据发送给主机B
主机B接收到数据后，利用相同的数学算法再进行校验运算，对比校验码 

代表性算法: 
	MD5, SHA   
	
[root@nfs_server ~]# md5sum /tmp/file01 
0bee89b07a248e27c83fc3d5951213c1  /tmp/file01

[root@nfs_server ~]# sha512sum /tmp/file01 
4f285d0c0cc77286d8731798b7aae2639e28270d4166f40d769cbbdca5230714d848483d364e2f39fe6cb9083c15229b39a33615ebc6d57605f7c43f6906739d  /tmp/file01
```



### 五、身份真实性验证

```
密钥对: 
	私钥签名、公钥验证签名
	
流程:
1、电商服务器生成证书申请【.csr文件】， 同时将电商服务器的公钥放入证书申请；将证书申请发送给CA
2、CA审批信息, 通过后CA会使用自己的私钥进行签名；相当于签署证书【.crt】
3、客户端访问电商服务器时，服务器会将证书信息发送给客户端 
4、客户端通过CA的公钥验证证书，验证通过后可获取电商服务器的公钥
5、客户端选取对称算法、密钥，使用公钥加密，发送给服务器、服务器解密 
6、进行真实数据交互
```





### 六、部署https虚拟主机 

​	需求: 基于https协议部署虚拟主机，名称为www.linux.com



#### 一、部署CA服务器 

##### 1、创建CA服务器需要的数据库文件 

```
[root@ca ~]# touch /etc/pki/CA/index.txt
[root@ca ~]# echo 01 > /etc/pki/CA/serial
```



##### 2、创建CA服务器需要的密钥对 

```
[root@ca ~]# openssl genrsa -out /etc/pki/CA/private/cakey.pem 1024
Generating RSA private key, 1024 bit long modulus
......++++++
......++++++
e is 65537 (0x10001)

[root@ca ~]# ls /etc/pki/CA/private/
cakey.pem
```



##### 3、生成自签证书 CA 的证书 

```
[root@ca ~]# openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -out /etc/pki/CA/cacert.pem -days 3650 
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:cn
State or Province Name (full name) []:bj
Locality Name (eg, city) [Default City]:bj
Organization Name (eg, company) [Default Company Ltd]:bj
Organizational Unit Name (eg, section) []:bj
Common Name (eg, your name or your server's hostname) []:ca.linux.com
Email Address []:bj@qq.com

[root@ca ~]# ls /etc/pki/CA/
cacert.pem  certs  crl  index.txt  newcerts  private  serial
```



#### 二、部署https协议的虚拟主机

##### 1、生成网站需要的密钥对 

```
[root@web_server ~]# mkdir /etc/httpd/ssl
[root@web_server ~]# openssl genrsa -out /etc/httpd/ssl/www.linux.com.key 1024
Generating RSA private key, 1024 bit long modulus
..................++++++
.....................................................++++++
e is 65537 (0x10001)

[root@web_server ~]# ls /etc/httpd/ssl/
www.linux.com.key
```



##### 2、生成证书申请 

```
[root@web_server ~]# openssl req -new -key /etc/httpd/ssl/www.linux.com.key -out /etc/httpd/ssl/www.linux.com.csr 
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:cn
State or Province Name (full name) []:bj
Locality Name (eg, city) [Default City]:bj
Organization Name (eg, company) [Default Company Ltd]:bj
Organizational Unit Name (eg, section) []:bj
Common Name (eg, your name or your server's hostname) []:www.linux.com
Email Address []:bj@qq.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
[root@web_server ~]# 
[root@web_server ~]# ls /etc/httpd/ssl/
www.linux.com.csr
```



##### 3、将证书申请发送给CA  

```
[root@web_server ~]# rsync -av /etc/httpd/ssl/www.linux.com.csr root@192.168.183.12:/tmp/
root@192.168.183.12's password: 
sending incremental file list
www.linux.com.csr

sent 765 bytes  received 34 bytes  319.60 bytes/sec
total size is 668  speedup is 0.84
```



##### 4、在CA服务器上签署证书 

```
[root@ca ~]# openssl ca -in /tmp/www.linux.com.csr -out /etc/pki/CA/certs/www.linux.com.crt -days 3650 
Using configuration from /etc/pki/tls/openssl.cnf
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: 1 (0x1)
        Validity
            Not Before: Jan 13 06:13:39 2021 GMT
            Not After : Jan 11 06:13:39 2031 GMT
        Subject:
            countryName               = cn
            stateOrProvinceName       = bj
            organizationName          = bj
            organizationalUnitName    = bj
            commonName                = www.linux.com
            emailAddress              = bj@qq.com
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                85:BE:32:50:0D:0A:FC:0F:9D:23:44:5F:F1:BF:92:4B:A4:E2:18:2B
            X509v3 Authority Key Identifier: 
                keyid:C1:20:CE:7D:6B:48:0F:F8:FB:CD:4E:77:0F:B8:28:61:EC:AA:A0:EC

Certificate is to be certified until Jan 11 06:13:39 2031 GMT (3650 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated

[root@ca ~]# cat /etc/pki/CA/index.txt
V	310111061339Z		01	unknown	/C=cn/ST=bj/O=bj/OU=bj/CN=www.linux.com/emailAddress=bj@qq.com
[root@ca ~]# 
[root@ca ~]# cat /etc/pki/CA/serial 
02
```



##### 5、将证书拷贝到网站服务器 

```
[root@ca ~]# rsync -av /etc/pki/CA/certs/www.linux.com.crt root@192.168.183.11:/etc/httpd/ssl 
```



##### 6、安装mod_ssl模块 

```
[root@web_server ~]# yum install -y mod_ssl 
```



##### 7、编辑ssl配置文件

```
[root@web_server ~]# vim /etc/httpd/conf.d/ssl.conf 

<VirtualHost _default_:443>

# General setup for the virtual host, inherited from global configuration

DocumentRoot "/linux"
ServerName www.linux.com:443

SSLCertificateFile /etc/httpd/ssl/www.linux.com.crt
SSLCertificateKeyFile /etc/httpd/ssl/www.linux.com.key

<Directory "/linux">
    Require all granted
</Directory>

```



##### 8、创建测试网页，重启httpd

```
[root@web_server ~]# mkdir /linux
[root@web_server ~]# vim /linux/index.html
[root@web_server ~]# cat /linux/index.html
<h1> 加密网站 </h1>
[root@web_server ~]# 
[root@web_server ~]# httpd -t
Syntax OK
[root@web_server ~]# systemctl restart httpd
[root@web_server ~]# 
[root@web_server ~]# 
[root@web_server ~]# netstat -antp | grep http
tcp6       0      0 :::80                   :::*                    LISTEN      1658/httpd          
tcp6       0      0 :::443                  :::*                    LISTEN      1658/httpd          
```



##### 9、测试访问

```
https://www.linux.com/
```



### 七、实现https的自动跳转 

```
1 RewriteEngine On
2 RewriteCond %{HTTP_HOST} private.linux.com [NC]
3 RewriteRule ^/(.*) https://private.linux.com/$1 [L]
4
5 %{HTTP_HOST}: 调用客户端访问的主机名
7 [NC]: 忽略大小写
8 [L]: 改写完立即响应
9 $1: 正则反向引用
```




## SSH远程连接服务

### 一、SSH协议 

​		TCP/22

​		SSH	应用层协议

​		作用：远程连接设备， 方便操作 



#### 服务器管理方式: 

​		1、本地管理方式 

​				安装系统、故障修复

​		2、远程连接的方式 



### 二、SSH服务架构 

#### 1、服务端  

```
开启SSH服务 

[root@localhost ~]# ps -elf | grep ssh
4 S root       1086      1  0  80   0 - 26504 poll_s 17:10 ?        00:00:00 /usr/sbin/sshd -D
4 S root       2630   1086  1  80   0 - 36951 -      17:33 ?        00:00:00 sshd: root@pts/0

[root@localhost ~]# netstat -antp | grep ssh
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1086/sshd   

提供SSH服务的软件  
[root@localhost ~]# rpm -qf /usr/sbin/sshd
openssh-server-7.4p1-11.el7.x86_64
```



#### 2、客户端

```
windows: 
	XManager/Xshell,  SecureCRT,  Putty 
	
Linux: 
	openssh-clients软件
	ssh命令 
```





### 三、SSH客户端工具使用

#### 1、远程连接服务器 

```
# ssh  用户名@服务器IP 

[root@node01 ~]# ssh root@192.168.183.10
```



#### 2、远程执行命令 

```
# ssh 用户名@服务器IP 命令 

[root@node01 ~]# ssh root@192.168.183.10 hostname 
root@192.168.183.10's password: 
node02.linux.com

[root@node01 ~]# ssh root@192.168.183.10 free -m
root@192.168.183.10's password: 
              total        used        free      shared  buff/cache   available
Mem:            976          93         759           6         123         737
Swap:          2047           0        2047
[root@node01 ~]# 
```



#### 3、远程拷贝文件

```
scp 远程拷贝工具 

# scp 源文件  用户名@服务器IP:目录

[root@node01 ~]# scp /opt/file01 root@192.168.183.10:/tmp 
root@192.168.183.10's password: 
file01  

[root@node01 ~]# scp -r /opt/linux/ root@192.168.183.10:/tmp/
root@192.168.183.10's password: 

[root@node01 ~]# scp root@192.168.183.10:/etc/fstab  /tmp/
```



```
rsync    远程拷贝工具 
	所有服务器均要安装rsync 
	增量拷贝工具
	
[root@node01 ~]# rsync -av /opt/shell/  root@192.168.183.10:/tmp/

[root@node01 ~]# rsync -av /opt/shell/ root@192.168.183.10:/tmp/

[root@node01 ~]# rsync -av /opt/shell root@192.168.183.10:/tmp/
```





### 四、ssh服务的认证方式  

```
认证方式: 
	1、基于用户名、密码的认证 
	2、基于密钥的认证/免密SSH 
		a) 在客户端生成密钥对
		b) 将公钥拷贝给服务器, 服务器会将公钥信息保存到对应用户家目录/.ssh/authorized_keys文件中
```



##### 案例： 配置基于密钥的认证 

```
1、在客户端生成密钥对 
[root@node01 ~]# ssh-keygen -t rsa 
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:4jxg1I91tJbPmeD8M0/uv/+OTNcxH9n/WRABxU/4Tn0 root@node01.linux.com
The key's randomart image is:
+---[RSA 2048]----+
|          . .+o. |
|     .   . o  o..|
|    . . . *   .+.|
|   .   + = + o .E|
|    o o S o = .Bo|
|   . + .   .   .O|
|      +     + o *|
|       .     O o+|
|             .*=X|
+----[SHA256]-----+

[root@node01 ~]# ls /root/.ssh/
id_rsa  id_rsa.pub 

2、将公钥拷贝到服务器 

[root@node01 ~]# ssh-copy-id root@192.168.183.10

在对方服务器验证存在正确的保存公钥信息的文件 
[root@node02 ~]# ls /root/.ssh/
authorized_keys



注意: 

1、密钥的认证是基于用户实现的 
[root@node01 ~]# ssh-copy-id martin@192.168.183.10

2、密钥的认证是单向的 
```



### 五、ssh配置文件 ----  /etc/ssh/sshd_config 

#### 1、修改默认端口 

```
[root@node01 ~]# vim /etc/ssh/sshd_config 

Port 55555

[root@node01 ~]# systemctl restart sshd
[root@node01 ~]# 
[root@node01 ~]# netstat -antp | grep ssh
tcp        0      0 127.0.0.1:6010          0.0.0.0:*               LISTEN      2930/sshd: root@pts 
tcp        0      0 0.0.0.0:55555           0.0.0.0:*               LISTEN      5638/sshd    

[root@node02 ~]# ssh root@192.168.183.200 -p 55555

[root@node02 ~]# scp -P 55555 /etc/fstab root@192.168.183.200:/tmp/
```



#### 2、禁止root用户登录 

```
PermitRootLogin no
```



#### 3、禁用密码认证 

```
PasswordAuthentication no
```



#### 4、禁用主机名解析，增加SSH连接速度  

```
UseDNS no
```











### 关闭防火墙

```
[root@node01 ~]# systemctl stop firewalld
[root@node01 ~]# systemctl disable firewalld
Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.
Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.
[root@node01 ~]# systemctl mask firewalld
```



### 关闭SELinux

```
[root@node01 ~]# getenforce 
Enforcing
[root@node01 ~]# setenforce 0
[root@node01 ~]# getenforce 
Permissive
[root@node01 ~]# vim /etc/sysconfig/selinux 

SELINUX=disabled
```










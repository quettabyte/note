## PXE服务

### 一、PXE服务介绍

​		作用: 实现批量安装部署Linux系统 



### 二、PXE服务相关组件

#### 1、DHCP服务器 

​		向新服务器分配IP地址、告知新服务器TFTP的地址 



#### 2、文件共享服务 

​		支持ftp, nfs, http

​		提供系统安装源



#### 3、TFTP服务

​		提供菜单 

​		提供对应系统的内核vmlinuz, 系统初始化镜像文件initrd.img 



#### 4、pxelinux.0

​		让PXE服务器可正常接收新服务器启动安装系统的请求





### 三、配置PXE服务提供centos 7的安装源 

#### 1、扩展根分区容量  

```
[root@pxe ~]# pvcreate /dev/sdb

[root@pxe ~]# vgextend centos /dev/sdb

[root@pxe ~]# lvextend -L +40G /dev/centos/root 

[root@pxe ~]# xfs_growfs /dev/centos/root

[root@pxe ~]# df -hT | grep "root"
/dev/mapper/centos-root xfs        58G  1.1G   57G    2% /
```



#### 2、安装pxe需要的软件 

```
[root@pxe ~]# yum install -y dhcp vsftpd tftp-server xinetd syslinux 
```



#### 3、配置FTP服务，共享系统安装文件 

```
[root@pxe ~]# mount /dev/sr0 /mnt 
[root@pxe ~]# mkdir /var/ftp/centos74
[root@pxe ~]# cp -ra /mnt/* /var/ftp/centos74/ 

[root@pxe ~]# systemctl start vsftpd
[root@pxe ~]# systemctl enable vsftpd
Created symlink from /etc/systemd/system/multi-user.target.wants/vsftpd.service to /usr/lib/systemd/system/vsftpd.service.
[root@pxe ~]# 
[root@pxe ~]# netstat -antp | grep ftp
tcp6       0      0 :::21                   :::*                    LISTEN      1500/vsftpd       
```



#### 4、配置TFTP服务 

##### 1) 共享内核、初始化镜像文件、菜单相关文件 

```
[root@pxe ~]# cp /mnt/isolinux/*   /var/lib/tftpboot/
```



##### 2) 共享pxelinux.0文件

```
[root@pxe ~]# cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/
```



##### 3) 编辑菜单文件

```
[root@pxe ~]# mkdir /var/lib/tftpboot/pxelinux.cfg
[root@pxe ~]# cp /var/lib/tftpboot/isolinux.cfg  /var/lib/tftpboot/pxelinux.cfg/default

[root@pxe ~]# vim /var/lib/tftpboot/pxelinux.cfg/default 

label centos74
  menu label Install CentOS74
  kernel vmlinuz			//以相对路径【相对于tftp的数据目录】方式指定对应菜单项的内核
  append initrd=initrd.img inst.stage2=ftp://192.168.183.10/centos74 inst.repo=ftp://192.168.183.10/centos74
  
  	initrd=	系统初始化镜像文件，相对路径  
  	inst.stage2=	指定系统安装文件的存储位置
  	inst.repo=		指定软件安装包的存储位置
```



##### 4) 启动tftp服务 

```
[root@pxe ~]# vim /etc/xinetd.d/tftp 

​        disable                 = no

[root@pxe ~]# systemctl restart xinetd
[root@pxe ~]# systemctl enable xinetd
[root@pxe ~]# 
[root@pxe ~]# netstat -anup | grep 69
udp        0      0 0.0.0.0:69              0.0.0.0:*                           1764/xinetd       
```



#### 5、 配置DHCP服务 

```
[root@pxe ~]# cp /usr/share/doc/dhcp-4.2.5/dhcpd.conf.example /etc/dhcp/dhcpd.conf 
cp: overwrite ‘/etc/dhcp/dhcpd.conf’? yes

[root@pxe ~]# vim /etc/dhcp/dhcpd.conf

subnet 192.168.183.0 netmask 255.255.255.0 {
  range 192.168.183.100 192.168.183.200;
  next-server 192.168.183.10;		//指定tftp服务器地址
  filename "pxelinux.0";			//指定tftp服务器共享的pxelinux.0文件名称
} 



[root@pxe ~]# systemctl start dhcpd
[root@pxe ~]# systemctl enable dhcpd

[root@pxe ~]# netstat -anup | grep dhcp
udp        0      0 0.0.0.0:67              0.0.0.0:*                           1839/dhcpd          
[root@pxe ~]# 
```



#### 6、测试pxe工作正常

```
测试centos 7系统安装时，需要2G内存
```





### 四、配置添加centos 6安装源 

#### 1、配置ftp服务，共享centos 6的安装文件 

```
替换centos 6安装光盘

[root@pxe ~]# mkdir /var/ftp/centos66
[root@pxe ~]# cp -ra /mnt/* /var/ftp/centos66
```



#### 2、配置tftp服务，共享centos 6的内核、初始化镜像 

```
[root@pxe ~]# mkdir /var/lib/tftpboot/centos66
[root@pxe ~]# cp /mnt/isolinux/vmlinuz /mnt/isolinux/initrd.img /var/lib/tftpboot/centos66/
[root@pxe ~]# ls /var/lib/tftpboot/centos66/
initrd.img  vmlinuz
```



#### 3、编辑菜单文件，添加centos 6安装选项 

```
[root@pxe ~]# vim /var/lib/tftpboot/pxelinux.cfg/default 
label centos66
  menu label Install CentOS66
  kernel centos66/vmlinuz
  append initrd=centos66/initrd.img 
```



#### 4、测试





### 五、配置kickstart文件实现系统自动安装  

```
kickstart文件， 简称ks文件， 自动应答文件 
作用: 实现系统的自动安装
```

```
kickstart文件格式: 

一、常规配置 
 设置语言、时区
 设置root密码
 磁盘分区
 网卡
 创建普通用户
 
二、安装软件  
%packages
软件名称
软件名称
软件名称
@软件组名称
%end

三、系统安装完毕后自动执行的操作
%post
操作命令
操作命令
操作命令
%end
```



```
获取kickstart文件的方法：
1、anaconda-ks.cfg
2、system-config-kickstart图形化工具
	最小化系统需要安装x11图形转发工具  # yum install -y *x11* 
```



#### 案例: 生成ks文件，实现centos 7系统的自动安装 

##### 1、生成kickstart文件 

```
[root@pxe ~]# cat centos7.cfg 
#platform=x86, AMD64, or Intel EM64T
#version=DEVEL

# Install OS instead of upgrade

install

# Keyboard layouts

keyboard 'us'

# Root password

rootpw --iscrypted $1$jAM4TprN$Ojp2WkNYOv./25jS8BU.M.

# System language

lang en_US

# System authorization information

auth  --useshadow  --passalgo=sha512

# Use text mode install

text
firstboot --disable

# SELinux configuration

selinux --disabled

# Firewall configuration

firewall --disabled

# Network information

network  --bootproto=dhcp --device=ens33

# Reboot after installation

reboot

# System timezone

timezone Asia/Shanghai

# Use network installation

url --url="ftp://192.168.183.10/centos74"

# System bootloader configuration

bootloader --location=mbr

# Clear the Master Boot Record

zerombr

# Partition clearing information

clearpart --all --initlabel

# Disk partitioning information

part /boot --fstype="xfs" --size=500
part swap --fstype="swap" --size=2048
part / --fstype="xfs" --grow --size=1

%packages
@core
vim-enhanced
net-tools
bash-completion
ntpdate
rsync
wget
lftp
psmisc
%end
```



#### 2、借助FTP服务，共享ks文件 

```
[root@pxe ~]# cp centos7.cfg /var/ftp/
```



#### 3、编辑菜单文件

```
[root@pxe ~]# vim /var/lib/tftpboot/pxelinux.cfg/default 

label centos74
  menu label Install CentOS74
  kernel vmlinuz
  append initrd=initrd.img inst.stage2=ftp://192.168.183.10/centos74 inst.repo=ftp://192.168.183.10/centos74 ks=ftp://192.168.183.10/centos7.cfg
```



#### 4、测试系统自动安装





### centos 6 ks文件参考：

```
[root@pxe ~]# cat centos6.cfg 
#platform=x86, AMD64, or Intel EM64T
#version=DEVEL

# Install OS instead of upgrade

install

# Keyboard layouts

keyboard 'us'

# Root password

rootpw --iscrypted $1$jAM4TprN$Ojp2WkNYOv./25jS8BU.M.

# System language

lang en_US

# System authorization information

auth  --useshadow  --passalgo=sha512

# Use text mode install

text
firstboot --disable

# SELinux configuration

selinux --disabled


# Firewall configuration

firewall --disabled

# Network information

network  --bootproto=dhcp --device=eth0

# Reboot after installation

reboot

# System timezone

timezone Asia/Shanghai

# Use network installation

url --url="ftp://192.168.183.10/centos66"

# System bootloader configuration

bootloader --location=mbr

# Clear the Master Boot Record

zerombr

# Partition clearing information

clearpart --all --initlabel

# Disk partitioning information

part /boot --fstype="ext4" --size=500
part swap --fstype="swap" --size=2048
part / --fstype="ext4" --grow --size=1


%packages
@core
vim-enhanced
net-tools
ntpdate
rsync
wget
lftp
psmisc
%end

%post
mkdir /etc/yum.repos.d/backup
mv /etc/yum.repos.d/C* /etc/yum.repos.d/backup
%end
```
































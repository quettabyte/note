## cookie、session

### 一、cookie 

​		作用:  识别客户端的身份 

​		由服务器生成,   保存到客户端浏览器   



#### cookie相关操作方法

##### 1、设置cookie

```
http响应对象.set_cookie("key", "value")
```



##### 2、获取cookie

```
request.COOKIES 
```



##### 示例: 基于cookie识别客户端身份

app04/views.py

```
from django.shortcuts import render, redirect
from django.http import HttpResponse

# Create your views here.

def login(request):
    if request.method == "GET":
        return render(request, "app04/login.html")
    elif request.method == "POST":
        username = request.POST.get("username")
        password = request.POST.get("password")
        if username == "martin" and password == "redhat":
            from utils import genCOOKIE as gc
            token = gc.genCookie()
            result = redirect("/app04/show/")
            # 在响应数据中添加cookie
            result.set_cookie("user_token", token)
            return result

def show(request):
    # 判断请示中是否包含cookie
    user_token = request.COOKIES.get("user_token")
    if user_token:
        return HttpResponse("服务器列表")
    else:
        return redirect("/app04/login/")
```



template/app04/login.html

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户登录</title>
</head>
<body>

    <h3>用户登录</h3>

    <form action="/app04/login/" method="post">
        {% csrf_token %}
        <span>用户名: </span>
        <input type="text" name="username"/>
        <span>密码: </span>
        <input type="password" name="password" />
        <input type="submit" value="登录" />
    </form>
</body>
</html>
```



utils/genCOOKIES.py

```
import string
import random

all_char = string.ascii_letters + string.digits


def genCookie():
    data = ""
    for i in range(40):
        data += random.choice(all_char)
    return data

if __name__ == '__main__':
    print(genCookie())
```





### 二、set_cookie( )设置cookie参数 

#### 1、max_age       设置cookie超时时间, 单位秒 



#### 2、expires		设置cookie超时时间, 单位datetime

```
import datetime
current_time = datetime.datetime.utcnow()
stop_time = current_time + datetime.timedelta(seconds=5)
result.set_cookie("user_token", token, expires=stop_time)
```

​			

#### 3、path="/"

​		设置cookie生效范围，path="/"表示整个项目范围生效 



#### 4、domain=None

​		设置cookie生效范围    domain="linux.com"

### 5、secure=False	

​		True表示针对https协议传输
​	

#### 6、httponly=False 

​		获取该cookie值只允许通过http协议获取，不允许通过其他的方式，例如（js, jquery）





### 三、设置加密cookie

	http响应对象.set_signed_cookie(key, val, salt="....")
	
	request.get_signed_cookie(key="", salt="....")




## session

### 一、session工作机制

​	作用: 识别客户端登录身份 

​	由服务器生成, 存储在服务器端  



Django实现session: 

​		借助request.session

注意:    django默认使用数据库保存会话信息 

		>    python managey.py makemigrations
		>    python manage.py migrate 



```
# 用户登录
def login(request):
    if request.method == 'GET':
        return render(request, "app04/login.html")
    elif request.method == "POST":
        user = request.POST.get("user")
        pwd = request.POST.get("pwd")
        if user == "martin" and pwd == "redhat":
            # 生成session  key: 客户端地址， value: login
            client_ip = request.META.get("REMOTE_ADDR")
            request.session[client_ip] = "login"
            return redirect("/app04/ok/")


def ok(request):
    # 在session中检测是否存在客户端登录信息
    client_ip = request.META.get("REMOTE_ADDR")
    data = request.session.get(client_ip)
    if data:
        return HttpResponse("登录成功后的界面")
    else:
        return redirect("/app04/login/")
```



### 二、session相关参数

settings.py 

		SESSION_COOKIE_NAME="sessionid"
		SESSION_COOKIE_PATH="/"
		SESSION_COOKIE_DOMAIN=None
		SESSION_COOKIE_SECURE=False     //通过https协议进行传输
		SESSION_COOKIE_HTTPONLY=False   //session只允许通过http/https的方式获取，不允许其他的方式(js, jquery)
		SESSION_COOKIE_AGE=1209600	   //设置session超时时间，单位秒，14天
		SESSION_EXPIRE_AT_BROWSER_CLOSE=False   // 设置为True表示客户端关闭浏览器时，会话过期 
		SESSION_SAVE_EVERY_REQUEST=False	   //  设置为True表示用户每次发送请求时重新计算超时时间































































## Model模型——多表操作

### 一、数据关系

```
一对多关系 
多对多关系 

核心: 外键 Foreign key
```



### 二、创建一对多关系

```
# 部门表
class Depart(models.Model):
    name = models.CharField(max_length=20)


# 用户信息表
class User(models.Model):
    name = models.CharField(max_length=20)
    email = models.CharField(max_length=20)
    phone = models.CharField(max_length=30)
    # to='表名', to_field="字段名称"
    # on_delete=    级联删除关系，确保数据完整性
    depart = models.ForeignKey(to="Depart", to_field="id", on_delete=models.CASCADE)
```



### 三、基于外键字段实现查询

#### 1、查询lz所属部门信息

```
def test1(request):
    user_obj = models.User.objects.filter(name="lz")[0]
    print(user_obj)
    print(user_obj.name, user_obj.email, user_obj.phone)
    # 通过外键可获取到对应的部门数据对象
    print(user_obj.depart)
    print(user_obj.depart.name)
    return HttpResponse("查询lz所属的部门")
```

#### 2、获取所有人员信息

```
def test2(request):
    users = models.User.objects.all()
    # print(users)
    for user_obj in users:
        print('姓名: %s, 邮箱: %s, 电话: %s, 部门名称: %s' % (user_obj.name, user_obj.email, user_obj.phone, user_obj.depart.name))
    return HttpResponse("获取所有运维人员信息")
```

#### 3、在前端页面展示数据

```
# 前端页面展示数据
def test3(request):
    users = models.User.objects.all()
    return render(request, "app02/test3.html", {"users": users})
```

##### templates/app02/test3.html

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

    <h3>运维人员信息</h3>

    <h4>{{ users }}</h4>

    <table border="1px">
        <tr>
            <td>编号</td>
            <td>姓名</td>
            <td>邮箱</td>
            <td>电话</td>
            <td>部门</td>
        </tr>

        {% for user_obj in users %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ user_obj.name }}</td>
                <td>{{ user_obj.email }}</td>
                <td>{{ user_obj.phone }}</td>
                <td>{{ user_obj.depart.name }}</td>
            </tr>
        {% endfor %}
    </table>

</body>
</html>
```



### 四、基于related_name实现查询

```

# 用户信息表
class User(models.Model):
    name = models.CharField(max_length=20)
    email = models.CharField(max_length=20)
    phone = models.CharField(max_length=30)
    # to='表名', to_field="字段名称"
    # on_delete=    级联删除关系，确保数据完整性
    depart = models.ForeignKey(to="Depart", to_field="id", on_delete=models.CASCADE, related_name="depart_to_user")
```

```
> python manage.py makemigrations
> python manage.py migrate
```

#### 1、查询运维部对应的人员信息

```
# 查询运维部所有人员
def test4(request):
    depart_obj = models.Depart.objects.filter(name="运维部")[0]
    print(depart_obj)
    print("部门名称: %s" % depart_obj.name)
    # 通过relate_name获取对应的人员数据对象
    print(depart_obj.depart_to_user.all())
    for user_obj in depart_obj.depart_to_user.all():
        print("姓名: %s, 邮箱；%s, 电话: %s" % (user_obj.name, user_obj.email, user_obj.phone))
    return HttpResponse('查询运维部所有人员')
```

#### 2、在前端页面展示数据

```
def test5(request):
    departs = models.Depart.objects.all()
    return render(request, "app02/test5.html", {"departs":departs})
```

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <h2>运维 人员表</h2>

    <h3>{{ departs }}</h3>

    {% for depart_obj in departs %}
        <h4>部门名称: {{ depart_obj.name }}</h4>
        {% for user_obj in depart_obj.depart_to_user.all %}
            <ul>
                <li>姓名: {{ user_obj.name }}</li>
                <li>邮箱: {{ user_obj.email }}</li>
                <li>电话: {{ user_obj.phone }}</li>
            </ul>
        {% endfor %}
    {% endfor %}
</body>
</html>
```



### 五、按字段查询数据

```
外键字段__部门表中的数据
relate_name__用户表中的数据
```

```
# 基于values(), values_list()按字段查询
def test6(request):
    # 外键字段名称__对应表中的数据
    data_01 = models.User.objects.values_list("name", "email", "phone", "depart__name").filter(name="jerry")
    print(data_01)

    data_02 = models.Depart.objects.values("name", "depart_to_user__name", "depart_to_user__email").filter(name="运维部")
    print(data_02)
    return HttpResponse("基于values(), values_list()按字段查询")
```



### 六、数据修改操作

#### 1、添加数据

```
注意:
	通过外键字段建立数据关系时，需要使用对应的数据对象

def test7(request):
    depar_obj = models.Depart.objects.filter(name="优化部")[0]
    models.User.objects.create(name="Harry", email="harry@qq.com", phone="123214213", depart=depar_obj)
    return HttpResponse(" 添加数据")
```



#### 2、更新数据

```
# 更新数据
def test8(request):
    depart_obj = models.Depart.objects.filter(name="运维部")[0]
    models.User.objects.filter(name="lz").update( =depart_obj)
    return HttpResponse("更新数据")
```



#### 3、删除数据 

```
# 删除数据
def test9(request):
    models.Depart.objects.filter(name="系统部").delete()
    return HttpResponse("删除数据")
```





## 多对多关系数据管理

### 一、多对多数据关系的建立

```
基于第三张关系表进行实现
本质上依靠外键，保证数据完整性
```

```
Django的两种方式:

	1、ManyToManyField()
	2、手动创建关系表	【推荐】
```



### 二、创建多对多关系 

##### app03/models.py

```
from django.db import models

# Create your models here.

# 作者表
class Author(models.Model):
    name = models.CharField(max_length=10)
    city = models.CharField(max_length=10)


# 书籍表
class Book(models.Model):
    name = models.CharField(max_length=100)
    pub_date = models.CharField(max_length=10)
    # 创建数据多对多关系 , through=   使用哪个表维护关系
    book_to_author = models.ManyToManyField(to="Author", through="Relation")

# 关系表
class Relation(models.Model):
    book = models.ForeignKey(to="Book", to_field="id", on_delete=models.CASCADE)
    auth = models.ForeignKey(to="Author", to_field="id", on_delete=models.CASCADE)

```

```
> python manage.py makemigrations
> python manage.py migrate 
```



### 三、查询数据

#### 1、查询《python自动化运维》对应的作者关系 

```
根据关系表中的外键__引用对应数据表中的数据，返回关系数据对象

关系数据对象.外键.对应数据
```

```
# 查询《python自动化运维》作者
def test1(request):
    datas = models.Relation.objects.filter(book__name="python自动化运维").select_related()
    print(datas)
    print(datas[0].auth.name)
    for obj in datas:
        print(obj.auth.name, obj.auth.city)
    return HttpResponse("查询《python自动化运维》作者")
```



#### 2、查询李四对应的书籍信息

```
def test2(request):
    datas = models.Relation.objects.filter(auth__name="李四").select_related()
    print(datas)
    for obj in datas:
        print(obj.book.name)
    return HttpResponse("查询李四的书籍")
```

```
# 查询李四对应的书籍信息
def test2(request):
    datas = models.Relation.objects.filter(auth__name="李四").select_related()
    return render(request, "app03/test2.html", {"datas": datas})
```

```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

    <h1>展示数据</h1>

    <h2>{{ datas }}</h2>

    <h3>作者姓名: {{ datas.1.auth.name }}</h3>

    <ul>
        {% for obj in datas %}
            <li>书籍名称: {{ obj.book.name }}&nbsp;&nbsp;出版日期: {{ obj.book.pub_date}}</li>
        {% endfor %}
    </ul>


</body>
</html>
```



### 四、添加数据

```
# 添加数据
def test3(request):
    models.Book.objects.create(name="golang编程语言", pub_date="2020-06-09")
    # 获取书籍数据对象
    book_obj = models.Book.objects.filter(name="golang编程语言")[0]
    # 获取作者对象
    authors = models.Author.objects.filter(name__in=["张三","王五"])
    # 创建数据关系
    for auth_obj in authors:
        models.Relation.objects.create(book=book_obj, auth=auth_obj)
    return HttpResponse("添加数据")
```





### 五、数据库管理工具 

#### 1、访问地址

```
http://127.0.0.1:8000/admin 
```



#### 2、创建登录用户

```
python manage.py createsuperuser  
```



#### 3、注册自己的表

##### app03/admin.py 

```
from django.contrib import admin
from app03 import models

# Register your models here.

admin.site.register(models.Book)
admin.site.register(models.Author)
```




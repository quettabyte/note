## zabbix API实现监控自动化

### 一、zabbix API介绍

#### 1、作用

```
Zabbix API允许你以编程方式检索和修改Zabbix的配置，并提供对历史数据的访问。它广泛用于：

    1、创建新的应用程序以使用Zabbix；
    2、将Zabbix与第三方软件集成；
    3、自动执行常规任务。
```



#### 2、核心要素

##### 1) 调用地址

```
api_jsonrpc.php

http://IP:port/zabbix/api_jsonrpc.php
```

##### 2）调用方式 

```
以http协议发送POST请求

借助requests模块， 三方模块 
```

##### 3) 数据格式 

```
客户端和API之间的请求和响应使用JSON格式进行编码

JSON：
	数据格式
	以key-value的方式存储数据
```

##### 4) 设置Content-Type首部的值

```
application/json-rpc
application/json
application/jsonrequest
```



#### 3、requests模块

```
作用: 发送HTTP请求 

三方模块

(project1207_venv) D:\>pip install requests

(project1207_venv) D:\>python
Python 3.8.6 (tags/v3.8.6:db45529, Sep 23 2020, 15:52:53) [MSC v.1927 64 bit (AMD64)] on win32
Type "help", "copyright", "credits" or "license" for more information.
>>>
>>> import requests
>>> exit()

```

##### 1) 发送GET请求

```
import requests

res = requests.get(url="http://www.baidu.com")
print(res)
print(res.text)
```

```
import requests

head = { "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:88.0) Gecko/20100101 Firefox/88.0" }
res = requests.get(url="http://www.baidu.com", headers=head)
print(res)
print(res.text)
```

##### 2) 发送POST请求

```
import requests

head = { "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:88.0) Gecko/20100101 Firefox/88.0" }
data = { "username":"martin", "password":"redhat" }

res = requests.post(url="http://www.baidu.com", data=data, headers=head)
print(res)
print(res.text)
```



#### 4、json模块

```
作用：处理json格式的数据
```

##### 1) json ---->  字典		json.loads()

```
>>> import json
>>> data_01 = '{"name":"martin", "pwd":"123"}'
>>> type(data_01)
<class 'str'>

>>> new_data_01 = json.loads(data_01)
>>> type(new_data_01)
<class 'dict'>

>>> new_data_01.get("pwd")
'123'
```

##### 2) 字典 ----> json

```
>>> import json
>>>
>>> data_02 = { "name":"martin", "pwd":"123" }
>>> type(data_02)
<class 'dict'>
>>>
>>>
>>> new_data_02 = json.dumps(data_02)
>>>
>>> type(new_data_02)
<class 'str'>
```



### 案例: 创建监控项

```
import requests
import json
import sys

zabbix_url = "http://10.10.11.100:8000/zabbix/api_jsonrpc.php"
zabbix_user = "Admin"
zabbix_pwd = "zabbix"


# 用户登录，获取令牌
def getUserToken():
    data = {
        "jsonrpc": "2.0",
        "method": "user.login",
        "params": {
            "user": zabbix_user,
            "password": zabbix_pwd
        },
        "id": 1
    }
    head = { "Content-Type": "application/json" }
    res = requests.post(url=zabbix_url, data=json.dumps(data), headers=head)
    user_token = json.loads(res.text).get("result")
    return user_token

# 获取主机ID、接口ID
def getHostID():
    user_token = getUserToken()
    data = {
        "jsonrpc": "2.0",
        "method": "host.get",
        "params": {
            "output": [
                "hostid",
                "host"
            ],
            "selectInterfaces": [
                "interfaceid",
                "ip"
            ]
        },
        "id": 2,
        "auth": user_token
    }
    head = { "Content-Type":"application/json" }
    res = requests.post(url=zabbix_url, data=json.dumps(data), headers=head)
    host_id = json.loads(res.text).get("result")[0].get("hostid")
    interface_id = json.loads(res.text).get("result")[0].get("interfaces")[0].get("interfaceid")
    return host_id, interface_id

# 添加监控项
def itemCreate(disk):
    user_token = getUserToken()
    host_id, interface_id = getHostID()
    data = {
        "jsonrpc": "2.0",
        "method": "item.create",
        "params": {
            "name": "Free disk space on $1",
            "key_": "vfs.fs.size[%s,free]" % disk,
            "hostid": host_id,
            "type": 0,
            "value_type": 3,
            "interfaceid": interface_id,
            "delay": 30
        },
        "auth": user_token,
        "id": 3
    }
    head = {"Content-Type":"application/json"}
    res = requests.post(url=zabbix_url, data=json.dumps(data), headers=head)
    if "error" in res.text:
        print("磁盘%s剩余空间监控失败!!!" % disk)
    else:
        print("磁盘%s剩余空间监控成功!!!" % disk)


if __name__ == '__main__':
    disk = input("磁盘名称: ").strip()
    itemCreate(disk=disk)
```



#### 案例: 自动监控主机 

```
import requests
import json
import sys

class HostCreateByZabbix():
    def __init__(self, zabbix_url, zabbix_user, zabbix_pwd):
        self.zabbix_url = zabbix_url
        self.zabbix_user = zabbix_user
        self.zabbix_pwd = zabbix_pwd

    # 发送POST请求， 将响应转成字典
    def sendPost(self, data):
        head = { "Content-Type":"application/json" }
        try:
            res = requests.post(url=self.zabbix_url, data=json.dumps(data), headers=head)
        except Exception as e:
            print("请求发送失败!!!")
            print(e)
            sys.exit()
        return json.loads(res.text)

    # 用户登录，获取令牌
    def __getUserToken(self):
        data = {
            "jsonrpc": "2.0",
            "method": "user.login",
            "params": {
                "user": self.zabbix_user,
                "password": self.zabbix_pwd
            },
            "id": 1
        }
        content = self.sendPost(data=data)
        user_token = content.get("result")
        return user_token

    # 获取模板Template OS Linux ID
    def getTemplateID(self):
        user_token = self.__getUserToken()
        data = {
            "jsonrpc": "2.0",
            "method": "template.get",
            "params": {
                "output": "extend",
                "filter": {
                    "host": [
                        "Template OS Linux",
                    ]
                }
            },
            "auth": user_token,
            "id": 1
        }
        content = self.sendPost(data=data)
        template_id = content.get("result")[0].get("templateid")
        return template_id

    # 获取主机组ID, 如果不存在，则创建
    def getHostGroupID(self, group_name):
        #{"主机组名":"组ID“}
        groups = {}
        user_token = self.__getUserToken()
        data = {
            "jsonrpc": "2.0",
            "method": "hostgroup.get",
            "params": {
                "output": "extend",
            },
            "auth": user_token,
            "id": 1
        }
        # 获取所有主机组名、组ID
        content = self.sendPost(data=data)
        for group_info in content.get("result"):
            groups[group_info.get("name")] = group_info.get("groupid")
        # 判断主机组存在
        if group_name in groups.keys():
            group_id = groups.get(group_name)
        else:
            create_group_data = {
                "jsonrpc": "2.0",
                "method": "hostgroup.create",
                "params": {
                    "name": group_name
                },
                "auth": user_token,
                "id": 1
            }
            content = self.sendPost(data=create_group_data)
            group_id = content.get("result").get("groupids")[0]
        return group_id

    # 创建监控主机
    def hostCreate(self, hostname, hostip, hostgroup):
        user_token = self.__getUserToken()
        template_id = self.getTemplateID()
        host_group_id = self.getHostGroupID(group_name=hostgroup)
        data = {
            "jsonrpc": "2.0",
            "method": "host.create",
            "params": {
                "host": hostname,
                "interfaces": [
                    {
                        "type": 1,
                        "main": 1,
                        "useip": 1,
                        "ip": hostip,
                        "dns": "",
                        "port": "10050"
                    }
                ],
                "groups": [
                    {
                        "groupid": host_group_id
                    }
                ],
                "templates": [
                    {
                        "templateid": template_id
                    }
                ],
            },
            "auth": user_token,
            "id": 1
        }
        content = self.sendPost(data=data)
        if "error" in content:
            print("服务器%s监控失败!!!!" % hostname)
        else:
            print("服务器%s监控成功!!!!" % hostname)

if __name__ == '__main__':
    hostname = input("被监控服务器名称: ").strip()
    hostip = input("被监控服务器地址: ").strip()
    hostgroup = input("主机组名称: ").strip()
    p1 = HostCreateByZabbix(zabbix_url="http://10.10.11.100:8000/zabbix/api_jsonrpc.php", zabbix_user="Admin", zabbix_pwd="zabbix")
    p1.hostCreate(hostname=hostname, hostip=hostip, hostgroup=hostgroup)
```


























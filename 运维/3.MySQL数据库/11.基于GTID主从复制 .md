## 基于GTID的主从复制 

### 一、GTID介绍

```
MySQL 5.6版本支持的新特性 

GTID    Global Transaction Identified
全局事务ID  

GTID构成: 
	server_uuid + 事务ID
```



### 二、基于GTID的主从复制 

```
环境描述: 
	192.168.183.10		Master服务器
	192.168.183.11		Slave服务器 
```



#### 1、在服务器安装MySQL 5.7 

```
[root@master ~]# yum install -y mysql-community-server
```



#### 2、编辑配置文件，启用gtid特性 

```
[root@master ~]# vim /etc/my.cnf
[mysqld]
server_id=10
log_bin=master
gtid_mode=on						//启用gtid
enforce_gtid_consistency=true		//强制gtid一致性

[root@master ~]# systemctl start mysqld
[root@master ~]# systemctl enable mysqld

[root@master ~]# grep -i "password" /var/log/mysqld.log 
2021-01-25T01:24:19.423169Z 1 [Note] A temporary password is generated for root@localhost: tdEi(0fpD/<:

[root@master ~]# mysqladmin -uroot -p password "WWW.1.com"
Enter password:
```



#### 3、导入jiaowu数据库，模拟数据  

```
[root@master ~]# mysql -uroot -pWWW.1.com < jiaowu.sql 

[root@master ~]# mysqldump -uroot -pWWW.1.com --lock-all-tables --master-data=2 --set-gtid-purged=OFF --all-databases > /tmp/data.sql
[root@master ~]# rsync -av /tmp/data.sql root@192.168.183.11:/tmp/
```



#### 4、在Master服务器创建远程用户

```
mysql> grant replication slave on *.* to 'repluser'@'192.168.183.11' identified by 'WWW.1.com';
Query OK, 0 rows affected, 1 warning (0.01 sec)

mysql> flush privileges;
Query OK, 0 rows affected (0.00 sec)

mysql> exit
Bye
```



#### 5、编辑slave服务器配置文件， 启动数据库服务  

```
[root@slave ~]# vim /etc/my.cnf
[mysqld]
server_id=11
log_bin=slave
gtid_mode=on
enforce_gtid_consistency=true

[root@slave ~]# systemctl start mysqld
[root@slave ~]# systemctl enable mysqld

[root@slave ~]# grep -i "password" /var/log/mysqld.log 
2021-01-25T01:33:16.285269Z 1 [Note] A temporary password is generated for root@localhost: KE:Y5o<Nkvhw

[root@slave ~]# mysqladmin -uroot -p password "WWW.1.com"
Enter password: 
```



#### 6、在slave服务器上恢复主服务器数据

```
[root@slave ~]# mysql -uroot -pWWW.1.com < /tmp/data.sql 
```



#### 7、连接Master服务器

```
mysql> change master to
    -> master_host="192.168.183.10",
    -> master_user="repluser",
    -> master_password="WWW.1.com",
    -> master_auto_position=1;
Query OK, 0 rows affected, 2 warnings (0.01 sec)

mysql> start slave;
Query OK, 0 rows affected (0.00 sec)
```



#### 8、查看复制线程状态 

```
 mysql> show slave status\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 192.168.183.10
                  Master_User: repluser
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: master.000002
          Read_Master_Log_Pos: 6904
               Relay_Log_File: slave-relay-bin.000005
                Relay_Log_Pos: 445
        Relay_Master_Log_File: master.000002
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 6904
              Relay_Log_Space: 943
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
		   Master_SSL_Cert: 
           Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 10
                  Master_UUID: 0c08cd6a-5eac-11eb-a25f-000c296045b9
             Master_Info_File: /var/lib/mysql/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 0c08cd6a-5eac-11eb-a25f-000c296045b9:1-25
            Executed_Gtid_Set: 0c08cd6a-5eac-11eb-a25f-000c296045b9:1-25,
4c075ce8-5ead-11eb-ae81-000c29f7dd51:1-309
                Auto_Position: 1
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
```



#### 9、验证主从复制 







## 多源复制 

### 一、多源复制 

```
MySQL 5.7版本支持的 
多个主服务器对应一个从服务器 
作用: 便于数据合并、数据统一备份 
```

```
1、通过channel通道的机制来区分不同的主服务器 
2、需要将master.info， relay-log.info文件中记录的信息保存到数据表中 
```



### 二、多源复制

```
环境描述: 
	192.168.183.10	Master服务器 
	192.168.183.11	Master服务器 
	192.168.183.12	Slave 
```



#### 1、将主服务器的连接信息记录到表中

```
[mysqld]
server_id=12
master_info_repository=TABLE
relay_log_info_repository=TABLE
```



#### 2、连接主服务器，启动复制线程

```
mysql> change master to
    -> master_host="192.168.183.10",
    -> master_user="repluser",
    -> master_password="WWW.1.com",
    -> master_log_file="master01.000002",
    -> master_log_pos=414 for channel "to_master01";
Query OK, 0 rows affected, 2 warnings (0.00 sec)

mysql> change master to
    -> master_host="192.168.183.11",
    -> master_user="repluser",
    -> master_password="WWW.1.com",
    -> master_log_file="master02.000002",
    -> master_log_pos=414 for channel "to_master02";
Query OK, 0 rows affected, 2 warnings (0.01 sec)

mysql> start slave for channel "to_master01";
Query OK, 0 rows affected (0.00 sec)

mysql> start slave for channel "to_master02";
Query OK, 0 rows affected (0.00 sec)

mysql> show slave status for channel "to_master01"\G;
```



#### 3、查看记录主服务器连接信息的表 

```
mysql> select * from slave_master_info\G;

mysql> select * from slave_relay_log_info\G;
```




## 触发器  Trigger  

### 一、触发器 

```
作用：当检测到某数据表发生数据变化时，自动执行操作， 保证数据完整性 
```



#### 1、创建触发器

```
语法: 

create trigger 触发器名称 {BEFORE|AFTER} {INSERT|UPDATE|DELETE} on 表名 FOR EACH ROW 
BEGIN
操作;
操作; 
END

```



##### 案例1： 当检测到人员添加，数量自动增加 

```
mysql> create database testdb charset utf8;
Query OK, 1 row affected (0.00 sec)

mysql> use testdb;
Database changed

mysql> create table user(
    -> id INT primary key not null auto_increment,
    -> name char(20),
    -> age int);
Query OK, 0 rows affected (0.01 sec)

mysql> create table number(
    -> number int);
Query OK, 0 rows affected (0.05 sec)

mysql> insert into user(name, age) values("user01", 20);
Query OK, 1 row affected (0.00 sec)

mysql> insert into number values(1);
Query OK, 1 row affected (0.01 sec)

mysql> select * from user;
+----+--------+------+
| id | name   | age  |
+----+--------+------+
|  1 | user01 |   20 |
+----+--------+------+
1 row in set (0.00 sec)

mysql> select * from number;
+--------+
| number |
+--------+
|      1 |
+--------+
1 row in set (0.01 sec)
```

```
mysql> \d !!
mysql> create trigger number_auto_add after insert on user for each row
    -> begin
    -> update number set number=number+1;
    -> end!!
```



##### 案例2: 检测到人员减少，数量自动减少 

```
mysql> \d !!
mysql> create trigger number_auto_reduce AFTER DELETE on user FOR EACH ROW
    -> begin
    -> update number set number=number - 1;
    -> end!!
```



##### 案例3：检测到 员工增加时，自动添加工资信息 

```
mysql> create table worker(
    -> id INT primary key not null auto_increment,
    -> name char(20),
    -> age int,
    -> depart char(30));
    -> !!
Query OK, 0 rows affected (0.03 sec)

mysql> create table salary(
    -> name char(20),
    -> salary int)!!
Query OK, 0 rows affected (0.01 sec)

mysql> select * from worker;
    -> !!
+----+--------+------+--------+
| id | name   | age  | depart |
+----+--------+------+--------+
|  1 | martin |   30 | 运维   |
+----+--------+------+--------+
1 row in set (0.00 sec)

mysql> select * from salary!!
+--------+--------+
| name   | salary |
+--------+--------+
| martin |   1000 |
+--------+--------+
1 row in set (0.00 sec)
```

```
mysql> create trigger salay_auto_add AFTER INSERT on worker FOR EACH ROW
    -> BEGIN
    -> insert into salary values(new.name,2000);			//new   新数据 【添加、更新】
    -> END!!
Query OK, 0 rows affected (0.00 sec)
```



##### 案例4: 检测员工离职时，自动删除其工资信息 

```
mysql> \d !!
mysql> 
mysql> create trigger salary_auto_reduce AFTER DELETE on worker FOR EACH ROW
    -> BEGIN
    -> delete from salary where name=old.name;  		//old 旧数据，表中现有的数据 
    -> END!!
```



##### 案例5: 当检测到员工信息修改时，工资信息自动修改 

```
mysql> create trigger salay_auto_update AFTER UPDATE on worker FOR EACH ROW
    -> BEGIN
    -> update salary set name=new.name where name=old.name;
    -> END!!
```



#### 2、查看触发器 

```
mysql> show triggers\G;
```



#### 3、删除触发器

```
mysql> drop trigger number_auto_add;
```





## 存储过程   procedure  

### 一、存储过程  

```
作用: 将经常使用的功能写成存储过程，方便后续重复使用 
```



### 二、创建存储过程

```
语法: 
create procedure 存储过程名称(参数,参数,参数)
begin
操作;
操作; 
end
```



### 三、调用存储过程

```
> call 存储过程();
```



#### 案例1: 查看MySQL用户数

```
mysql> \d !!
mysql> create procedure user_count()
    -> begin
    -> select count(*) as 用户数 from mysql.user;
    -> end!!
Query OK, 0 rows affected (0.00 sec)

mysql> call user_count()!!
+-----------+
| 用户数    |
+-----------+
|         6 |
+-----------+
1 row in set (0.00 sec)

Query OK, 0 rows affected (0.00 sec)
```



#### 案例2: 批量插入数据 

```
mysql> \d !!
mysql> create procedure testop()
    -> begin
    -> declare i int default 1;
    -> while(i<=10) do
    -> insert into tb01 values(md5(i));
    -> set i=i+1;
    -> end while;
    -> end!!
Query OK, 0 rows affected (0.00 sec)

mysql> call testop()!!
Query OK, 1 row affected (0.01 sec)
```



### 四、IN类型的参数 

```
存储过程要想正常工作，必须在调用存储过程传递数据 

> create procedure 存储过程名称(IN 参数名称 数据类型)
```



#### 案例1: 改写批量插入数据  

```
1 mysql> create procedure testop_02(IN number INT)
2 begin
3 declare i int default 1;
4 while(i<=number) do insert into tb01(data) values(md5(i));
5 set i=i+1;
6 end while;
7 end!!
8
9 mysql> call testop_02(100);
```



#### 案例: 

```
mysql> \d !!
mysql> create procedure select_tutors(IN sex char(10), IN number INT)
    -> begin
    -> select * from tutors where Gender=sex and Age > number;
    -> end!!
Query OK, 0 rows affected (0.00 sec)

mysql> \d ;

mysql> call select_tutors("M", 20);
```



### 五、out类型参数

```
让存储过程返回某个数据，并不直接显示 
为了方便接收结果，对结果再做其他的处理
```



```
mysql> create procedure user_count_01(OUT number INT)
    -> begin
    -> select count(*) into number from mysql.user; 
    -> end!!
Query OK, 0 rows affected (0.00 sec)

mysql> 
mysql> \d ;
mysql> call user_count_01(@data);			//@data   在MySQL中定义名称为data的变量, 用于接收存储过程返回的数据
Query OK, 1 row affected (0.00 sec)

mysql> select @data;					   //查看data变量的值  
+-------+
| @data |
+-------+
|     6 |
+-------+
1 row in set (0.00 sec)

```








































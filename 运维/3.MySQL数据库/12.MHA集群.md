## MHA集群

### 一、MHA集群

```
MHA    Master High Avavibility   主服务器高可用 

应用场景:
	一主多从的环境 
	
作用: 
	提升主从复制环境中主服务器的可用性, 尽量减少故障时间
	周期性检测主服务器的运行状态，一旦检测到主服务器故障后，会在现有的从服务器选举一个新主服务器，并把其他的从服务器自动连接到新主服务器上，继续维持主从复制的运行 
	
	同时MHA还会尝试检测旧主服务器二进制日志，将二进制日志文件在新主服务器执行，尽可能保证数据完整

```

```
MHA角色: 

1、mha-manager		mha管理者
	建议将其部署独立的服务器，用于检测主服务器的运行状态 
	
2、mha-node			mha客户端 
	部署所有数据库服务器上
```



### 二、部署MHA集群

```
环境描述: 
	192.168.183.10		MHA Manager + MHA node
	192.168.183.11		Master服务器 		mha_node
	192.168.183.12		Slave服务器		mha_node
	192.168.183.13		Slave服务器 		mha_node
```



#### 1、关闭防火墙、SELinux， 时间同步 

#### 2、配置免密ssh

```
[root@mha ~]# ssh-keygen -t rsa
[root@mha ~]# mv /root/.ssh/id_rsa.pub /root/.ssh/authorized_keys
[root@mha ~]# scp -r /root/.ssh/ root@192.168.183.11:/root/  
[root@mha ~]# scp -r /root/.ssh/ root@192.168.183.12:/root/ 
[root@mha ~]# scp -r /root/.ssh/ root@192.168.183.13:/root/
```

#### 3、在所有机器上添加所有主机名解析  

```
[root@mha ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.183.10	mha.linux.com
192.168.183.11	master.linux.com
192.168.183.12	slave_01.linux.com
192.168.183.13	slave_02.linux.com

[root@mha ~]# rsync -av /etc/hosts root@192.168.183.11:/etc/hosts
[root@mha ~]# rsync -av /etc/hosts root@192.168.183.12:/etc/hosts
[root@mha ~]# rsync -av /etc/hosts root@192.168.183.13:/etc/hosts
```

#### 4、检测所有服务器时间同步

```
[root@mha ~]# for i in 10 11 12 13
> do
> ssh root@192.168.183.$i date
> done
Mon Jan 25 14:17:46 CST 2021
Mon Jan 25 14:17:46 CST 2021
Mon Jan 25 14:17:45 CST 2021
Mon Jan 25 14:17:46 CST 2021
```

#### 5、在mha管理机上安装mha相关软件

```
[root@mha ~]# yum install -y mha4mysql-manager mha4mysql-node 
```

#### 6、在所有数据库服务器上安装mha-node软件 

```
[root@master ~]# yum install -y mha4mysql-node
```

#### 7、配置一主两从环境  

##### 1) 在所有数据库服务器上启用二进制日志

```
[mysqld]
server_id=11
log_bin=master

[mysqld]
server_id=12
log_bin=slave01

[mysqld]
server_id=13
log_bin=slave02
```



##### 2) 创建允许所有主机远程连接的复制用户

```
MariaDB [(none)]> grant replication slave on *.* to 'repluser'@'192.168.183.12' identified by 'redhat';
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> grant replication slave on *.* to 'repluser'@'192.168.183.13' identified by 'redhat';
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> grant replication slave on *.* to 'repluser'@'192.168.183.11' identified by 'redhat';
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> flush privileges;
Query OK, 0 rows affected (0.00 sec)
```



##### 3) 配置从服务器连接主服务器, 确保三台数据库服务器都有远程复制用户

```
MariaDB [(none)]> change master to
    -> master_host="192.168.183.11",
    -> master_user="repluser",
    -> master_password="redhat",
    -> master_log_file="master.000001",
    -> master_log_pos=245;
Query OK, 0 rows affected (0.10 sec)

MariaDB [(none)]> start slave;
```



#### 8、创建MHA需要的管理用户 

```
MariaDB [(none)]> grant all on *.* to 'manager'@'192.168.183.10' identified by 'redhat';
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> grant all on *.* to 'manager'@'192.168.183.11' identified by 'redhat';
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> grant all on *.* to 'manager'@'192.168.183.12' identified by 'redhat';
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> grant all on *.* to 'manager'@'192.168.183.13' identified by 'redhat';
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> flush privileges;
Query OK, 0 rows affected (0.01 sec)
```



#### 9、创建MHA Manager需要的工作目录 

```
[root@mha ~]# mkdir -p /masterha/app1			//保存日志
[root@mha ~]# mkdir /etc/masterha				//配置文件 
```



#### 10、编辑mha的配置文件 

```
[root@mha ~]# cat /etc/masterha/app1.cnf

[server default]
manager_workdir=/masterha/app1
manager_log=/masterha/app1/manager.log
user=manager					//指定MHA管理用户，用于获取数据库服务器的运行状态、二进制日志信息等
password=redhat
ssh_user=root					//指定服务器间免密SSH的用户
repl_user=repluser				//指定连接主服务器复制数据时的远程复制用户
repl_password=redhat
ping_interval=1					//检测服务器运行状态的时间间隔，单位秒 

[server1]
hostname=192.168.183.11
port=3306
master_binlog_dir="/var/lib/mysql"			//指定对应数据库服务器二进制日志存储位置
candidate_master=1							//允许该服务器参选新主服务器 

[server2]
hostname=192.168.183.12
port=3306
master_binlog_dir="/var/lib/mysql"
candidate_master=1

[server3]
hostname=192.168.183.13
port=3306
master_binlog_dir="/var/lib/mysql"
candidate_master=1
```



#### 11、检测免密ssh是否正常 

```
[root@mha ~]# masterha_check_ssh --conf=/etc/masterha/app1.cnf 

Mon Jan 25 15:16:04 2021 - [info] All SSH connection tests passed successfully.
```



#### 12、检测一主两从是否正常

```
[root@mha ~]# masterha_check_repl --conf=/etc/masterha/app1.cnf 

192.168.183.11(192.168.183.11:3306) (current master)
 +--192.168.183.12(192.168.183.12:3306)
 +--192.168.183.13(192.168.183.13:3306)

Mon Jan 25 15:18:08 2021 - [info] Checking replication health on 192.168.183.12..
Mon Jan 25 15:18:08 2021 - [info]  ok.
Mon Jan 25 15:18:08 2021 - [info] Checking replication health on 192.168.183.13..
Mon Jan 25 15:18:08 2021 - [info]  ok.
Mon Jan 25 15:18:08 2021 - [warning] master_ip_failover_script is not defined.
Mon Jan 25 15:18:08 2021 - [warning] shutdown_script is not defined.
Mon Jan 25 15:18:08 2021 - [info] Got exit code 0 (Not master dead).

MySQL Replication Health is OK.
```



#### 13、启动mha

```
[root@mha ~]# masterha_manager --conf=/etc/masterha/app1.cnf 

[root@mha ~]# ps -elf | grep perl
0 S root       1469   1119  0  80   0 - 74284 hrtime 15:20 pts/0    00:00:00 perl /usr/bin/masterha_manager --conf=/etc/masterha/app1.cnf
```



#### 14、验证MHA作用 

```
[root@master ~]# systemctl stop mariadb

在新主服务器查看从服务器信息
MariaDB [(none)]> show slave hosts;
+-----------+------+------+-----------+
| Server_id | Host | Port | Master_id |
+-----------+------+------+-----------+
|        13 |      | 3306 |        12 |
+-----------+------+------+-----------+
1 row in set (0.00 sec)

在从服务器上查看对应的新主服务器 
MariaDB [(none)]> show slave status\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 192.168.183.12
                  Master_User: repluser
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: slave01.000003
          Read_Master_Log_Pos: 245
               Relay_Log_File: mariadb-relay-bin.000002
                Relay_Log_Pos: 527
        Relay_Master_Log_File: slave01.000003
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
```



#### 15、修复故障的主机，将其连接到 新主服务器

```
[root@slave_01 ~]# mysqldump -uroot --lock-all-tables --master-data=2 --all-databases > /tmp/data.sql
[root@slave_01 ~]# rsync -av /tmp/data.sql root@192.168.183.11:/tmp/

MariaDB [(none)]> change master to
    -> master_host="192.168.183.12",
    -> master_user="repluser",
    -> master_password="redhat",
    -> master_log_file="slave01.000003",
    -> master_log_pos=245;
Query OK, 0 rows affected (0.01 sec)

MariaDB [(none)]> start slave;
Query OK, 0 rows affected (0.01 sec)

再次启动MHA 
[root@mha ~]# masterha_manager --conf=/etc/masterha/app1.cnf 

[root@mha ~]# ps -elf | grep perl
0 S root      11726   1119  1  80   0 - 74284 hrtime 15:34 pts/0    00:00:00 perl /usr/bin/masterha_manager --conf=/etc/masterha/app1.cnf

192.168.183.12(192.168.183.12:3306) (current master)
 +--192.168.183.11(192.168.183.11:3306)
 +--192.168.183.13(192.168.183.13:3306)
```


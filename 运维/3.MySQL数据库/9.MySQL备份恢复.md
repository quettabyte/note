## MySQL备份、恢复

### 一、备份类型 

```
根据服务是否在线

1、热备份 
	服务在线, 正常进行数据读写操作；同时备份数据 
	
2、冷备份
	服务不在线，备份数据，备份完成后重新打开服务 
	
3、温备份
	服务在线，只能进行查询操作，同时备份数据 
	通过锁表的方式进行实现 

```



```
根据备份的数据量的大小

1、完全备份 
	备份所有数据 

2、增量备份 
	a. 备份完全备份后变化的数据
	b. 备份上一次增量备份后变化的数据 

3、差异备份 
	a. 备份完全备份后变化的所有数据 
```



```
根据备份的结果

1、逻辑备份 

	生成数据操作的SQL语句
	
	备份工具:
		mysqldump
	
2、物理备份 

	直接备份数据文件
	
	备份工具: 
		xtrabackup	
```



```
备份哪些数据？
	数据, 配置文件、二进制日志、触发器、存储过程
```





### 二、逻辑备份工具 ---- mysqldump

#### 1、常用选项 

```
1、备份所有数据库

--all-databases

2、备份指定的数据库 

--database 数据库名称 

3、在备份文件中记录数据库当前正在使用的二进制日志文件名称 、最后一个事件的position

--master-data={1|2}
	1: 非注释 
	2: 注释 
	
4、生成新的二进制日志文件 

--flush-logs 

5、锁表

--lock-all-tables

6、备份存储过程 

--routines

```



#### 2、案例: 完全 + 增量备份  

##### 1、准备存储备份文件的设备 

```
[root@localhost ~]# df -hT | grep -i backup
/dev/sdd                ext4       20G   45M   19G   1% /mysql/backup
```



##### 2、模拟周一做完全备份

```
[root@localhost ~]# mysqldump -uroot -predhat --master-data=2 --lock-all-tables --all-databases > /mysql/backup/data_$(date +%F_%T).sql 
```



##### 3、登录数据库，模拟写操作；进行周二的增量备份

```
mysql> delete from tutors where Age > 60;

[root@localhost ~]# mysqlbinlog --start-position=6152 /mysql/log/master.000004 > /mysql/backup/date_$(date +%F_%T).sql
```



##### 4、登录数据库，模拟写操作；进行周三的增量备份  

```
mysql> insert into tutors(Tname) values("user01"),("user02");

[root@localhost ~]# mysqlbinlog --start-position=6512 /mysql/log/master.000004 > /mysql/backup/data_$(date +%F_%T).sql 
```



##### 5、登录数据库，模拟写操作；模拟数据库故障 

```
mysql> insert into tutors(Tname) values("user03"), ("user04");

[root@localhost ~]# /etc/init.d/mysqld stop
Shutting down MySQL. SUCCESS! 

[root@localhost ~]# rm -rf /mysql/data/*
```



##### 6、进行数据恢复  

```
1、恢复MySQL服务正常运行 

2、恢复完全备份  
[root@localhost ~]# mysql -uroot -predhat < /mysql/backup/data_2021-01-21_13\:46\:05.sql 

3、恢复第二天的增量  
[root@localhost ~]# mysql -uroot -predhat < /mysql/backup/date_2021-01-21_13\:52\:01.sql 

4、恢复第三天的增量备份  
mysql> source /mysql/backup/data_2021-01-21_13:55:24.sql;

5、恢复未备份的数据 
[root@localhost ~]# mysqlbinlog --start-position=6797 /mysql/log/master.000004 | mysql -uroot -predhat 
```



### 三、物理备份工具  ----  xtrabackup 

#### 1、安装xtrabackup 

```
[root@localhost ~]# yum install -y percona-xtrabackup-24-2.4.6-2.el7.x86_64.rpm 
```



#### 2、完全备份 

```
完全备份

> innobackupex  --user=<用户名>  --password=<密码>  <备份目录>

[root@localhost ~]# innobackupex --user=root --password=redhat --socket=/tmp/mysql.sock  /mysql/backup/ 
```



#### 3、恢复完全备份

```
1、准备完全备份, 将事务日志中未同步的数据写入到数据文件中

# innobackex --apply-log <完全备份目录>

2、恢复完全备份 
# innobackex --copy-back <完全备份目录>
```

```
[root@localhost ~]# innobackupex --apply-log /mysql/backup/2021-01-21_16-01-42/ 
[root@localhost ~]# innobackupex --copy-back /mysql/backup/2021-01-21_16-01-42/ 

[root@localhost ~]# chown -R mysql.mysql /mysql/data/
[root@localhost ~]# /etc/init.d/mysqld start
```



#### 4、增量备份 

```
# innobackex --user=<用户名> --password=<密码> --incremental <备份目录> --incremental-basedir=<上一次备份目录>

注意：
	basedir
	第1次增量备份，完全备份目录
	第2次增量备份，指上一次增量备份目录
```



#### 5、恢复增量备份 

```
# innobackupex ‐‐apply‐log ‐‐redo‐only [root@localhost ~]# innobackupex --apply-log --redo-only /mysql/backup/2021-01-21_16-32-19/[root@localhost ~]# innobackupex --apply-log --redo-only /mysql/backup/2021-01-21_16-32-19/>

# innobackupex ‐‐apply‐log ‐‐redo‐only <完全备份目录> ‐‐incremental‐dir=<第一个增量备份目录>
# innobackupex ‐‐apply‐log ‐‐redo‐only <完全备份目录> ‐‐incremental‐dir=<第二个增量备份目录>
```



#### 6、案例: 完全  + 增量 

##### 1、进行周一的完全备份 

```
[root@localhost ~]# innobackupex --user=root --password=redhat --socket=/tmp/mysql.sock /mysql/backup/ 
```



##### 2、模拟周二的操作，进行增量备份  

```
mysql> insert into jiaowu.tutors(Tname) values("user05"),("user06");

[root@localhost ~]# innobackupex --user=root --password=redhat --socket=/tmp/mysql.sock --incremental /mysql/backup/ --incremental-basedir=/mysql/backup/2021-01-21_16-32-19/
```



##### 3、模拟周三的操作，进行增量备份 

```
mysql> insert into jiaowu.tutors(Tname) values("user07"),("user08");

[root@localhost ~]# innobackupex --user=root --password=redhat --socket=/tmp/mysql.sock --incremental /mysql/backup/ --incremental-basedir=/mysql/backup/2021-01-21_16-35-38/
```



##### 4、模拟周四的操作，模拟故障 

```
mysql> insert into jiaowu.tutors(Tname) values("user09"),("user10");

[root@localhost ~]# /etc/init.d/mysqld stop
Shutting down MySQL.. SUCCESS! 

[root@localhost ~]# rm -rf /mysql/data/*
```



##### 5、依次准备完全备份、增量备份  

```
[root@localhost ~]# innobackupex --apply-log --redo-only /mysql/backup/2021-01-21_16-32-19/
[root@localhost ~]# innobackupex --apply-log --redo-only /mysql/backup/2021-01-21_16-32-19/ --incremental-dir=/mysql/backup/2021-01-21_16-35-38/
[root@localhost ~]# innobackupex --apply-log --redo-only /mysql/backup/2021-01-21_16-32-19/ --incremental-dir=/mysql/backup/2021-01-21_16-37-57/
```



##### 6、恢复数据 

```
[root@localhost ~]# innobackupex --copy-back /mysql/backup/2021-01-21_16-32-19/
[root@localhost ~]# chown -R mysql.mysql /mysql/data/
[root@localhost ~]# /etc/init.d/mysqld start
Starting MySQL.Logging to '/mysql/data/localhost.err'.
 SUCCESS! 
```



##### 7、恢复未备份的数据 

```
[root@localhost ~]# mysqlbinlog --start-position=712 /mysql/log/master.000007 | mysql -uroot -p
```





建议恢复数据时，临时关闭二进制日志功能 

```
mysql> set sql_log_bin=0;
Query OK, 0 rows affected (0.00 sec)

mysql> source 备份文件名称;
```










































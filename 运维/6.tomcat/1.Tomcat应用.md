## Tomcat应用

### 一、tomcat介绍

#### 1、作用

```
动态网站主流编写语言:
	php, lamp/lnmp平台 
	java	tomcat 
		*.jsp文件 
		
作用: java应用程序中间件
```

```
其他中间件介绍:

开源的中间件
	tomcat, resin
商业的中间件
	weblogical, websphere 
```



#### 2、特性 

```
1、开源的    Apache开源组织 
	http://tomcat.apache.org/
2、跨平台的 
3、支持多实例的部署 
4、支持https协议
```



### 二、安装部署Tomcat

#### 1、安装jdk1.8

```
[root@localhost ~]# tar xf jdk-8u91-linux-x64.tar.gz -C /usr/local/

[root@localhost ~]# tail -n 2 /etc/profile
export JAVA_HOME=/usr/local/jdk1.8.0_91
export PATH=$PATH:$JAVA_HOME/bin

[root@localhost ~]# source /etc/profile
 
[root@localhost ~]# java -version
java version "1.8.0_91"
Java(TM) SE Runtime Environment (build 1.8.0_91-b14)
Java HotSpot(TM) 64-Bit Server VM (build 25.91-b14, mixed mode)

```

#### 2、安装tomcat

```
[root@localhost ~]# wget https://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.63/bin/apache-tomcat-8.5.63.tar.gz
[root@localhost ~]# tar xf apache-tomcat-8.5.63.tar.gz -C /usr/local/
[root@localhost ~]# mv /usr/local/apache-tomcat-8.5.63/ /usr/local/tomcat85

[root@localhost ~]# tail -n 1 /etc/profile
export CATALINA_HOME=/usr/local/tomcat85

[root@localhost ~]# source /etc/profile
```



#### 3、tomcat目录结构介绍 

```
1、tomcat安装目录/bin		//管理工具
2、tomcat安装目录/conf		//配置文件, 主配置文件 server.xml
3、tomcat安装目录/logs		//日志
4、tomcat安装目录/lib		//库文件, jar包 
5、tomcat安装目录/webapps	//默认的项目目录  
```



#### 4、启动tomcat

```
[root@localhost ~]# /usr/local/tomcat85/bin/catalina.sh start
Using CATALINA_BASE:   /usr/local/tomcat85
Using CATALINA_HOME:   /usr/local/tomcat85
Using CATALINA_TMPDIR: /usr/local/tomcat85/temp
Using JRE_HOME:        /usr/local/jdk1.8.0_91
Using CLASSPATH:       /usr/local/tomcat85/bin/bootstrap.jar:/usr/local/tomcat85/bin/tomcat-juli.jar
Using CATALINA_OPTS:   
Tomcat started.

[root@localhost ~]# netstat -antp | grep java
tcp6       0      0 :::8080                 :::*                    LISTEN      7038/java           
tcp6       0      0 127.0.0.1:8005          :::*                    LISTEN      7038/java      
```

```
测试访问: 

http://192.168.140.10:8080/
```



#### 5、设置tomcat开机自启

```
[root@localhost ~]# tail -n 4 /etc/rc.d/rc.local 
export JAVA_HOME=/usr/local/jdk1.8.0_91
export PATH=$PATH:$JAVA_HOME/bin
export CATALINA_HOME=/usr/local/tomcat85
/usr/local/tomcat85/bin/catalina.sh start

[root@localhost ~]# chmod a+x /etc/rc.d/rc.local

```



### 三、tomcat配置使用 ----  server.xml 

#### 1、tomcat项目目录 

```
默认项目目录:
	tomcat安装目录/webapps
	
部署项目的方式:
	在项目目录下创建子目录, 在不同的子目录可以部署不同的项目文件 
	客户端通过IP:port的方式访问tomcat时, tomcat默认行为会使用ROOT子目录下的文件给客户端响应 
```



#### 2、server.xml常用配置

##### 1) 定义tomcat实例端口

```
<Server port="8005" shutdown="SHUTDOWN">
不同的实例要使用不同的端口 
```

##### 2) 定义tomcat提供的服务名称 

```
<Service name="Catalina">
```

##### 3）定义提供http服务的端口

```
    <Connector port="8080" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" />
```

##### 4) 定义虚拟主机

```
      <Host name="localhost"  appBase="webapps"
            unpackWARs="true" autoDeploy="true">

        <Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"
               prefix="localhost_access_log" suffix=".txt"
               pattern="%h %l %u %t &quot;%r&quot; %s %b" />

      </Host>
      
      
解释说明:
1) name="localhost"			//指定虚拟主机名称
2) appBase=""				//指定项目目录 
3) <Valve ....				//定义访问日志
	directory=""		//访问日志存放路径 
	prefix=""			//访问日志的开头
	suffix=""			//定义访问日志的结尾 
	patter=""			//访问日志格式  
	
4)  <Context path="" docBase="test1" />
		定义tomcat响应客户端的项目路径, 默认是ROOT

```

##### 5) 定义默认虚拟主机

```
    <Engine name="Catalina" defaultHost="虚拟主机名称">
    
    用于指定客户端通过IP:PORT访问tomcat时，tomcat使用哪个虚拟主机给客户端响应 
```





### 四、tomcat多实例部署

```
实例1 端口: 8010 http端口: 9000 安装目录: /opt/tomcat01 项目:/data01/ROOT
实例2 端口: 8020 http端口: 9001 安装目录: /opt/tomcat02 项目:/data02/ROOT
```

#### 1、创建项目目录，测试文件 

```
[root@localhost ~]# mkdir -p /data01/ROOT
[root@localhost ~]# vim /data01/ROOT/index.jsp
<h1> tomcat 01 server </h1>

[root@localhost ~]# mkdir -p /data02/ROOT
[root@localhost ~]# vim /data02/ROOT/index.jsp
<h1> tomcat 02 server </h1>

```



#### 2、创建实例的安装目录

```
[root@localhost ~]# mkdir -p /opt/tomcat0{1,2}/{conf,logs}
```



#### 3、准备实例的配置文件

```
[root@localhost ~]# cp -r /usr/local/tomcat85/conf/* /opt/tomcat01/conf/
[root@localhost ~]# cp -r /usr/local/tomcat85/conf/* /opt/tomcat02/conf/
```



#### 4、编辑实例的配置文件

```
[root@localhost ~]# vim /opt/tomcat01/conf/server.xml

	<Server port="8010" shutdown="SHUTDOWN">
	
    <Connector port="9000" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" />
               
     <Engine name="Catalina" defaultHost="localhost">

      <Host name="localhost"  appBase="/data01"
            unpackWARs="true" autoDeploy="true">
            
        <Valve className="org.apache.catalina.valves.AccessLogValve" directory="/opt/tomcat01/logs"
               prefix="localhost_access_log" suffix=".txt"
               pattern="%h %l %u %t &quot;%r&quot; %s %b" />

```



#### 5、准备实例的启动脚本 

```
[root@localhost ~]# cat /opt/tomcat01/server.sh
#!/bin/bash
#

export CATALINA_HOME=/usr/local/tomcat85
export CATALINA_BASE=/opt/tomcat01

case $1 in
  start)
     $CATALINA_HOME/bin/startup.sh
     ;;
  stop)
     $CATALINA_HOME/bin/shutdown.sh
     ;;
  restart)
     $CATALINA_HOME/bin/shutdown.sh
     sleep 2
     $CATALINA_HOME/bin/startup.sh
     ;;
esac


[root@localhost ~]# chmod a+x /opt/tomcat01/server.sh

```



#### 6、启动tomcat实例

```
[root@localhost ~]# /opt/tomcat01/server.sh start
[root@localhost ~]# /opt/tomcat02/server.sh start

[root@localhost ~]# netstat -antp | grep java
tcp6       0      0 :::9000                 :::*                    LISTEN      17718/java          
tcp6       0      0 :::9001                 :::*                    LISTEN      17757/java          
tcp6       0      0 127.0.0.1:8010          :::*                    LISTEN      17718/java          
tcp6       0      0 127.0.0.1:8020          :::*                    LISTEN      17757/java   

```



#### 7、测试访问实例

```
http://192.168.140.10:9000/
http://192.168.140.10:9001
```



### 五、nginx实现tomcat反向代理

```
    upstream tomcatserver {
          server 192.168.140.10:9000;
          server 192.168.140.10:9001;
    }

    location / {
       proxy_pass http://tomcatserver;
       proxy_set_header X-Real-IP $remote_addr;
    }

```


















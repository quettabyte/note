## LVS集群案例

### 一、环境描述

![image-20210308091825932](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210308091825932.png)

```
keepalived结合LVS集群使用时的优势:
	1、实现调度器的HA
	2、自动生成虚拟服务、real server
	3、对real server进行健康状态检查
```



#### 1、配置nfs共享数据目录 

```
[root@nfs_server ~]# df -hT | grep sdb
/dev/sdb                ext4       20G   45M   19G   1% /webdata

[root@nfs_server ~]# yum install -y nfs-utils rpcbind

[root@nfs_server ~]# cat /etc/exports
/webdata	192.168.140.12(ro,async)   192.168.140.13(ro,async)
 
[root@nfs_server ~]# systemctl start nfs-server
[root@nfs_server ~]# systemctl enable nfs-server

在NFS服务器创建测试项目文件

[root@nfs_server ~]# ls /webdata/
index.html

```

#### 2、在所有real server上安装httpd，连接后端存储 

```
[root@web01 ~]# yum install -y httpd nfs-utils
[root@web01 ~]# rm -rf /etc/httpd/conf.d/welcome.conf 

[root@web01 ~]# tail -n 1 /etc/fstab 
192.168.140.14:/webdata		/var/www/html	nfs	defaults	0 0

[root@web01 ~]# mount -a

[root@web01 ~]# df -hT | grep www
192.168.140.14:/webdata nfs4       20G   44M   19G   1% /var/www/html

[root@web01 ~]# ls /var/www/html/
index.html

[root@web01 ~]# systemctl start httpd


```

#### 3、在所有real server配置VIP， 修改arp内核参数

```
[root@web01 ~]# ip addr add dev lo 192.168.140.100/32

[root@web01 ~]# sed -ri '$ a \net.ipv4.conf.all.arp_ignore = 1' /etc/sysctl.conf 
[root@web01 ~]# sed -ri '$ a \net.ipv4.conf.all.arp_announce = 2' /etc/sysctl.conf 
[root@web01 ~]# sysctl -p
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 2

```

#### 4、在调度器分别安装keepalived, ipvsadm

```
[root@director01 ~]# yum install -y keepalived ipvsadm.x86_64  

[root@director02 ~]# yum install -y keepalived ipvsadm.x86_64 

```

#### 5、编辑主调度器的keepalived配置文件

```
[root@director01 ~]# vim /etc/keepalived/keepalived.conf 

! Configuration File for keepalived

global_defs {
   router_id director01			//指定调度器的ID，要惟一
}

vrrp_instance web_service {			//定义虚拟组名
    state MASTER					//指定调度器的角色为主调度
    interface ens33					//指定VIP出现的位置
    virtual_router_id 55			//虚拟组的ID
    priority 100 					//优先级
    advert_int 1					//心跳的时间间隔
    authentication {
        auth_type PASS
        auth_pass redhat			//认证的密码
    }   
    virtual_ipaddress {
        192.168.140.100				//VIP
    }   
}

virtual_server 192.168.140.100 80 {				//定义虚拟服务
    delay_loop 6
    lb_algo rr									//调度算法
    lb_kind DR									//LVS工作模式
    persistence_timeout 300 					//持久性连接
    protocol TCP 

    real_server 192.168.140.12 80 {				//real server地址
        weight 1								//权重
        TCP_CHECK {								//健康检查的方法
            connect_port 80
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
        }   
    }   
    real_server 192.168.140.13 80 {
        weight 1
        TCP_CHECK {
            connect_port 80
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
        }   
    }   
}

```

#### 6、编辑备调度的配置文件

```
[root@director01 ~]# rsync -av /etc/keepalived/keepalived.conf root@192.168.140.11:/etc/keepalived/keepalived.conf 

[root@director02 ~]# vim /etc/keepalived/keepalived.conf 


! Configuration File for keepalived

global_defs {
   router_id director02			
}

vrrp_instance web_service {
    state BACKUP
    interface ens33
    virtual_router_id 55
    priority 50
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass redhat
    }
    virtual_ipaddress {
        192.168.140.100
    }
}

virtual_server 192.168.140.100 80 {
    delay_loop 6
    lb_algo rr
    lb_kind DR
    persistence_timeout 300
    protocol TCP

    real_server 192.168.140.12 80 {
        weight 1
        TCP_CHECK {
            connect_port 80
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
        }
    }
    real_server 192.168.140.13 80 {
        weight 1
        TCP_CHECK {
            connect_port 80
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
        }
    }
}

```

#### 7、分别启动keepalived服务 

```
[root@director01 ~]# systemctl start keepalived
[root@director01 ~]# systemctl enable keepalived

[root@director02 ~]# systemctl start keepalived
[root@director02 ~]# systemctl enable keepalived

```

##### 1) 验证VIP， VIP同一时间只在主调度器上出现 

```
[root@director01 ~]# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:8f:c3:68 brd ff:ff:ff:ff:ff:ff
    inet 192.168.140.10/24 brd 192.168.140.255 scope global noprefixroute ens33
       valid_lft forever preferred_lft forever
    inet 192.168.140.100/32 scope global ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe8f:c368/64 scope link 

```

##### 2) 验证虚拟服务 

```
[root@director01 ~]# ipvsadm -L -n
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  192.168.140.100:80 rr persistent 300
  -> 192.168.140.12:80            Route   1      0          0         
  -> 192.168.140.13:80            Route   1      0          0  
```

##### 3) 测试访问

```
http://192.168.140.100/
```

##### 4）停止主调度器，验证VIP故障转移 

```
[root@director01 ~]# systemctl stop keepalived.service 

```


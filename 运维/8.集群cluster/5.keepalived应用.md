## keepalived应用

### 一、keepalived介绍

    作用：实现HA集群 
    基于vrrp(虚拟路由冗余协议)协议开发

```
1、优先级
	通过优先级选举主备角色
	取值范围: 1---255, 数字越大优先级越高
	
2、心跳信息
	主设备会周期性发送心跳信息以通知备设备自己的状态, 备设备一段时间内接收不到心跳信息，会认为主设备宕机，抢夺VIP继续提供服务
	默认心跳信息的传播方式：
		组播、 224.0.0.18 	
		
3、虚拟MAC地址

	vrrp组配置id，作用是为了生成虚拟MAC地址
	在VRRP协议实现中，虚拟路由器使用00-00-5E-00-01-XX作为虚拟MAC地址。
	xx：把组号转换为十六进制数

```

### 二、基于keepalived实现nginx的HA

![image-20210309134258522](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210309134258522.png)

#### 1、安装httpd配置虚拟主机

    [root@web_server ~]# cat /etc/httpd/conf.d/web2.conf
    <VirtualHost 192.168.140.13:80>
         ServerName music.linux.com
         DocumentRoot /web02
    </VirtualHost>

    <Directory "/web02">
       Require all granted
    </Directory>
    [root@web_server ~]# 
    [root@web_server ~]# cat /etc/httpd/conf.d/web1.conf
    <VirtualHost 192.168.140.12:80>
         ServerName vedio.linux.com
         DocumentRoot /web01
    </VirtualHost>

    <Directory "/web01">
       Require all granted
    </Directory>

#### 2、配置nginx实现web的负载均衡

        upstream websrv {
            server 192.168.140.12:80;
            server 192.168.140.13:80;
        }

        server {
            listen       80;
            server_name  localhost;

            location / {
                  proxy_pass http://websrv;
                  proxy_set_header X-Real-IP $remote_addr;
            }

#### 3、测试通过nginx可正常访问服务

#### 4、在nginx上安装keepalived

    [root@nginx01 ~]# yum install -y keepalived 
    [root@nginx02 ~]# yum install -y keepalived 

#### 5、编辑keepalived配置文件

```
[root@nginx01 ~]# cat /etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id nginx01
}

vrrp_instance web_service {
    state MASTER
    interface ens33
    virtual_router_id 11
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass redhat
    }
    virtual_ipaddress {
        192.168.140.100
    }
}

```

```
[root@nginx02 ~]# cat /etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id nginx02
}

vrrp_instance web_service {
    state BACKUP
    interface ens33
    virtual_router_id 11
    priority 50
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass redhat
    }
    virtual_ipaddress {
        192.168.140.100
    }
}

```

#### 6、启动keepalived

    [root@nginx01 ~]# systemctl start keepalived.service 
    [root@nginx01 ~]# systemctl enable keepalived.service

#### 7、测试通过VIP访问web服务

    http://192.168.140.100/

#### 8、查看keepalived日志

```
[root@nginx01 ~]# tail -n 30 /var/log/messages 

Mar  9 14:07:42 localhost Keepalived_vrrp[9749]: VRRP_Instance(web_service) Transition to MASTER STATE
Mar  9 14:07:43 localhost Keepalived_vrrp[9749]: VRRP_Instance(web_service) Entering MASTER STATE
Mar  9 14:07:43 localhost Keepalived_vrrp[9749]: VRRP_Instance(web_service) setting protocol VIPs.
Mar  9 14:07:43 localhost Keepalived_vrrp[9749]: Sending gratuitous ARP on ens33 for 192.168.140.100

```

    [root@nginx02 ~]# tail -n 30 /var/log/messages 

    Mar  9 14:07:52 localhost Keepalived_vrrp[7174]: VRRP_Instance(web_service) Entering BACKUP STATE

#### 9、查看心跳信息

    [root@nginx01 ~]# tcpdump -i ens33 -nn vrrp 
    tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
    listening on ens33, link-type EN10MB (Ethernet), capture size 262144 bytes
    14:15:38.033810 IP 192.168.140.10 > 224.0.0.18: VRRPv2, Advertisement, vrid 11, prio 100, authtype simple, intvl 1s, length 20
    14:15:39.035228 IP 192.168.140.10 > 224.0.0.18: VRRPv2, Advertisement, vrid 11, prio 100, authtype simple, intvl 1s, length 20
    14:15:40.036448 IP 192.168.140.10 > 224.0.0.18: VRRPv2, Advertisement, vrid 11, prio 100, authtype simple, intvl 1s, length 20
    14:15:41.037970 IP 192.168.140.10 > 224.0.0.18: VRRPv2, Advertisement, vrid 11, prio 100, authtype simple, intvl 1s, length 20

```
[root@nginx02 ~]# tcpdump -i ens33 -nn vrrp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on ens33, link-type EN10MB (Ethernet), capture size 262144 bytes
14:17:27.215278 IP 192.168.140.10 > 224.0.0.18: VRRPv2, Advertisement, vrid 11, prio 100, authtype simple, intvl 1s, length 20
14:17:28.216798 IP 192.168.140.10 > 224.0.0.18: VRRPv2, Advertisement, vrid 11, prio 100, authtype simple, intvl 1s, length 20
14:17:29.218558 IP 192.168.140.10 > 224.0.0.18: VRRPv2, Advertisement, vrid 11, prio 100, authtype simple, intvl 1s, length 20
14:17:30.219945 IP 192.168.140.10 > 224.0.0.18: VRRPv2, Advertisement, vrid 11, prio 100, authtype simple, intvl 1s, length 20

```

#### 10、配置以单播的形式传送心跳信息

        unicast_src_ip 192.168.140.10			//发送心跳信息的源地址
        unicast_peer {							//接收心跳信息的对端地址
              192.168.140.11
        }

```
[root@nginx02 ~]# tcpdump -i ens33 -nn vrrp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on ens33, link-type EN10MB (Ethernet), capture size 262144 bytes
14:24:50.052964 IP 192.168.140.10 > 192.168.140.11: VRRPv2, Advertisement, vrid 11, prio 100, authtype simple, intvl 1s, length 20
14:24:51.054199 IP 192.168.140.10 > 192.168.140.11: VRRPv2, Advertisement, vrid 11, prio 100, authtype simple, intvl 1s, length 20
14:24:52.055869 IP 192.168.140.10 > 192.168.140.11: VRRPv2, Advertisement, vrid 11, prio 100, authtype simple, intvl 1s, length 20
14:24:53.057788 IP 192.168.140.10 > 192.168.140.11: VRRPv2, Advertisement, vrid 11, prio 100, authtype simple, intvl 1s, length 20

```

#### 11、keepalived调用外部脚本实现VIP故障转移

##### 1) 编写检测服务的脚本

```
[root@nginx01 ~]# vim /etc/keepalived/checknginx.sh

#!/bin/bash
#

curl 127.0.0.1 &> /dev/null
if [ $? -ne 0 ]; then
    systemctl stop keepalived
fi

[root@nginx01 ~]# chmod a+x /etc/keepalived/checknginx.sh

```

##### 2) 配置keepalived使用脚本

```
1、定义外部脚本
vrrp_script check_nginx {
    script "/etc/keepalived/checknginx.sh"			//指定脚本名称
    interval 1										//调用脚本的时间间隔，单位秒
}

2、调用外部脚本 

vrrp_instance web_service {
	........
    track_script {
       check_nginx			//外部脚本名称
    }

```

##### 3) 测试停止nginx服务，VIP转移

```
主调度器日志:

Mar  9 15:09:58 localhost systemd: Stopping LVS and VRRP High Availability Monitor...
Mar  9 15:09:58 localhost Keepalived[22467]: Stopping
Mar  9 15:09:58 localhost Keepalived_healthcheckers[22468]: Stopped
Mar  9 15:09:58 localhost Keepalived_vrrp[22469]: VRRP_Instance(web_service) sent 0 priority
Mar  9 15:09:58 localhost Keepalived_vrrp[22469]: VRRP_Instance(web_service) removing protocol VIPs.

```

```
备调度日志:

Mar  9 15:09:58 localhost Keepalived_vrrp[20017]: VRRP_Instance(web_service) Transition to MASTER STATE
Mar  9 15:09:59 localhost Keepalived_vrrp[20017]: VRRP_Instance(web_service) Entering MASTER STATE
Mar  9 15:09:59 localhost Keepalived_vrrp[20017]: VRRP_Instance(web_service) setting protocol VIPs.
Mar  9 15:09:59 localhost Keepalived_vrrp[20017]: Sending gratuitous ARP on ens33 for 192.168.140.100

```

#### 12、配置nopreempt特性

    默认情况下，keepalived会主动抢夺VIP

```
在优先级高的调度器上作配置:

vrrp_instance web_service {
    state BACKUP
    nopreempt

```

### 三、配置MyCAT集群

![image-20210309164728752](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210309164728752.png)

#### 1、配置MySQL主从复制

```
[root@mysql01 ~]# sed -n '1,3p' /etc/my.cnf
[mysqld]
server_id=14
log_bin=master
[root@mysql01 ~]# systemctl start mariadb
[root@mysql01 ~]# systemctl enable mariadb

MariaDB [(none)]> show master status;
+---------------+----------+--------------+------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+---------------+----------+--------------+------------------+
| master.000003 |      245 |              |                  |
+---------------+----------+--------------+------------------+
1 row in set (0.00 sec)

MariaDB [(none)]> 
MariaDB [(none)]> grant replication slave on *.* to 'repluser'@'192.168.140.15' identified by 'redhat';
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> flush privileges;
Query OK, 0 rows affected (0.00 sec)

```

```
[root@mysql02 ~]# sed -n '1,3p' /etc/my.cnf
[mysqld]
server_id=15
log_bin=slave
[root@mysql02 ~]# systemctl start mariadb
[root@mysql02 ~]# systemctl enable mariadb

MariaDB [(none)]> change master to
    -> master_host="192.168.140.14",
    -> master_user="repluser",
    -> master_password="redhat",
    -> master_log_file="master.000003",
    -> master_log_pos=245;
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> start slave;
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> show slave status\G;

             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes

```

```
MariaDB [(none)]> create database game charset utf8;
Query OK, 1 row affected (0.00 sec)

MariaDB [(none)]> use game;

MariaDB [game]> create table info(id INT,
    -> name char(30));
Query OK, 0 rows affected (0.00 sec)

MariaDB [game]> insert into info values(1, "martin"), (2, 'robin');
Query OK, 2 rows affected (0.00 sec)
Records: 2  Duplicates: 0  Warnings: 0

```

#### 2、配置MyCAT实现读写分离

    [root@mycat01 ~]# cat /etc/hosts
    127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
    ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

    192.168.140.12	mycat01

```
[root@mycat01 ~]# tar xf jdk-8u91-linux-x64.tar.gz -C /usr/local/
[root@mycat01 ~]# vim /etc/profile
export JAVA_HOME=/usr/local/jdk1.8.0_91
export PATH=$PATH:$JAVA_HOME/bin
[root@mycat01 ~]# source /etc/profile

[root@mycat01 ~]# java -version
java version "1.8.0_91"
Java(TM) SE Runtime Environment (build 1.8.0_91-b14)
Java HotSpot(TM) 64-Bit Server VM (build 25.91-b14, mixed mode)

```

```
[root@mycat01 ~]# tar xf Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz -C /usr/local/
[root@mycat01 ~]# ls /usr/local/
bin  etc  games  include  jdk1.8.0_91  lib  lib64  libexec  mycat  sbin  share  src

```

```
MariaDB [game]> grant all on *.* to 'admin'@'192.168.140.12' identified by 'redhat';
Query OK, 0 rows affected (0.00 sec)

MariaDB [game]> grant all on *.* to 'admin'@'192.168.140.13' identified by 'redhat';
Query OK, 0 rows affected (0.00 sec)

MariaDB [game]> flush privileges;
Query OK, 0 rows affected (0.00 sec)

```

```
[root@mycat01 ~]# cat /usr/local/mycat/conf/schema.xml
<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">

	<schema name="game" checkSQLschema="false" sqlMaxLimit="100" dataNode="dn1">
	</schema>

	<dataNode name="dn1" dataHost="dh1" database="game" />

	<dataHost name="dh1" maxCon="1000" minCon="10" balance="1"
			  writeType="0" dbType="mysql" dbDriver="native" switchType="1"  slaveThreshold="100">
		<heartbeat>select user()</heartbeat>
		<!-- can have multi write hosts -->
		<writeHost host="hostM1" url="192.168.140.14:3306" user="admin"
				   password="redhat">
		</writeHost>
		<writeHost host="hostS1" url="192.168.140.15:3306" user="admin"
				   password="redhat" />
	</dataHost>
</mycat:schema>

```

```
[root@mycat01 ~]# vim /usr/local/mycat/conf/server.xml 

      <user name="martin">
                <property name="password">redhat</property>
                <property name="schemas">game</property>
        </user>

```

    [root@mycat01 ~]# /usr/local/mycat/bin/mycat start
    Starting Mycat-server...
    [root@mycat01 ~]# 
    [root@mycat01 ~]# netstat -antp | grep -E "8066|9066"
    tcp6       0      0 :::9066                 :::*                    LISTEN      7174/java           
    tcp6       0      0 :::8066                 :::*                    LISTEN      7174/java    

```
[root@mysql02 ~]# mysql -u martin -p -h 192.168.140.12 -P 8066
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 1
Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (OpenCloundDB)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> show databases;
+----------+
| DATABASE |
+----------+
| game     |
+----------+
1 row in set (0.00 sec)

MySQL [(none)]> select * from game.info;
+------+--------+
| id   | name   |
+------+--------+
|    1 | martin |
|    2 | robin  |
+------+--------+
2 rows in set (0.06 sec)


```

```
[root@mycat02 ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.140.13 mycat02

```

    [root@mycat01 ~]# scp -r /usr/local/jdk1.8.0_91/ root@192.168.140.13:/usr/local/
    [root@mycat01 ~]# scp -r /usr/local/mycat/ root@192.168.140.13:/usr/local/
    [root@mycat01 ~]# rsync -av /etc/profile root@192.168.140.13:/etc/profile

<!---->

    [root@mycat02 ~]# source /etc/profile
    [root@mycat02 ~]# 
    [root@mycat02 ~]# java -version
    java version "1.8.0_91"
    Java(TM) SE Runtime Environment (build 1.8.0_91-b14)
    Java HotSpot(TM) 64-Bit Server VM (build 25.91-b14, mixed mode)
    [root@mycat02 ~]# 
    [root@mycat02 ~]# /usr/local/mycat/bin/mycat start
    Starting Mycat-server...
    Removed stale pid file: /usr/local/mycat/logs/mycat.pid
    [root@mycat02 ~]# 
    [root@mycat02 ~]# netstat -antp | grep -E "8066|9066"
    tcp6       0      0 :::9066                 :::*                    LISTEN      7046/java           
    tcp6       0      0 :::8066                 :::*                    LISTEN      7046/java  

```
[root@mysql02 ~]# mysql -u martin -p -h 192.168.140.13 -P 8066
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 1
Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (OpenCloundDB)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> select * from game.info;
+------+--------+
| id   | name   |
+------+--------+
|    1 | martin |
|    2 | robin  |
+------+--------+
2 rows in set (0.09 sec)

```

#### 3、配置调度器提供MyCAT服务

    [root@haproxy01 ~]# yum install -y haproxy 

<!---->

    [root@haproxy01 ~]# cat /etc/haproxy/haproxy.cfg
    global
           maxconn 2000
           nbproc 1
           user nobody
           group nobody
           log 127.0.0.1 local0 info
           daemon
           pidfile /var/run/haproxy.pid

    defaults
           retries 3
           timeout connect 5s
           timeout client 10s
           timeout server 30s
           timeout check 2s

    listen mycat_service
           bind 0.0.0.0:8066
           mode tcp
           balance source
           server mycat01 192.168.140.12:8066 weight 3 check inter 2000 rise 1 fall 2
           server mycat02 192.168.140.13:8066 weight 3 check inter 2000 rise 1 fall 2

<!---->

    [root@haproxy01 ~]# systemctl start haproxy
    [root@haproxy01 ~]# systemctl enable haproxy
    Created symlink from /etc/systemd/system/multi-user.target.wants/haproxy.service to /usr/lib/systemd/system/haproxy.service.
    [root@haproxy01 ~]# 
    [root@haproxy01 ~]# netstat -antp | grep haproxy
    tcp        0      0 0.0.0.0:8066            0.0.0.0:*               LISTEN      6976/haproxy   

```
[root@mysql02 ~]# mysql -u martin -p -h 192.168.140.10 -P 8066
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (OpenCloundDB)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> select * from game.info;
+------+--------+
| id   | name   |
+------+--------+
|    1 | martin |
|    2 | robin  |
+------+--------+
2 rows in set (0.00 sec)

```

    [root@haproxy02 ~]# yum install -y haproxy
    [root@haproxy02 ~]# rsync -av root@192.168.140.10:/etc/haproxy/haproxy.cfg  /etc/haproxy/haproxy.cfg 
    [root@haproxy02 ~]# systemctl start haproxy
    [root@haproxy02 ~]# systemctl enable haproxy

    [root@haproxy02 ~]# netstat -antp | grep haproxy
    tcp        0      0 0.0.0.0:8066            0.0.0.0:*               LISTEN      6994/haproxy    

```
[root@mysql02 ~]# mysql -u martin -p -h 192.168.140.11 -P 8066
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 3
Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (OpenCloundDB)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> select * from game.info;
+------+--------+
| id   | name   |
+------+--------+
|    1 | martin |
|    2 | robin  |
+------+--------+
2 rows in set (0.00 sec)

MySQL [(none)]> 

```

#### 4、配置keepalived实现高可用

    [root@haproxy01 ~]# yum install -y keepalived 
    [root@haproxy02 ~]# yum install -y keepalived 

```
[root@haproxy01 ~]# cat /etc/keepalived/checkmycat.sh
#!/bin/bash
#

mysql -umartin -predhat -h 192.168.140.10 -P 8066 -e "show databases" &> /dev/null

if [ $? -ne 0 ]; then
    systemctl stop keepalived
fi
[root@haproxy01 ~]# chmod a+x /etc/keepalived/checkmycat.sh

```

```
[root@haproxy01 ~]# cat /etc/keepalived/keepalived.conf
! Configuration File for keepalived


global_defs {
   router_id haproxy01
}

vrrp_script check_mycat {
    script "/etc/keepalived/checkmycat.sh"
    interval 1
}

vrrp_instance mycat_service {
    state MASTER
    interface ens33
    virtual_router_id 55
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass redhat
    }
    virtual_ipaddress {
        192.168.140.100
    }
    track_script {
        check_mycat
    }
}

```

```
global_defs {
   router_id haproxy02
}

vrrp_script check_mycat {
    script "/etc/keepalived/checkmycat.sh"
    interval 1
}

vrrp_instance mycat_service {
    state BACKUP
    interface ens33
    virtual_router_id 55
    priority 50
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass redhat
    }
    virtual_ipaddress {
        192.168.140.100
    }
    track_script {
        check_mycat
    }
}

```

```
[root@haproxy01 ~]# systemctl start keepalived.service 
[root@haproxy01 ~]# systemctl enable keepalived.service
Created symlink from /etc/systemd/system/multi-user.target.wants/keepalived.service to /usr/lib/systemd/system/keepalived.service.
[root@haproxy01 ~]# 

[root@haproxy02 ~]# systemctl start keepalived.service 
[root@haproxy02 ~]# systemctl enable keepalived.service
Created symlink from /etc/systemd/system/multi-user.target.wants/keepalived.service to /usr/lib/systemd/system/keepalived.service.
[root@haproxy02 ~]# 

```

#### 5、测试

##### 1) 通过VIP连接Mycat

```
[root@mysql02 ~]# mysql -u martin -p -h 192.168.140.100 -P 8066
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 72
Server version: 5.6.29-mycat-1.6-RELEASE-20161028204710 MyCat Server (OpenCloundDB)

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

```

##### 2) 测试VIP的故障转移

## 基于LVS实现负载均衡

### 一、LVS介绍

    LVS   Linux Virtual Service   Linux虚拟服务  
    作为Linux内核模块, 基于内核工作

#### 1、调度算法

```
1)  rr    round robin   轮询
2)  wrr     基于权重的轮询   weight 
	会话保持方案:
		a. 会话共享存储 
		b. 换调度算法 

3)  lc       least connection   最少连接
4)  wlc     基于权重的最少连接  默认
5)  sh      source hash    源hash
	根据客户端IP计算hash值，相同hash值的请求转发到同一个后端服务器
	一定程度可以解决会话保持问题 
6)  dh      destination hash   目的地址hash
	根据目的IP地址计算hash值，后续所有请求定位同一个目的IP上 
	适用于后端是缓存服务器，提升缓存命中率

```

### 二、LVS工作模式

    根据内部工作原理:
    	1、NAT模式
    	2、DR模式
    	3、TUN模式

#### 1、NAT模式

![image-20210305113931454](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210305113931454.png)

![image-20210305115437195](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210305115437195.png)

##### 核心要素：

    1、请求、响应都要经过调度器
    2、VIP、DIP要分属不同的网络  
    3、调度器开启路由转发功能 
    4、所有real server的网关要指向DIP
    5、不建议后端real server数量过多 

##### 工作原理

    请求经过调度器时，目的IP会被转换为RIP
    响应经过调度器时，源IP会被转换为VIP

![image-20210305134146478](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210305134146478.png)

![image-20210305134641519](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210305134641519.png)

#### NAT模式案例

![image-20210305135621263](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210305135621263.png)

##### 1) 配置调度器地址

```
[root@director ~]# ip a
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:8f:c3:68 brd ff:ff:ff:ff:ff:ff
    inet 192.168.146.100/24 brd 192.168.146.255 scope global noprefixroute ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe8f:c368/64 scope link 
       valid_lft forever preferred_lft forever
3: ens37: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:8f:c3:72 brd ff:ff:ff:ff:ff:ff
    inet 192.168.177.10/24 brd 192.168.177.255 scope global noprefixroute ens37
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe8f:c372/64 scope link 
       valid_lft forever preferred_lft forever

```

##### 2) 配置real server地址, 注意网关

```
[root@web01 ~]# ip addr show ens33
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:14:78:8e brd ff:ff:ff:ff:ff:ff
    inet 192.168.177.11/24 brd 192.168.177.255 scope global noprefixroute ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe14:788e/64 scope link 
       valid_lft forever preferred_lft forever

[root@web01 ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.177.10  0.0.0.0         UG    100    0        0 ens33
192.168.177.0   0.0.0.0         255.255.255.0   U     100    0        0 ens33

```

##### 3) 在后端real server安装httpd, 建立测试网页

```
[root@web01 ~]# yum install -y httpd 
[root@web01 ~]# rm -rf /etc/httpd/conf.d/welcome.conf 
[root@web01 ~]# echo "web01" > /var/www/html/index.html
[root@web01 ~]# systemctl start httpd

```

##### 4) 安装ipvsadm工具

    [root@director ~]# yum install -y ipvsadm

##### 5) 开启调度器路由转发功能

    [root@director ~]# sed -ri '$ a \net.ipv4.ip_forward = 1' /etc/sysctl.conf 
    [root@director ~]# sysctl -p
    net.ipv4.ip_forward = 1

##### 6) 添加虚拟服务/创建集群

    [root@director ~]# ipvsadm -A -t 192.168.146.100:80 -s rr

    [root@director ~]# ipvsadm -L -n 
    IP Virtual Server version 1.2.1 (size=4096)
    Prot LocalAddress:Port Scheduler Flags
      -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
    TCP  192.168.146.100:80 rr

##### 7) 添加real server信息

    [root@director ~]# ipvsadm -L -n
    IP Virtual Server version 1.2.1 (size=4096)
    Prot LocalAddress:Port Scheduler Flags
      -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
    TCP  192.168.146.100:80 rr
      -> 192.168.177.11:80            Masq    1      0          0         
      -> 192.168.177.12:80            Masq    1      0          0   

##### 8) 测试访问

```
http://192.168.146.100/

[root@director ~]# ipvsadm -L -n -c
IPVS connection entries
pro expire state       source             virtual            destination
TCP 01:30  TIME_WAIT   192.168.146.1:50864 192.168.146.100:80 192.168.177.12:80
TCP 01:31  TIME_WAIT   192.168.146.1:50872 192.168.146.100:80 192.168.177.12:80
TCP 00:32  SYN_RECV    192.168.146.1:50875 192.168.146.100:80 192.168.177.11:80
TCP 01:27  TIME_WAIT   192.168.146.1:50853 192.168.146.100:80 192.168.177.11:80
TCP 01:27  TIME_WAIT   192.168.146.1:50848 192.168.146.100:80 192.168.177.11:80
TCP 01:30  TIME_WAIT   192.168.146.1:50866 192.168.146.100:80 192.168.177.12:80

```

#### 2、DR模式  直接路由模式

    请求经过调度器，响应由real server直接响应给客户端

![image-20210305155522532](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210305155522532.png)

##### 核心要素:

    1、请求经过调度器，响应由real server直接给客户端 
    2、配置real server网关时要写网络中真实的网关，确保real server可正常访问互联网
    3、DIP/VIP要在相同网络中
    4、在所有real server配置VIP
    	arp_ignore=1	只让主机回复关于物理网卡的ARP响应 
    	arp_announce=2	让主机以适当的地址发送响应
    5、real server的操作只能是类linux系统 

![image-20210305163400099](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210305163400099.png)

### DR模式案例

![image-20210305164836650](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210305164836650.png)

##### 1) real server安装httpd, 建立测试文件

##### 2) 在所有real server上配置VIP

```
[root@web01 ~]# ip addr add dev lo 192.168.140.100/32

[root@web01 ~]# ip addr show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet 192.168.140.100/32 scope global lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 

```

##### 3) 在所有real server上修改arp参数

```
[root@web01 ~]# sed -ri '$ a \net.ipv4.conf.all.arp_ignore = 1' /etc/sysctl.conf 
[root@web01 ~]# sed -ri '$a \net.ipv4.conf.all.arp_announce = 2' /etc/sysctl.conf 
[root@web01 ~]# sysctl -p
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 2

```

##### 4) 在调度器配置VIP

    [root@director ~]# ip addr add dev lo 192.168.140.100/32
    [root@director ~]# ip addr show
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
           valid_lft forever preferred_lft forever
        inet 192.168.140.100/32 scope global lo
           valid_lft forever preferred_lft forever
        inet6 ::1/128 scope host 

##### 5) 创建虚拟服务

    [root@director ~]# ipvsadm -A -t 192.168.140.100:80 -s rr
    [root@director ~]# ipvsadm -a -t 192.168.140.100:80 -r 192.168.140.11:80 -g
    [root@director ~]# ipvsadm -a -t 192.168.140.100:80 -r 192.168.140.12:80 -g
     
    [root@director ~]# ipvsadm -L -n
    IP Virtual Server version 1.2.1 (size=4096)
    Prot LocalAddress:Port Scheduler Flags
      -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
    TCP  192.168.140.100:80 rr
      -> 192.168.140.11:80            Route   1      0          0         
      -> 192.168.140.12:80            Route   1      0          0    

##### 6) 测试访问

    http://192.168.140.100/

### 三、持久性连接

    -p [timeout]

    作用: 将客户端一段时间内的请求转发到同一个real server， 解决会话保持问题

<!---->

    [root@director ~]# ipvsadm -E -t 192.168.140.100:80 -s rr -p 300
    [root@director ~]# ipvsadm -L -n
    IP Virtual Server version 1.2.1 (size=4096)
    Prot LocalAddress:Port Scheduler Flags
      -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
    TCP  192.168.140.100:80 rr persistent 300
      -> 192.168.140.11:80            Route   1      0          1         
      -> 192.168.140.12:80            Route   1      0          0    


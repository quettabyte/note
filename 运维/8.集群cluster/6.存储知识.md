



## 存储知识

### 一、存储类型

```
根据存储的架构不同: 
	1、DAS	直接附加存储
	2、NAS	网络附加存储
	3、SAN	存储区域网络
```

#### 1、DAS存储 

```
Direct Attachment Storage   
直接附加存储

通过数据总线将存储连接到主板上，例如磁盘、U盘、移动硬盘、RAID、LVM
优势: 数据读写快
劣势: 不便于共享数据
```

```
磁盘接口:
	SATA, SAS   6G/s
	M.2、pcie
```

#### 2、NAS存储

```
Network Attach Storage
网络附加存储 

基于文件系统的共享

借助nfs协议、cifs协议将存储空间共享
	nfs: 用于在Linux间共享数据
	cifs: 用于在windows间共享数据
	
优势: 便于共享数据

NAS存储的实现:
	1、服务器  pc server
	2、NAS存储设备
```

![image-20210310111344566](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210310111344566.png)



#### 3、SAN存储 

```
Storage Area Network    
存储区域网络

基于块级别的共享

作用: 便于共享数据、用于共享存储 

通过iSCSI协议共享存储空间, 共享块设备

SAN存储通过iscsi协议共享存储空间，业务服务器连接上存储后，业务服务器上会被映射出以sdX开头的磁盘，业务服务器可以把这块盘作为本地盘进行格式化挂载使用 
```



![image-20210310114023705](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210310114023705.png)



![image-20210310114115251](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210310114115251.png)



```
SAN存储架构:
	1、FC SAN	光纤
		业务服务器与存储设备间使用光纤网络进行连接
		优势：速度快
		劣势：成本高
		
	2、IP SAN	以太网
		业务服务器与存储设备间使用IP网络进行连接
```

```
SAN存储的实现: 
	专业的存储设备
```





### 二、配置IP SAN

![image-20210310140322830](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210310140322830.png)

#### 1、配置SAN存储共享存储空间

##### 1) 创建逻辑卷

```
[root@san_storage ~]# pvcreate /dev/sdb
[root@san_storage ~]# vgcreate test /dev/sdb
[root@san_storage ~]# lvcreate -L +10G -n data test

[root@san_storage ~]# lvscan 
  ACTIVE            '/dev/test/data' [10.00 GiB] inherit

```

##### 2) 安装targetcli软件

```
[root@san_storage ~]# yum install -y targetcli 
```

##### 3) 创建后端存储 backstore

```
[root@san_storage ~]# targetcli
    
/> /backstores/block create name=testdisk dev=/dev/test/data 
```

##### 4) 设置iscsi共享名称

```
iscsi共享名称格式: 
	iqn.YYYY-MM.反域名称:<自定义名称>
		iqn.2021-03.com.linux:hw-disk-web
```

```
/> /iscsi create iqn.2021-03.com.linux:huawei-disk-web
```

##### 5）绑定后端存储

```
/> /iscsi/iqn.2021-03.com.linux:huawei-disk-web/tpg1/luns create /backstores/block/testdisk 
```

##### 6) 设置ACL，设置客户端iscsi名称

```
/> /iscsi/iqn.2021-03.com.linux:huawei-disk-web/tpg1/acls create iqn.2021-03.com.linux:web-app
```

##### 7) 设置监听的IP地址及端口

```
/> /iscsi/iqn.2021-03.com.linux:huawei-disk-web/tpg1/portals delete ip_address=0.0.0.0 ip_port=3260
/> /iscsi/iqn.2021-03.com.linux:huawei-disk-web/tpg1/portals create ip_address=192.168.140.12

```

```
[root@san_storage ~]# systemctl start target
[root@san_storage ~]# systemctl enable target

[root@san_storage ~]# netstat -antp | grep 3260
tcp        0      0 192.168.140.12:3260     0.0.0.0:*               LISTEN      -  
```



#### 2、业务服务器连接SAN存储

##### 1) 安装iscsi-initiator客户端工具

```
[root@server01 ~]# yum install -y iscsi-initiator-utils
```

##### 2) 修改客户端iscsi名称 

```
[root@server01 ~]# vim /etc/iscsi/initiatorname.iscsi
InitiatorName=iqn.2021-03.com.linux:web-app
```

##### 3) 探索存储

```
[root@server01 ~]# iscsiadm -m discovery -t st -p 192.168.140.12:3260 
192.168.140.12:3260,1 iqn.2021-03.com.linux:huawei-disk-web
```

##### 4) 连接存储

```
[root@server01 ~]# iscsiadm -m node -T iqn.2021-03.com.linux:huawei-disk-web -p 192.168.140.12:3260 -l 

[root@server01 ~]# lsblk 
NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda               8:0    0   20G  0 disk 
├─sda1            8:1    0  500M  0 part /boot
└─sda2            8:2    0 19.5G  0 part 
  ├─centos-root 253:0    0 17.5G  0 lvm  /
  └─centos-swap 253:1    0    2G  0 lvm  [SWAP]
sdb               8:16   0   10G  0 disk 

```

##### 5) 使用存储

```
[root@server01 ~]# mkfs -t ext4 /dev/sdb1 
[root@server01 ~]# vim /etc/fstab 
/dev/sdb1	/webdata	ext4	defaults,_netdev	0 0

[root@server01 ~]# mount -a

[root@server01 ~]# df -hT
/dev/sdb1               ext4      976M  2.6M  907M   1% /webdata

```



### 三、多路径 multi-path

```
在FC SAN环境中，业务与SAN存储之间采用多路径方式进行连接时，业务服务器会被映射出多个磁盘，为避免混淆，可以使用多路径软件来标识磁盘
```

#### 1、安装多路径软件

```
[root@server01 ~]# yum install -y device-mapper-multipath 
```

#### 2、编辑multipath配置文件

```
[root@server01 ~]# cat /etc/multipath.conf
defaults {
    user_friendly_names yes
}

blacklist {
    devnode "sda"
}

```

#### 3、启动多路径服务 

```
[root@server01 ~]# systemctl start multipathd.service 
[root@server01 ~]# systemctl enable multipathd.service
```

#### 4、验证

```
[root@server01 ~]# multipath -ll
mpatha (3600140563def02c20fb4312ad8cf9f80) dm-2 LIO-ORG ,testdisk        
size=10G features='0' hwhandler='0' wp=rw
|-+- policy='service-time 0' prio=1 status=active
| `- 4:0:0:0 sdb 8:16 active ready running
`-+- policy='service-time 0' prio=1 status=enabled
  `- 5:0:0:0 sdc 8:32 active ready running

[root@server01 ~]# lsblk 
NAME            MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINT
sda               8:0    0   20G  0 disk  
├─sda1            8:1    0  500M  0 part  /boot
└─sda2            8:2    0 19.5G  0 part  
  ├─centos-root 253:0    0 17.5G  0 lvm   /
  └─centos-swap 253:1    0    2G  0 lvm   [SWAP]
sdb               8:16   0   10G  0 disk  
└─mpatha        253:2    0   10G  0 mpath 
  └─mpatha1     253:3    0    1G  0 part  
sdc               8:32   0   10G  0 disk  
└─mpatha        253:2    0   10G  0 mpath 
  └─mpatha1     253:3    0    1G  0 part  

```
















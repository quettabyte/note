## iptables防火墙

### 一、四表五链

### 1、防火墙类型

```
硬件防火墙
软件防火墙

作用: 
	1、实现数据过滤
		基本五元素:
			源IP、目的IP、协议、源端口、目的端口
	2、nat地址转换, 发布虚拟化环境中的服务 
```

#### 2、防火墙工具

```
iptables
firewall-cmd
	依赖于firewalld服务
```

#### 3、四表五链

```
1、filter	数据过滤
	INPUT, FORWARD, OUTPUT
	
2、nat		地址转换
	PREROUTING， INPUT, OUTPUT, POSTROUTING
	
3、mangle	数据标记
	PRETOUTING， INPUT, FORWARD, OUTPUT, POSTROUTING
	
4、raw		数据跟踪
	PREROUTING, OUTPUT
	
```



### 二、规则管理操作

#### 1、查看规则 

```
[root@rabbit01 ~]# iptables -nL
```

##### 常用选项：

##### 1) -t  指定表名

```
[root@rabbit01 ~]# iptables -t nat -nL
	默认为filter表
```

##### 2) --line-numbers	显示规则行号

```
[root@rabbit01 ~]# iptables -nL --line-numbers
```

##### 3) -v	显示规则计数器

```
[root@rabbit01 ~]# iptables -nL --line-numbers -v
```



#### 2、添加规则

```
格式:

# iptables {-A|-I} 链名 匹配数据的条件 -j 行为

	-A：追加
	-I：插入
		-I 链名 [行号]
			-I INPUT 2
			-I INPUT
			
	-j {ACCEPT|DROP|REJECT}
```

##### 匹配数据的条件

##### 1) -s	源地址

```
-s 192.168.1.1
-s 192.168.1.0/24
! -s 192.168.1.1
```

##### 2) -d 	目的地址

```
-d 192.168.1.1
-d 192.168.1.0/24
! -d 192.168.1.1
```

##### 3) -p	协议

```
-p {tcp|udp|icmp}
```

```
-p tcp
	-p tcp --sport 80
	-p tcp --sport 80:100
	
	-p tcp --dport 22
	-p tcp --dport 22:100
```

```
-p udp
	-p udp --sport 80
	-p udp --sport 80:100
	
	-p udp --dport 22
	-p udp --dport 22:100
```

```
-p icmp
   --icmp-type {8|0}
   		8: ping request
   		0: ping reply 
```



##### 4) -i  指定数据流入的网卡

```
-i ens33 
```

##### 5) -o  指定数据流出的网卡

```
-o ens33
```



#### 示例：

##### 1、只允许windows连接ssh，拒绝所有

```
[root@rabbit01 ~]# iptables -A INPUT -s 192.168.140.1 -d 192.168.140.10 -p tcp --dport 22 -j ACCEPT
[root@rabbit01 ~]# iptables -A INPUT -j DROP
```

##### 2、放行http服务的访问

```
[root@rabbit01 ~]# iptables -I INPUT -s 192.168.140.11 -d 192.168.140.10 -p tcp --dport 80 -j ACCEPT
[root@rabbit01 ~]# iptables -I INPUT 2 -s 192.168.140.1 -d 192.168.140.10 -p tcp --dport 80 -j ACCEPT

```

##### 3、放行MySQL服务

```
[root@rabbit01 ~]# iptables -I INPUT -s 192.168.140.11 -d 192.168.140.10 -p tcp --dport 3306 -j ACCEPT
```

##### 4、放行ping

```
[root@rabbit01 ~]# iptables -I INPUT 4 -s 192.168.140.11 -d 192.168.140.10 -p icmp --icmp-type 8 -j ACCEPT
```

```
[root@rabbit01 ~]# iptables -I INPUT 4 -s 192.168.140.11 -d 192.168.140.10 -p icmp --icmp-type 0 -j ACCEPT
```

```
[root@rabbit01 ~]# iptables -I INPUT 7 -i lo -j ACCEPT
```

##### 5、放行HTTP源

```
[root@rabbit01 ~]# iptables -I INPUT -d 192.168.140.10 -p tcp --sport 80 -j ACCEPT
[root@rabbit01 ~]# iptables -I INPUT -d 192.168.140.10 -p tcp --sport 443 -j ACCEPT 
[root@rabbit01 ~]# iptables -I INPUT -d 192.168.140.10 -p udp --sport 53 -j ACCEPT
```





#### 3、保存规则 

```
[root@rabbit01 ~]# iptables-save > /opt/iptables_rule
```



#### 4、恢复规则

```
[root@rabbit01 ~]# iptables-restore < /opt/iptables_rule 
```



#### 5、删除规则

```
[root@rabbit01 ~]# iptables -F 
[root@rabbit01 ~]# iptables -D INPUT 5
```



#### 6、修改规则 

```
[root@rabbit01 ~]# iptables -R INPUT 4 -d 192.168.140.10 -p icmp --icmp-type 0 -j ACCEPT
```



#### 7、multiport模块	多端口

```
支持以逗号隔开的方式，写多个不同的端口

-m multiport
	--sports
	--dports
```

```
[root@rabbit01 ~]# iptables -I INPUT 2 -d 192.168.140.10 -p tcp -m multiport --sports 80,443 -j ACCEPT
```



#### 8、iprange模块

```
支持写多个源IP、目的IP

iprange match options:
[!] --src-range ip[-ip]    Match source IP in the specified range
[!] --dst-range ip[-ip]    Match destination IP in the specified range
```

```
[root@rabbit01 ~]# iptables -I INPUT -m iprange --src-range 10.1.1.1-10.1.1.100 -d 192.168.140.10 -p tcp --dport 22 -j ACCEPT
```



#### 9、state模块

```
根据数据连接的状态进行过滤

支持的状态：
	1、NEW	服务的首次访问 
	2、ESTABLISHED
		a)	服务的后续访问
		b) 	响应数据 
	3、RELATED	相关联的连接， 针对FTP服务
```

```
[root@rabbit01 ~]# iptables -I OUTPUT -j DROP
[root@rabbit01 ~]# iptables -I OUTPUT -s 192.168.140.10 -m state --state ESTABLISHED -j ACCEPT 
```

##### 放行ftp服务访问

```
[root@rabbit01 ~]# iptables -I INPUT -s 192.168.140.11 -d 192.168.140.10 -p tcp --dport 20:21 -j ACCEPT 
[root@rabbit01 ~]# iptables -I INPUT 2 -s 192.168.140.11 -d 192.168.140.10 -m state --state 
RELATED,ESTABLISHED -j ACCEPT

[root@rabbit01 ~]# modprobe ip_nat_ftp			//加载内核模块
[root@rabbit01 ~]# modprobe ip_conntrack_ftp

```



#### 10、forward链使用

```
[root@nat_device ~]# iptables -A FORWARD -p icmp -j DROP
```





### 三、NAT表应用

```
PREROUTING		路由前的操作
POSTROUTING		路由后的操作
```

```
NAT技术:
	网络地址转换
	
源地址转换	SNAT  source NAT
	作用: 客户端访问互联网
	
目的地址转换
	作用: 发布服务
```



#### 1、POSTROUTING-----SNAT

```
作用: 客户端访问互联网

	-j SNAT --to-source  公网IP
	-j MASQUERADE
```

```
[root@nat_device ~]# iptables -t nat -A POSTROUTING -s 172.16.10.0/24 -j MASQUERADE
```

```
[root@nat_device ~]# iptables -t nat -A POSTROUTING -s 172.16.10.0/24 -j SNAT --to-source 20.20.20.254
```



#### 2、PREROUTING-----DNAT

```
作用：发布服务 
	-j DNAT --to-destination 私网IP 
```

```
注意：避免端口冲突
```

```
[root@nat_device ~]# iptables -t nat -A PREROUTING -d 20.20.20.254 -p tcp --dport 80 -j DNAT --to-destination 172.16.10.1:80
```

```
[root@nat_device ~]# iptables -t nat -A PREROUTING -d 20.20.20.254 -p tcp --dport 33333  -j DNAT --to-destination 172.16.10.1:22
```



### 四、mangle表

```
作用：数据打标记
```

```
[root@node01 ~]# iptables -t mangle -A PREROUTING -s 172.16.10.254 -d 172.16.10.1 -p icmp -j MARK --set-mark 66
[root@node01 ~]# iptables -A INPUT -m mark --mark 66 -j DROP

```


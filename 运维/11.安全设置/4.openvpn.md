### 一、vpn技术

```
Virtual Private Network 
虚拟专用网络

跨互联网的通信的方式：
	1、专线
	2、VPN

作用: 
	跨互联网的通信
	适用于出差人员、在家办公人员、总分公司间的通信
	
核心技术:
	1、隧道技术  tunnel
	2、确保数据的安全传输
		a) 数据安全性	加密、解密
		b) 数据完整性	数据校验/md5/sha
		c) 验证隧道的身份
			预共享密钥
			证书
```

```
vpn类型:
	1、site-to-site vpn	站点到站点的VPN
		IPSEC VPN、MPLS VPN
	2、remote-access VPN	远程访问VPN
		ssl vpn、l2tp vpn
```



### 二、openvpn配置

![image-20210330115102571](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210330115102571.png)

#### 1、安装openvpn软件

```
[root@vpn_server ~]# cat /etc/yum.repos.d/epel.repo
[epel]
name=epel
baseurl=https://repo.huaweicloud.com/epel/7Server/x86_64/
enabled=1
gpgcheck=0

[root@vpn_server ~]# yum install openvpn easy-rsa 

```

#### 2、将easy-rsa存放脚本相关文件目录复制到 openvpn目录下

```
[root@vpn_server ~]# cp -r /usr/share/easy-rsa/ /etc/openvpn/
[root@vpn_server ~]# ls /etc/openvpn/
client  easy-rsa  server

```

#### 3、复制openvpn的配置文件

```
[root@vpn_server ~]# cp /usr/share/doc/openvpn-2.4.10/sample/sample-config-files/server.conf /etc/openvpn/
[root@vpn_server ~]# ls /etc/openvpn/
client  easy-rsa  server  server.conf
```

#### 4、复制证书信息的变量文件

```
[root@vpn_server ~]# cp /usr/share/doc/easy-rsa-3.0.8/vars.example /etc/openvpn/easy-rsa/3.0/vars
```

#### 5、编辑vars文件，记录证书信息

```
[root@vpn_server ~]# vim /etc/openvpn/easy-rsa/3.0/vars

set_var EASYRSA_REQ_COUNTRY     "cn"
set_var EASYRSA_REQ_PROVINCE    "cn"
set_var EASYRSA_REQ_CITY        "bj"
set_var EASYRSA_REQ_ORG "bj"
set_var EASYRSA_REQ_EMAIL       "bj@qq.com"
set_var EASYRSA_REQ_OU          "bj"

```

#### 6、生成存放证书的目录

```
[root@vpn_server ~]# cd /etc/openvpn/easy-rsa/3.0
[root@vpn_server 3.0]# ./easyrsa init-pki
```

#### 7、构建CA

```
[root@vpn_server 3.0]# ./easyrsa build-ca

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa/3.0.8/vars
Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017

Enter New CA Key Passphrase: 
Re-Enter New CA Key Passphrase: 
Generating RSA private key, 2048 bit long modulus
.....................................................................................................................................................+++
............+++
e is 65537 (0x10001)
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Common Name (eg: your user, host, or server name) [Easy-RSA CA]:vpn_server.linux.com

CA creation complete and you may now import and sign cert requests.
Your new CA certificate file for publishing is at:
/etc/openvpn/easy-rsa/3.0/pki/ca.crt

```

#### 8、生成DH算法需要的密钥 

```
[root@vpn_server 3.0]# ./easyrsa gen-dh
```

#### 9、生成VPN服务器需要的证书

```
[root@vpn_server 3.0]# ./easyrsa gen-req server 
Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa/3.0.8/vars
Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017
Generating a 2048 bit RSA private key
............................+++
..+++
writing new private key to '/etc/openvpn/easy-rsa/3.0/pki/easy-rsa-17802.0nQ4Fx/tmp.EOTaMv'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
Verify failure
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Common Name (eg: your user, host, or server name) [server]:vpn_server.linux.com   

Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa/3.0/pki/reqs/server.req
key: /etc/openvpn/easy-rsa/3.0/pki/private/server.key

```

#### 10、签署VPN服务的证书

```
[root@vpn_server 3.0]# ./easyrsa sign-req server server
You are about to sign the following certificate.
Please check over the details shown below for accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
source or that you have verified the request checksum with the sender.

Request subject, to be signed as a server certificate for 825 days:

subject=
    commonName                = vpn_server.linux.com


Type the word 'yes' to continue, or any other input to abort.
  Confirm request details: yes
Using configuration from /etc/openvpn/easy-rsa/3.0/pki/easy-rsa-17846.1oCc6f/tmp.oYeaJM
Enter pass phrase for /etc/openvpn/easy-rsa/3.0/pki/private/ca.key:
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
commonName            :ASN.1 12:'vpn_server.linux.com'
Certificate is to be certified until Jul  3 06:13:23 2023 GMT (825 days)

Write out database with 1 new entries
Data Base Updated

Certificate created at: /etc/openvpn/easy-rsa/3.0/pki/issued/server.crt

```

#### 11、生成VPN客户端证书

```
[root@vpn_server 3.0]# ./easyrsa build-client-full vpnclient

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa/3.0.8/vars
Using SSL: openssl OpenSSL 1.0.2k-fips  26 Jan 2017
Generating a 2048 bit RSA private key
.................................................................................................+++
...................+++
writing new private key to '/etc/openvpn/easy-rsa/3.0/pki/easy-rsa-17934.yG9J3L/tmp.yIVWrc'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
Using configuration from /etc/openvpn/easy-rsa/3.0/pki/easy-rsa-17934.yG9J3L/tmp.nDm7mO
Enter pass phrase for /etc/openvpn/easy-rsa/3.0/pki/private/ca.key:
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
commonName            :ASN.1 12:'vpnclient'
Certificate is to be certified until Jul  3 06:15:36 2023 GMT (825 days)

Write out database with 1 new entries
Data Base Updated

[root@vpn_server 3.0]# ls pki/issued/
server.crt  vpnclient.crt
[root@vpn_server 3.0]# ls pki/private/
ca.key  server.key  vpnclient.key

```

#### 12、编辑VPN配置文件，启动VPN服务

```
[root@vpn_server ~]# vim /etc/openvpn/server.conf 

local 192.168.140.10
port 1194
proto udp

dev tun

ca /etc/openvpn/easy-rsa/3.0/pki/ca.crt
cert /etc/openvpn/easy-rsa/3.0/pki/issued/server.crt
key /etc/openvpn/easy-rsa/3.0/pki/private/server.key  # This file should be kept secret
dh /etc/openvpn/easy-rsa/3.0/pki/dh.pem

//用于向vpn客户端分配IP
//不能与内网现有网段冲突！！！
server 10.1.88.0 255.255.255.0

//限制客户端可以通信的内网地址
push "route 192.168.146.0 255.255.255.0"

log         /var/log/openvpn.log

```

```
[root@vpn_server ~]# systemctl start openvpn@server
Enter Private Key Password: *********
[root@vpn_server ~]# systemctl enable openvpn@server

```

```
[root@vpn_server ~]# netstat -tunlp | grep 1194
udp        0      0 192.168.140.10:1194     0.0.0.0:*                           18129/openvpn    
```

#### 13、配置隧道分离

```
[root@vpn_server ~]# cat /etc/sysctl.conf
net.ipv4.ip_forward = 1

[root@vpn_server ~]# sysctl -p
net.ipv4.ip_forward = 1

[root@vpn_server ~]# iptables -t nat -A POSTROUTING -s 10.1.88.0/24 -j MASQUERADE 
```





#### windows客户端连接VPN服务器

##### 1、安装openvpn客户端软件

##### 2、从服务器上下载ca.crt, client.crt, client.key，拷贝到openvpn安装目录下的config目录中

##### 3、编辑openvpn客户端配置文件

```
client
dev tun
proto udp

remote 192.168.140.10 1194

ca ca.crt
cert vpnclient.crt
key vpnclient.key

# tls-auth ta.key 1

```


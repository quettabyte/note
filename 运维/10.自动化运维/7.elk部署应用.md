## ELK统一日志分析

### 一、ELK介绍

```
作用: 统一日志分析

E: Elasticsearch	存储日志
L: Logstash, 搜集、过滤处理日志
K: kibana	提供web界面
```

![image-20210325093611483](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210325093611483.png)



#### ES集群特性：

```
1、自动发现
2、自主选举master节点, master节点宕机后，会自动重新选举master
3、主从复制、提升高可用；基于同步进行数据复制
4、加入新节点，数据会自动重新分布、提升性能
```

#### ES集群状态:

```
1、green
	主数据、复制数据均正常
	
2、yellow
	主数据正常，不是所有的复制数据正常
	
3、red
	主数据不正常
```







### 二、elk7.6.2安装部署

```
环境描述：
192.168.183.10		es-master.linux.com		jdk/elasticsearch/kibana/logstash
192.168.183.11		es-node01.linux.com		jdk/elasticsearch
192.168.183.12		es-node02.linux.com		jdk/elasticsearch
192.168.183.13		web_server.linux.com	httpd/filebeat
```

#### 1、关闭防火墙、SELinux；添加主机名解析

```
[root@es-master ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.183.10	es-master.linux.com	es-master
192.168.183.11	es-node01.linux.com	es-node01
192.168.183.12	es-node02.linux.com	es-node02

[root@es-master ~]# rsync -av /etc/hosts root@192.168.183.11:/etc/hosts
[root@es-master ~]# rsync -av /etc/hosts root@192.168.183.12:/etc/hosts
```

#### 2、三个ES节点分别安装jdk15

```
[root@es-master ~]# tar xf jdk-15.0.2_linux-x64_bin.tar.gz -C /usr/local/
[root@es-master ~]# vim /etc/profile
export JAVA_HOME=/usr/local/jdk-15.0.2/
export PATH=$PATH:$JAVA_HOME/bin
[root@es-master ~]# source /etc/profile
[root@es-master ~]# java -version
java version "15.0.2" 2021-01-19
Java(TM) SE Runtime Environment (build 15.0.2+7-27)
Java HotSpot(TM) 64-Bit Server VM (build 15.0.2+7-27, mixed mode, sharing)

[root@es-master ~]# scp -r /usr/local/jdk-15.0.2/ root@192.168.183.11:/usr/local/
[root@es-master ~]# scp -r /usr/local/jdk-15.0.2/ root@192.168.183.12:/usr/local/

[root@es-master ~]# scp /etc/profile root@192.168.183.11:/etc/profile 
[root@es-master ~]# scp /etc/profile root@192.168.183.12:/etc/profile
```

#### 3、操作系统优化

```
[root@es-master ~]# vim /etc/security/limits.conf 
* soft nofile 65536
* hard nofile 65536
* soft noproc 2048
* hard noproc 4096

[root@es-master ~]# cat /etc/security/limits.d/20-nproc.conf
# Default limit for number of user's processes to prevent
# accidental fork bombs.
# See rhbz #432903 for reasoning.

*          soft    nproc     4096
root       soft    nproc     unlimited

[root@es-master ~]# vim /etc/sysctl.conf 
vm.max_map_count=262144
fs.file-max=655360

[root@es-master ~]# sysctl -p
vm.max_map_count = 262144
fs.file-max = 655360

[root@es-master ~]# rsync -av /etc/sysctl.conf root@192.168.183.11:/etc/sysctl.conf 
[root@es-master ~]# rsync -av /etc/sysctl.conf root@192.168.183.12:/etc/sysctl.conf 
[root@es-master ~]# rsync -av /etc/security/limits.conf root@192.168.183.11:/etc/security/limits.conf 
[root@es-master ~]# rsync -av /etc/security/limits.conf root@192.168.183.12:/etc/security/limits.conf 

```

#### 4、创建elk用户, 规划软件安装目录

```
elasticsearch不允许以root用户启动, 需要创建普通用户为后续es安装配置

[root@es-master ~]# useradd elk

[root@es-master ~]# mkdir /app/elk -p
[root@es-master ~]# tar xf elasticsearch-7.6.2-linux-x86_64.tar.gz -C /app/elk/
[root@es-master ~]# tar xf kibana-7.6.2-linux-x86_64.tar.gz -C /app/elk/
[root@es-master ~]# tar xf logstash-7.6.2.tar.gz -C /app/elk/

[root@es-master ~]# chown -R elk.elk /app/elk/
```

#### 5、配置elasticsearch

##### 1) es-master主节点配置

```

[root@es-master ~]# su - elk
[elk@es-master ~]$ mkdir /app/elk/elasticsearch-7.6.2/data

[elk@es-master ~]$ cp /app/elk/elasticsearch-7.6.2/config/elasticsearch.yml /app/elk/elasticsearch-7.6.2/config/elasticsearch.yml.bak
[elk@es-master ~]$ vim /app/elk/elasticsearch-7.6.2/config/elasticsearch.yml

cluster.name: es
node.name: es-master

path.data: /app/elk/elasticsearch-7.6.2/data/
path.logs: /app/elk/elasticsearch-7.6.2/logs

network.host: 192.168.183.10
http.port: 9200
transport.tcp.port: 9300

discovery.seed_hosts: ["192.168.183.10:9300", "192.168.183.11:9300","192.168.183.12:9300"]
cluster.initial_master_nodes: ["192.168.183.10:9300"]

node.master: true
node.data: true
node.ingest: false
node.ml: false
cluster.remote.connect: false

http.cors.enabled: true
http.cors.allow-origin: true
```

##### 2) es-node01从节点配置

```
[root@es-node01 ~]# useradd elk
[root@es-node01 ~]# mkdir -p /app/elk
[root@es-node01 ~]# tar xf elasticsearch-7.6.2-linux-x86_64.tar.gz -C /app/elk/
[root@es-node01 ~]# chown -R elk.elk /app/elk/

[root@es-node01 ~]# su - elk
[elk@es-node01 ~]$ vim /app/elk/elasticsearch-7.6.2/config/elasticsearch.yml 

cluster.name: es
node.name: es-node01
path.data: /app/elk/elasticsearch-7.6.2/data
path.logs: /app/elk/elasticsearch-7.6.2/logs
network.host: 192.168.183.11
http.port: 9200
transport.tcp.port: 9300
discovery.seed_hosts: ["192.168.183.10:9300", "192.168.183.11:9300", "192.168.183.12:9300"]
cluster.initial_master_nodes: ["192.168.183.10:9300"]

node.master: false
node.data: true
node.ingest: false
node.ml: false
cluster.remote.connect: false

http.cors.enabled: true
http.cors.allow-origin: "*"
```

##### 3) es-node02从节点配置

```
[root@es-node02 ~]# useradd elk
[root@es-node02 ~]# mkdir -p /app/elk
[root@es-node02 ~]# tar xf elasticsearch-7.6.2-linux-x86_64.tar.gz -C /app/elk/
[root@es-node02 ~]# chown -R elk.elk /app/elk/

[root@es-node02 ~]# su - elk
[elk@es-node02 ~]$ mkdir /app/elk/elasticsearch-7.6.2/data

[elk@es-node02 ~]$ vim /app/elk/elasticsearch-7.6.2/config/elasticsearch.yml 

cluster.name: es
node.name: es-node02
path.data: /app/elk/elasticsearch-7.6.2/data
path.logs: /app/elk/elasticsearch-7.6.2/logs
network.host: 192.168.183.12
http.port: 9200
transport.tcp.port: 9300
discovery.seed_hosts: ["192.168.183.10:9300", "192.168.183.11:9300","192.168.183.12:9300"]
cluster.initial_master_nodes: ["192.168.183.10:9300"]

node.master: false
node.data: true
node.ingest: false
node.ml: false
cluster.remote.connect: false

http.cors.enabled: true
http.cors.allow-origin: "*"
```

#### 6、启动elasticsearch

```
[elk@es-master ~]$ /app/elk/elasticsearch-7.6.2/bin/elasticsearch -d
[elk@es-master ~]$ 
[elk@es-master ~]$ ps -elf | grep java
0 S elk       11016      1 99  80   0 - 1048383 futex_ 23:17 pts/0  00:00:07 /usr/local/jdk-15.0.2//bin/java -Des.networkaddress.cache.ttl=60 -Des.networkaddress.cache.negative.ttl=10 -XX:+AlwaysPreTouch -Xss1m -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djna.nosys=true -XX:-OmitStackTraceInFastThrow -Dio.netty.noUnsafe=true -Dio.netty.noKeySetOptimization=true -Dio.netty.recycler.maxCapacityPerThread=0 -Dio.netty.allocator.numDirectArenas=0 -Dlog4j.shutdownHookEnabled=false -Dlog4j2.disable.jmx=true -Djav.locale.providers=COMPAT -Xms1g -Xmx1g -XX:+UseG1GC -XX:G1ReservePercent=25 -XX:InitiatingHeapOccupancyPercent=30 -Djava.io.tmpdir=/tmp/elasticsearch-13098864547640209927 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=data -XX:ErrorFile=logs/hs_err_pid%p.log -Xlog:gc*,gc+age=trace,safepoint:file=logs/gc.log:utctime,pid,tags:filecount=32,filesize=64m -XX:MaxDirectMemorySize=536870912 -Des.path.home=/app/elk/elasticsearch-7.6.2 -Des.path.conf=/app/elk/elasticsearch-7.6.2/config -Des.distribution.flavor=default -Des.distribution.type=tar -Des.bundled_jdk=true -cp /app/elk/elasticsearch-7.6.2/lib/* org.elasticsearch.bootstrap.Elasticsearch -d
```

#### 7、检测elasticsearch集群状态 

```
[elk@es-master ~]$ curl -X GET "http://192.168.183.10:9200/_cluster/health?pretty"
{
  "cluster_name" : "es",
  "status" : "green",
  "timed_out" : false,
  "number_of_nodes" : 1,
  "number_of_data_nodes" : 1,
  "active_primary_shards" : 0,
  "active_shards" : 0,
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 0,
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 100.0
}

status: green表示正常状态
```

```
[elk@es-master ~]$ curl -X GET "http://192.168.183.11:9200/_cluster/health?pretty"
{
  "cluster_name" : "es",
  "status" : "green",
  "timed_out" : false,
  "number_of_nodes" : 3,
  "number_of_data_nodes" : 3,
  "active_primary_shards" : 0,
  "active_shards" : 0,
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 0,
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 100.0
}
```

```
[elk@es-master ~]$ curl -X GET "http://192.168.183.12:9200/_cluster/health?pretty"
{
  "cluster_name" : "es",
  "status" : "green",
  "timed_out" : false,
  "number_of_nodes" : 3,
  "number_of_data_nodes" : 3,
  "active_primary_shards" : 0,
  "active_shards" : 0,
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 0,
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 100.0
}
```

#### 8、安装配置kibana

```
[elk@es-master ~]$ cp /app/elk/kibana-7.6.2-linux-x86_64/config/kibana.yml /app/elk/kibana-7.6.2-linux-x86_64/config/kibana.yml.bak
[elk@es-master ~]$ vim /app/elk/kibana-7.6.2-linux-x86_64/config/kibana.yml
server.port: 5601
server.host: "192.168.183.10"
elasticsearch.hosts: ["http://192.168.183.10:9200"]
```

#### 9、启动kibana

```
[elk@es-master ~]$ nohup /app/elk/kibana-7.6.2-linux-x86_64/bin/kibana &

[elk@es-master ~]$ ps -elf | grep kibana
0 R elk       11161  10907 99  80   0 - 330192 -     23:24 pts/0    00:00:14 /app/elk/kibana-7.6.2-linux-x86_64/bin/../node/bin/node /app/elk/kibana-7.6.2-linux-x86_64/bin/../src/cli

[elk@es-master ~]$ netstat -tunlp | grep 5601
tcp        0      0 192.168.183.10:5601     0.0.0.0:*               LISTEN      11161/node    
```

#### 10、在web_server上安装配置filebeat, 对httpd访问日志进行采集

```
[root@web_server ~]# tar xf filebeat-7.6.2-linux-x86_64.tar.gz -C /usr/local/

[root@web_server ~]# cp /usr/local/filebeat-7.6.2-linux-x86_64/filebeat.yml /usr/local/filebeat-7.6.2-linux-x86_64/filebeat.yml.bak

[root@web_server ~]# vim /usr/local/filebeat-7.6.2-linux-x86_64/filebeat.yml

#=========================== Filebeat inputs =============================
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/httpd/access_log
    
#============================== Dashboards =====================================
setup.dashboards.enabled: false

#============================== Kibana =====================================
setup.kibana:
  host: "192.168.183.10:5601"

#-------------------------- Elasticsearch output ------------------------------
#output.elasticsearch:
  # Array of hosts to connect to.
#  hosts: ["localhost:9200"]

#----------------------------- Logstash output --------------------------------
output.logstash:
  hosts: ["192.168.183.10:5044"]
```

#### 11、启动filebeat

```
[root@web_server ~]# cd /usr/local/filebeat-7.6.2-linux-x86_64/
[root@web_server filebeat-7.6.2-linux-x86_64]# nohup ./filebeat -c filebeat.yml &

[root@web_server filebeat-7.6.2-linux-x86_64]# ps -elf | grep file
4 S root      11289  11041  1  80   0 - 170375 futex_ 23:34 pts/0   00:00:00 ./filebeat -c filebeat.yml
```

#### 12、安装配置logstash

```
[root@es-master ~]# cp /app/elk/logstash-7.6.2/config/logstash-sample.conf /app/elk/logstash-7.6.2/config/logstash.conf


[root@es-master ~]# cat /app/elk/logstash-7.6.2/config/logstash.conf 

input {
  beats {
    port => 5044
  }
}

filter {
   grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
   }
}


output {
  elasticsearch {
    hosts => ["http://192.168.183.10:9200"]
    index => "httpd-access-%{+YYYY.MM.dd}"
    #user => "elastic"
    #password => "changeme"
  }
}


[root@es-master ~]# vim /app/elk/logstash-7.6.2/config/jvm.options 

#-XX:+UseConcMarkSweepGC
#-XX:CMSInitiatingOccupancyFraction=75
#-XX:+UseCMSInitiatingOccupancyOnly
```

#### 13、启动logstash

```
[root@es-master ~]# nohup /app/elk/logstash-7.6.2/bin/logstash -f /app/elk/logstash-7.6.2/config/logstash.conf &

[root@es-master ~]# ps -elf | grep logstash
4 S root      11474   1135 79  80   0 - 1220996 futex_ 23:41 pts/0  00:01:04 /usr/local/jdk-15.0.2//bin/java -Xms1g -Xmx1g -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djruby.compile.invokedynamic=true -Djruby.jit.threshold=0 -Djruby.regexp.interruptible=true -XX:+HeapDumpOnOutOfMemoryError -Djava.security.egd=file:/dev/urandom -Dlog4j2.isThreadContextMapInheritable=true -cp /app/elk/logstash-7.6.2/logstash-core/lib/jars/animal-sniffer-annotations-1.14.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/commons-codec-1.13.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/commons-compiler-3.1.0.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/error_prone_annotations-2.0.18.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/google-java-format-1.1.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/gradle-license-report-0.7.1.jar:/app/elk/logstas-7.6.2/logstash-core/lib/jars/guava-22.0.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/j2objc-annotations-1.1.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/jackson-annotations-2.9.10.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/jackson-core-2.9.10.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/jackson-databind-2.9.10.1.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/jackson-dataformat-cbor-2.9.10.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/janino-3.1.0.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/javassist-3.26.0-GA.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/jruby-complete-9.2.9.0.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/jsr305-1.3.9.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/log4j-api-2.12.1.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/log4j-core-2.12.1.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/log4j-slf4j-impl-2.12.1.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/logstash-core.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.core.commands-3.6.0.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.core.contenttype-3.4.100.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.core.expressions-3.4.300.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.core.filesystem-1.3.100.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.core.jobs-3.5.100.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.core.resources-3.7.100.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.core.runtime-3.7.0.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.equinox.app-1.3.100.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.equinox.common-3.6.0.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.equinox.preferences-3.4.1.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.equinox.registry-3.5.101.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.jdt.core-3.10.0.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.osgi-3.7.1.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/org.eclipse.text-3.5.101.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/reflections-0.9.11.jar:/app/elk/logstash-7.6.2/logstash-core/lib/jars/slf4j-api-1.7.25.jar org.logstash.Logstash -f /app/elk/logstash-7.6.2/config/logstash.conf
```

#### 14、登录kibana平台

```
http://192.168.183.10:5601/
```

##### 1) 在索引管理中查看日志数据 

![image-20210325134103273](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210325134103273.png)

##### 2) 创建索引，查看数据 

![image-20210325134243834](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210325134243834.png)

![image-20210325134346028](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210325134346028.png)



![image-20210325134435717](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210325134435717.png)



![image-20210325134550405](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210325134550405.png)

##### 3) 查看具体日志

![image-20210325134734030](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210325134734030.png)

##### 4) 创建可视化图形展示数据

![image-20210325135215160](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210325135215160.png)

![image-20210325135230224](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210325135230224.png)
## saltstack自动化运维工具

### 一、saltstack介绍

```
实现对IT基础设施批量管控
```

#### 1、saltstack组件

```
1、salt-master	管理端
2、salt-minion	被管理端
3、salt-syndic	salt代理
```

#### 2、saltstack特性

```
1、重量级的工具 
2、基于python开发、开源、跨平台
3、采用证书进行身份认证 
4、支持分布式的部署
5、提供api接口 
```



### 二、saltstack安装部署

#### 1、添加主机名解析 

```
[root@salt-master ~]# cat /etc/hosts

127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.140.11	salt-master.linux.com
192.168.140.12	node01.linux.com
192.168.140.13	node02.linux.com
[root@salt-master ~]# 

```

#### 2、安装部署salt-master

```
[root@salt-master ~]# yum install -y salt-master 

[root@salt-master ~]# systemctl start salt-master
[root@salt-master ~]# systemctl enable salt-master
 
[root@salt-master ~]# netstat -antp | grep python
tcp        0      0 0.0.0.0:4505            0.0.0.0:*               LISTEN      7121/python         
tcp        0      0 0.0.0.0:4506            0.0.0.0:*               LISTEN      7141/python   
```

#### 3、安装部署salt-minion

```
[root@node01 ~]# yum install -y salt-minion 

[root@node01 ~]# vim /etc/salt/minion 

master: 192.168.140.11
id: 192.168.140.12

[root@node01 ~]# systemctl start salt-minion.service 
[root@node01 ~]# systemctl enable salt-minion.service
```

#### 4、在master端签署证书

```
[root@salt-master ~]# salt-key -L
Accepted Keys:
Denied Keys:
Unaccepted Keys:
192.168.140.12
192.168.140.13
Rejected Keys:

[root@salt-master ~]# salt-key -A -y 
The following keys are going to be accepted:
Unaccepted Keys:
192.168.140.12
192.168.140.13
Key for minion 192.168.140.12 accepted.
Key for minion 192.168.140.13 accepted.

[root@salt-master ~]# salt-key -L
Accepted Keys:
192.168.140.12
192.168.140.13
Denied Keys:
Unaccepted Keys:
Rejected Keys:

```

#### 5、测试使用

```
[root@salt-master ~]# salt '*' test.ping
192.168.140.13:
    True
192.168.140.12:
    True
    
[root@salt-master ~]# salt '*' cmd.run 'uptime'
192.168.140.13:
     14:09:53 up 20 min,  2 users,  load average: 0.00, 0.03, 0.05
192.168.140.12:
     14:09:53 up 20 min,  2 users,  load average: 0.00, 0.03, 0.08
[root@salt-master ~]# 

```

#### 6、salt-key命令的选项

```
管理minion端的证书 

	-L, --list-all      List all public keys. (Deprecated: use "--list all")
    -a ACCEPT, --accept=ACCEPT
                        Accept the specified public key (use --include-all to
                        match rejected keys in addition to pending keys).
                        Globs are supported.
    -A, --accept-all    Accept all pending keys
    
    -r REJECT, --reject=REJECT
                        Reject the specified public key (use --include-all to
                        match accepted keys in addition to pending keys).
                        Globs are supported.
    -R, --reject-all    Reject all pending keys
    
   
    -d DELETE, --delete=DELETE
                        Delete the specified key. Globs are supported.
    -D, --delete-all    Delete all keys

```



### 二、salt常用模块

```
Usage: salt [options] '<target>' <function> [arguments]
```

#### 1、常用选项

```
以不同的方式匹配minion
```

##### 1) -L   以逗号隔开的方式写多个minion

```
[root@salt-master ~]# salt -L '192.168.140.12,192.168.140.13' test.ping
```

##### 2) -S	以网段的方式匹配minion

```
[root@salt-master ~]# salt -S '192.168.140.0/24' test.ping
```

##### 3) -N 以主机组的方式匹配minion

```
在master配置文件中事先定义主机组 

[root@salt-master ~]# vim /etc/salt/master 

nodegroups:
  group01: 'L@192.168.140.12,192.168.140.13'

[root@salt-master ~]# salt -N 'group01' test.ping

```

##### 4) -C	以多条件的方式匹配minion

```
[root@salt-master ~]# salt -C '192.168.140.12 and S@192.168.140.0/24' test.ping

[root@salt-master ~]# salt -C 'L@192.168.140.12,192.168.140.13 or S@192.168.140.0/24' test.ping
```

##### 5) -G	以grains数据组件中的数据匹配minion 

```
grains数据组件， 用于保存minion的状态数据(cpu, ip、主机名、操作系统等)
```

##### 查看grains中的数据

```
[root@salt-master ~]# salt '192.168.140.12' grains.items 
```

```
[root@salt-master ~]# salt -G "os:CentOS" test.ping
```

```
[root@salt-master ~]# salt -C 'G@os:CentOS and S@192.168.140.0/24' test.ping 
```



#### 2、常用模块

##### 1) 查看模块

```
[root@salt-master ~]# salt '192.168.140.12' sys.list_modules 
```

##### 2) 查看模块的操作方法

```
[root@salt-master ~]# salt '192.168.140.12' sys.list_functions user
```

##### 3) 查看操作方法

```
[root@salt-master ~]# salt '192.168.140.12' sys.doc service.start 
```



##### 1) cmd模块

```
[root@salt-master ~]# salt '*' cmd.run 'free -m'
```

##### 2) pkg模块

```
[root@salt-master ~]# salt '*' pkg.install vsftpd
```

##### 3) service模块

```
[root@salt-master ~]# salt '*' service.start vsftpd
[root@salt-master ~]# salt '*' service.enable vsftpd
```

##### 4) user/group模块

```
[root@salt-master ~]# salt '*' group.add dev
[root@salt-master ~]# salt '*' user.add king 
[root@salt-master ~]# salt '*' group.adduser dev king

```

##### 5) file模块

```
[root@salt-master ~]# salt '*' file.append /etc/profile "export JAVA_HOME=/usr/local/jdk"
```

##### 6) hosts模块

```
[root@salt-master ~]# salt '*' hosts.add_host 1.1.1.1 agent01
[root@salt-master ~]# salt '*' hosts.add_host 1.1.1.1 agent02
```

```
[root@salt-master ~]# salt '*' hosts.set_host 2.2.2.2 agent02

[root@salt-master ~]# salt '*' hosts.set_host 2.2.2.2 agent03

```





### 三、saltstack分布式

```
在minion数量过多时，通过部署salt代理，减轻master的工作负载
```

#### 1、在master上删除所有minion证书

```
[root@salt-master ~]# salt-key -D -y
Deleting the following keys:
Accepted Keys:
192.168.140.12
192.168.140.13
Key for minion 192.168.140.12 deleted.
Key for minion 192.168.140.13 deleted.

[root@salt-master ~]# salt-key -L
Accepted Keys:
Denied Keys:
Unaccepted Keys:
Rejected Keys:

```

#### 2、在minion上删除旧master信息 

```
[root@node01 ~]# rm -rf /etc/salt/pki/
```

#### 3、安装部署salt-syndic

```
[root@salt-syndic ~]# yum install -y salt-syndic 

[root@salt-syndic ~]# vim /etc/salt/master 

order_masters: True
syndic_master: 192.168.140.11

[root@salt-syndic ~]# systemctl start salt-master salt-syndic
[root@salt-syndic ~]# systemctl enable salt-master salt-syndic

```

#### 4、修改minion的配置

```
[root@node01 ~]# grep "^master" /etc/salt/minion
master: 192.168.140.14
[root@node01 ~]# systemctl restart salt-minion

```

#### 5、在master上签署代理的证书

```
[root@salt-master ~]# salt-key -L
Accepted Keys:
Denied Keys:
Unaccepted Keys:
salt-syndic.linux.com
Rejected Keys:

[root@salt-master ~]# salt-key -A -y
The following keys are going to be accepted:
Unaccepted Keys:
salt-syndic.linux.com
Key for minion salt-syndic.linux.com accepted.

[root@salt-master ~]# salt-key -L
Accepted Keys:
salt-syndic.linux.com
Denied Keys:
Unaccepted Keys:
Rejected Keys:
```

#### 6、在代理上签署minion证书 

```
[root@salt-syndic ~]# salt-key -L
Accepted Keys:
Denied Keys:
Unaccepted Keys:
192.168.140.12
192.168.140.13
Rejected Keys:
[root@salt-syndic ~]# salt-key -A -y
The following keys are going to be accepted:
Unaccepted Keys:
192.168.140.12
192.168.140.13
Key for minion 192.168.140.12 accepted.
Key for minion 192.168.140.13 accepted.
[root@salt-syndic ~]# salt-key -L
Accepted Keys:
192.168.140.12
192.168.140.13
Denied Keys:
Unaccepted Keys:
Rejected Keys:

```

#### 7、测试

```
[root@salt-master ~]# salt '*' cmd.run 'hostname'
192.168.140.13:
    node02.linux.com
192.168.140.12:
    node01.linux.com

```


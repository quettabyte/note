## RabbitMQ

### 一、RabbitMQ介绍

```
进程间通信IPC的方式：
	1、共享内存
	2、消息队列MQ Message Queue服务器

作用：
	用于构建消息服务
	消息服务用于解决多系统、异构系统间的数据交换，也可以用于实现系统间服务的相互调用 
```

#### 1、AMQP协议

```
Advanced Message Queuing Protocol
高级消息队列协议, 应用层协议

主要特性：
面向消息、队列、路由、可靠性、安全

RabbitMQ是一个开源的AMQP的实现，服务端使用Erlang语言编写，支持多种语言客户端。例如java, python, php, c, ajax等
```



### 二、RabbitMQ基本概念

#### 1、Procedure	生产者

```
即产生消息的客户端
procedure产生消息，并把消息发布到rabbitmq
```

#### 2、Consumer	消息者

```
即消费消息(处理消息)的客户端
consumer连接rabbitmq订阅消息，并处理消息

procedure产生消息 --------->   队列queue -----------> consumer消费消息

多个consumer可以订阅同一个队列。这时，该队列中的消息会被平均分配给所有的consumer，并不是所有consumer会收到所有的消息
```

#### 3、exchange	消息交换机

```
它指定消息按照什么规则路由到哪个队列 
exchange有多种工作类型，类型不同路由消息的方式也不同

procedure产生消息 --------->  exchange ------> 队列queue -----------> consumer消费消息
```

#### 4、queue	队列

```
承载消息的载体, 每个消息都会被放入到一个队列或多个队列中
```

#### 5、binding	绑定

```
将exchange与queue按特定的规则绑定起来
```

#### 6、Routing key

```
路由关键字，exchange根据这个key决定将消息投放到哪个队列
```

#### 7、Connection

```
就是个TCP连接，procedure, consumer首先都要与消息队列服务器建立TCP连接
```

#### 8、Channel

```
建立在TCP连接上的虚拟通道，用于传递消息
程序在使用消息队列时，首先要与服务器建立TCP连接，其次要建立channel传递消息
```

#### 9、vhosts

```
虚拟主机，一个vhosts可以理解为一个独立的rabbitMQ Server
借助该功能，可以让多个不同的app使用同一个服务器进行消息传递
```

#### 10、Message ack  消息确认机制 

```
实际应用中，可能会发生consumer接收到消息，但还没有处理完consumer就宕机的情况下，这种情况会导致消息丢失。
为解决这个问题，我们可以要求consumer处理完消息后给rabbitMQ发送一个确认信息(ack)，rabbitMQ接收到确认后才将消息删除；如果rabbitMQ没有收到ack就检测到consumer的连接断开，它会将消息发送给其他的consumer处理，避免消息丢失
```

#### 11、Message durability	消息持久化

```
Exchange持久化，在声明时指定durable=>1
Queue持久化，在声明时指定durable=>1
消息持久化，在投递时指定delivery_mode=>2; 1为非持久化
```

#### 12、prefetch count

```
用于设置rabbitMQ每次给consumer发送的消息的数量，避免多个consumer订阅一个队列的消息时，有些consumer过于繁忙，有些过于空闲
```



### 三、Exchange Type

```
Exchange接收到消息后，会根据消息中的key(routing key)和事先指定的bind key进行消息路由，将消息投递到一个或多个队列中；
Exchange类型不同，投递的规则也不同
```

#### 1、Fanout Exchange

```
将消息投递到与之绑定的所有queue上
类似于广播的方式, 无视key的绑定
```

![img](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fcukdd.blog.chinaunix.net%2Fattachment%2F201506%2F4%2F429659_143339769209d0.jpg&refer=http%3A%2F%2Fcukdd.blog.chinaunix.net&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1615390085&t=fd1ea7e4a6bf81162616fb8b8155102f)

#### 2、Direct Exchange

```
只有消息的routing key与binding key完全匹配时，消息才会被投递到对应的队列
```

![img](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimage109.360doc.com%2FDownloadImg%2F2018%2F06%2F2511%2F136714819_4_20180625115001269.png&refer=http%3A%2F%2Fimage109.360doc.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1615390123&t=3ebcc032bc40eadfb42154e567d8fd5d)

#### 3、Topic Exchange

```
模糊匹配
将routing key与binding key进行模糊匹配, 匹配成功则投递到对应的队列，否则丢弃

通配符：
	#：匹配多个词
		例如abc.#可以匹配abc.def, abc.ef.python
	*: 匹配单个词
```

![img](https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=1582907255,1496930809&fm=11&gp=0.jpg)
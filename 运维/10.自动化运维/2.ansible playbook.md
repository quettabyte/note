## Ansible playbook

### 一、playbook介绍

```
便于功能的重复使用

本质上就是个文本文件    *.yml
遵循YAML语法
```

#### 1、遵循YAML语法

```
1、同级别代码要有相同缩进、建议4个空格
2、一个键对应一个值，冒号后要有空格
		key: value
3、一个键对应多个值时，分行写
		key:
			- value1
			- value2
			- value3
```

#### 2、playbook结构

```
- hosts: 主机或主机组名
  user: root
  tasks:
      - name: 任务名称
	    模块名称: 参数1  参数2  参数3
	  - name: 任务名称
	    模块名称: 参数1  参数2  参数3
      - name: 任务名称
	    模块名称: 参数1  参数2  参数3
```

#### 3、创建用户openstack， shell为/sbin/nologin

##### 1） 编写剧本 

```
[root@localhost ~]# cat /opt/playbook/userCreate.yml
- hosts: webserver
  user: root
  tasks:
     - name: create user
       user: name=openstack shell=/sbin/nologin

```

##### 2) 执行剧本

```
[root@localhost ~]# ansible-playbook /opt/playbook/userCreate.yml 
```



#### 4、gather_facts参数

```
ansible执行剧本时，默认会调用setup模块搜集facts数据，可通过该参数取消默认行为
```

```
[root@localhost ~]# cat /opt/playbook/userCreate02.yml 
- hosts: webserver
  user: root
  gather_facts: False
  tasks:
     - name: create user
       user: name=king shell=/sbin/nologin
[root@localhost ~]# 
[root@localhost ~]# ansible-playbook /opt/playbook/userCreate02.yml

```



#### 5、部署MySQL剧本

```
[root@localhost ~]# cat /opt/playbook/installMySQL.yml 
- hosts: webserver
  user: root
  tasks:
     - name: install MySQL
       yum: name=mariadb-server state=present

     - name: copy my.cnf
       copy: src=/opt/playbook/files/my.cnf  dest=/etc/my.cnf

     - name: start MySQL daemon
       service: name=mariadb state=started enabled=yes 
```



### 二、变量

```
类型:
	自定义变量
	内置变量
		facts变量
		内置变量
```

#### 1、自定义变量

##### 1) 调用变量

```
{{ 变量名称 }}
```

##### 2) 在playbook中定义变量

```
- hosts: webserver
  user: root
  gather_facts: False
  vars:
    - username: "user01"
  tasks:
     - name: create user
       user: name={{ username }} state=present
```

##### 3) 在外部文件中定义变量

```
[root@localhost ~]# cat /opt/playbook/test1
username: "user02"
sh_name: "/sbin/nologin"

- hosts: webserver
  user: root
  gather_facts: False
  vars_files:
    - /opt/playbook/test1
  tasks:
     - name: create user
       user: name={{ username }} shell={{ sh_name }} state=present

```

##### 为确保敏感数据安全，可对变量文件进行加密

```
[root@localhost ~]# ansible-vault encrypt /opt/playbook/test1 
New Vault password: 
Confirm New Vault password: 
Encryption successful

[root@localhost ~]# cat /opt/playbook/test1
$ANSIBLE_VAULT;1.1;AES256
61356262363961353635373866336236326635653962643365316432636332636231343533356236
3336323639613236646162373165346637393433383938660a656365623231343831363063383663
31336562373166383462313933316162323639303363636136366135366136336134623832363561
6333333638663936660a306662373038623732643135393264323837383133323238326365393232
35316635323631633265376438363764343563323938373539353732353830643732333066633864
3934366562623164633036316265643565363938336131646630

[root@localhost ~]# ansible-playbook --ask-vault-pass /opt/playbook/userCreate03.yml 
Vault password: 

```

##### 解密文件

```
[root@localhost ~]# ansible-vault decrypt /opt/playbook/test1 
Vault password: 
Decryption successful

[root@localhost ~]# cat /opt/playbook/test1
username: "user02"
sh_name: "/sbin/nologin"

```

##### 4) 在主机清单文件中定义变量---为单个主机定义变量

```
[webserver]
192.168.140.12 username="user03"
192.168.140.13 username="user04"

[root@localhost ~]# cat /opt/playbook/userCreate03.yml
- hosts: webserver
  user: root
  gather_facts: False
  tasks:
     - name: create user
       user: name={{ username }} state=present

```

##### 5)  在主机清单文件中定义变量---为主机组定义变量

```
[webserver]
192.168.140.12 
192.168.140.13 

[webserver:vars]
username="user05"


[root@localhost ~]# cat /opt/playbook/userCreate03.yml
- hosts: webserver
  user: root
  gather_facts: False
  tasks:
     - name: create user
       user: name={{ username }} state=present

```

##### 6) 修改MySQL剧本 

```
[webserver]
192.168.140.12 server_id=12
192.168.140.13 server_id=13

[webserver:vars]
port=3307

[root@localhost ~]# cat /opt/playbook/files/my.cnf 
[mysqld]
server_id={{ server_id }}
port={{ port }}

[root@localhost ~]# cat /opt/playbook/installMySQL.yml 
- hosts: webserver
  user: root
  gather_facts: False
  tasks:
     - name: copy my.cnf
       template: src=/opt/playbook/files/my.cnf  dest=/etc/my.cnf

```



#### 2、内置变量

```
ansible_ssh_user
ansible_ssh_pass
ansible_ssh_port
```

```
[webserver]
192.168.140.12 server_id=12
192.168.140.13 server_id=13
192.168.140.14 ansible_ssh_user=root ansible_ssh_pass="redhat" ansible_ssh_port=33333
```



### 三、条件判断  when 

```
- hosts: webserver
  user: root
  tasks:
     - name: create user 10
       user: name=user10
       when: ansible_ens33["ipv4"]["address"] == "192.168.140.12"

     - name: create user 20
       user: name=user20
       when: ansible_ens33["ipv4"]["address"] == "192.168.140.13"
```



### 四、循环	loop

```
- hosts: webserver
  user: root
  gather_facts: False
  tasks:
     - name: create user
       user: name={{ item }} state=present
       loop:
          - user100
          - user101
          - user102
```

##### 结合字典使用循环

```
- hosts: webserver
  user: root
  gather_facts: False
  tasks:
     - name: create user
       user: name={{ item["username"] }} uid={{ item["user_id"] }} shell={{ item["sh_name"] }} state=present
       loop:
          - {"username":"user200", "user_id":2000, "sh_name":"/sbin/nologin"}
          - {"username":"user201", "user_id":2001, "sh_name":"/bin/false"}
          - {"username":"user202", "user_id":2002, "sh_name":"/sbin/nologin"}

```

##### 案例：部署nginx

```
- hosts: webserver 
  user: root
  gather_facts: False
  tasks:
     - name: install deps 
       yum: name={{ item }} state=present
       loop:
          - gcc
          - openssl-devel
          - pcre-devel
          - zlib-devel

     - name: push nginx installer
       get_url: url=http://nginx.org/download/nginx-1.19.8.tar.gz  dest=/tmp

     - name: install nginx
       shell: chdir=/tmp tar xf nginx-1.19.8.tar.gz && cd nginx-1.19.8 && ./configure --prefix=/usr/local/nginx && make && make install && rm -rf /tmp/nginx*

     - name: start nginx deamon
       shell: /usr/local/nginx/sbin/nginx && sed -ri '$a \/usr/local/nginx/sbin/nginx' /etc/rc.d/rc.local && chmod a+x /etc/rc.d/rc.local


```



### 五、Jinja模板

```
支持在文件中调用变量

{{ 变量名称 }}

增强配置文件的灵活性

建议文件名称为.j2结尾，以区分普通的文件 
```

```
[root@localhost ~]# tail /etc/ansible/hosts 

[webserver]
192.168.140.12 server_id=12 log_name=node01-bin-log
192.168.140.13 server_id=13 log_name=node02-bin-log

[webserver:vars]
port=3307


[root@localhost ~]# cat /opt/playbook/files/my.cnf.j2 

[mysqld]
server_id={{ server_id }}
port={{ port }}
log_bin={{ log_name }}
datadir=/var/lib/mysql
socket=/var/lib/mysql/mysql.sock

[mysqld_safe]
log-error=/var/log/mariadb/mariadb.log
pid-file=/var/run/mariadb/mariadb.pid


[root@localhost ~]# cat /opt/playbook/installMySQL.yml 
- hosts: webserver
  user: root
  gather_facts: False
  tasks:
     - name: copy my.cnf
       template: src=/opt/playbook/files/my.cnf.j2  dest=/etc/my.cnf

```

##### 配置facts变量以增加灵活性

```
[root@localhost ~]# cat /opt/playbook/files/my.cnf.j2 
[mysqld]
bind-address={{ ansible_all_ipv4_addresses[0] }}
```



### 六、handlers组件

```
与tasks是同级别的组件

特征：只有满足特定的条件时，handlers组件中的操作才会执行

应用：检测配置文件变化，自动重启服务
```

```
- hosts: webserver
  user: root
  tasks:
     - name: copy my.cnf
       template: src=/opt/playbook/files/my.cnf.j2  dest=/etc/my.cnf
       notify: restart MySQL daemon

  handlers:
     - name: restart MySQL daemon
       service: name=mariadb state=restarted

```



### 七、角色  role

```
本质上就是目录

/etc/ansible/roles
```

#### 1、创建角色

```
[root@localhost ~]# cd /etc/ansible/roles/
[root@localhost roles]# ansible-galaxy init lnmp
- Role lnmp was created successfully
```

```
[root@localhost roles]# tree /etc/ansible/roles/lnmp/
/etc/ansible/roles/lnmp/
├── defaults
│   └── main.yml
├── files
├── handlers
│   └── main.yml
├── meta
│   └── main.yml
├── README.md
├── tasks
│   └── main.yml
├── templates
├── tests
│   ├── inventory
│   └── test.yml
└── vars
    └── main.yml

```

```
在同一个角色中，相互引用文件、操作时，不需要添加任何路径！！！！！
```



#### 案例: 部署zabbix agent

```
[root@localhost ~]# tree /etc/ansible/roles/zabbixAgent/
/etc/ansible/roles/zabbixAgent/
├── defaults
│   └── main.yml
├── files
│   └── zabbix.repo
├── handlers
│   └── main.yml
├── meta
│   └── main.yml
├── README.md
├── tasks
│   └── main.yml
├── templates
│   └── zabbix_agentd.conf.j2
├── tests
│   ├── inventory
│   └── test.yml
└── vars
    └── main.yml

```

```
[root@localhost ~]# cat /etc/ansible/roles/zabbixAgent/tasks/main.yml 
---
# tasks file for zabbixAgent
- name: copy zabbix repo
  copy: src=zabbix.repo dest=/etc/yum.repos.d

- name: install zabbix-agent
  yum: name=zabbix-agent state=present

- name: push zabbix-agent config file
  template: src=zabbix_agentd.conf.j2  dest=/etc/zabbix/zabbix_agentd.conf
  notify: restart zabbix-agent

- name: start zabbix-agent daemon
  service: name=zabbix-agent state=started enabled=yes


[root@localhost ~]# cat /etc/ansible/roles/zabbixAgent/handlers/main.yml 
---
# handlers file for zabbixAgent
- name: restart zabbix-agent
  service: name=zabbix-agent state=restarted

[root@localhost ~]# grep -e "^Server" -e "^Hostname" /etc/ansible/roles/zabbixAgent/templates/zabbix_agentd.conf.j2 
Server=192.168.140.10
ServerActive=192.168.140.10
Hostname={{ ansible_nodename }}

```

#### 执行角色

```
[root@localhost ~]# cat /opt/playbook/installZabbixAgent.yml 
- hosts: webserver
  user: root
  roles:
      - zabbixAgent

[root@localhost ~]# ansible-playbook /opt/playbook/installZabbixAgent.yml 

```
















## nginx反向代理应用

### 一、location的写法

```
语法: 

location [=|~|~*|^~] uri地址 {
	........
	........
}
```

```
1、=		精确匹配

location = /test {
	
}

location = / {

}
```

```
2、~   通过正则表达式匹配请求, 区分大小写 

匹配php请求

location ~ \.php$ {

}

匹配图片请求

location ~ \.(jpg|gif|jpeg|png)$ {

}
```

```
3、~*	通过正则表达式请求, 不区分大小写
```

```
4、^~	不以正则表达式匹配请求

location ^~ /test {

}
```

##### 非常关键：

```
优先级: 从高到低

	=， ^~, ~, ~*, location /
```

#### 

#### 案例: 配置错误页面 

```
    error_page 404 /404.html;
    location = /404.html {
         root /data/shell;
    }
```



### 二、http的反向代理

```
location {
	proxy_pass  后端服务器; 
}
```

##### 案例1: 配置nginx将所有请求转交给后端服务器 

```
    location / {
        proxy_pass http://192.168.183.11;
    }
```

##### 案例2: 将/test1请求转交给后端服务器 

```
    location / {
         root /data/shell;
         index index.html;
    }

    location /test1 {
        proxy_pass http://192.168.183.11/test1;
    }
```

#### 1、定义location，如果明确的写了uri地址, 反向代理时也要具体的uri地址 

```
    location /music {
        proxy_pass http://192.168.183.11/mp3;
    }
```

```
    location /test2 {
        proxy_pass http://192.168.183.11/;
    }
```

#### 2、定义location如果使用正则表达式， 反向代理时只能写到后端服务器地址结束 

```
    location ~ /test3 {
        proxy_pass http://192.168.183.11;
    }
```

#### 3、配置后端服务器记录真实客户端地址

##### 1) 在请求中添加真实客户端地址的字段 

```
    location /music {
        proxy_pass http://192.168.183.11/mp3;
        proxy_set_header X-Real-IP $remote_addr;
    }
```

##### 2) 修改httpd访问日志格式combined

```
LogFormat "%{X-Real-IP}i %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
```












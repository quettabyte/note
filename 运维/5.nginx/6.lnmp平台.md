## lnmp平台 

### 一、lnmp平台介绍

```
作用: 解析php web应用程序  

与lamp平台的不同之处: 
	1、支持以fpm的方式安装部署php, 独立应用程序、配置文件、进程 
	2、nginx通过fastCGI机制调用php 
```



### 二、部署lnmp平台 

#### 1、安装nginx(略)

#### 2、源码安装MySQL 5.7

##### 1、创建数据目录、二进制日志目录

```
[root@localhost ~]# useradd -s /sbin/nologin -M mysql
[root@localhost ~]# mkdir -p /mysql/{data,log}
[root@localhost ~]# chown -R mysql.mysql /mysql/data/ /mysql/log/
```

##### 2、安装编译器

```
[root@localhost ~]# yum install -y cmake ncurses-devel
[root@localhost ~]# yum groupinstall -y "Development Tools" "Server Platform Development" "Desktop Platform Development"
```

##### 3、配置mysql功能参数

```
[root@localhost ~]# tar xf mysql-boost-5.7.17.tar.gz 
[root@localhost ~]# cd mysql-5.7.17/
[root@localhost mysql-5.7.17]# cmake . -DCMAKE_INSTALL_PREFIX=/usr/local/mysql -DMYSQL_UNIX_ADDR=/tmp/mysql.sock -DDEFAULT_CHARSET=utf8 -DDEFAULT_COLLATION=utf8_general_ci -DMYSQL_DATADIR=/mysql/data -DMYSQL_TCP_PORT=3306 -DWITH_BOOST=boost/boost_1_59_0/ -DWITH_MYISAM_STORAGE_ENGINE=1 -DWITH_INNOBASE_STORAGE_ENGINE=1 -DWITH_ARCHIVE_STORAGE_ENGINE=1 
[root@localhost mysql-5.7.17]# make 
[root@localhost mysql-5.7.17]# make install 

[root@localhost ~]# chown -R root.mysql /usr/local/mysql/

```

##### 4、初始化数据库

```
[root@localhost ~]# /usr/local/mysql/bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/mysql/data 
2021-03-01T05:37:14.766254Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).
2021-03-01T05:37:15.034083Z 0 [Warning] InnoDB: New log files created, LSN=45790
2021-03-01T05:37:15.082574Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.
2021-03-01T05:37:15.142103Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 2ded24fe-7a50-11eb-95ab-000c298fc368.
2021-03-01T05:37:15.144763Z 0 [Warning] Gtid table is not ready to be used. Table 'mysql.gtid_executed' cannot be opened.
2021-03-01T05:37:15.148486Z 1 [Note] A temporary password is generated for root@localhost: &OY+TG>(z19e

```

##### 5、编辑mysql的配置文件

```
[root@localhost ~]# cp /usr/local/mysql/support-files/my-default.cnf /etc/my.cnf
[root@localhost ~]# vim /etc/my.cnf

[mysqld]

# Remove leading # and set to the amount of RAM for the most important data
# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
# innodb_buffer_pool_size = 128M

# Remove leading # to turn on a very important data integrity option: logging
# changes to the binary log between backups.
log_bin=/mysql/log/master

# These are commonly set, remove the # and set as required.
basedir = /usr/local/mysql
datadir = /mysql/data
port = 3306
server_id = 10
socket = /tmp/mysql.sock

```

##### 6、启动mysql服务 

```
[root@localhost ~]# cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
[root@localhost ~]# chmod a+x /etc/init.d/mysqld
[root@localhost ~]# /etc/init.d/mysqld start
Starting MySQL.Logging to '/mysql/data/localhost.err'.
 SUCCESS! 
[root@localhost ~]# netstat -antp | grep mysql
tcp6       0      0 :::3306                 :::*                    LISTEN      58874/mysqld  
```

##### 7、导出mysql命令，修改密码 

```
[root@localhost ~]# tail -n 1 /etc/profile
export PATH=$PATH:/usr/local/mysql/bin

[root@localhost ~]# source /etc/profile

[root@localhost ~]# mysqladmin -u root -p password "WWW.1.com"
Enter password: 

[root@localhost ~]# mysql -uroot -pWWW.1.com

```

##### 8、导出mysql的库文件

```
[root@localhost ~]# cat /etc/ld.so.conf.d/mysql.conf 
/usr/local/mysql/lib

[root@localhost ~]# ldconfig 
[root@localhost ~]# ldconfig -v | grep mysql
```

##### 9、导出mysql头文件

```
[root@localhost ~]# ln -s /usr/local/mysql/include/  /usr/include/mysql
```



#### 3、源码编译安装php 

##### 1) 安装mcrypt加密、mhash认证模块

```
[root@localhost ~]# yum install mcrypt-2.6.8-11.el7.x86_64.rpm mhash-0.9.9.9-10.el7.x86_64.rpm mhash-devel-0.9.9.9-10.el7.x86_64.rpm libmcrypt-2.5.8-13.el7.x86_64.rpm libmcrypt-devel-2.5.8-13.el7.x86_64.rpm 
```

##### 2) 编译安装php 

```
[root@localhost ~]# tar xf php-5.6.27.tar.gz 
[root@localhost ~]# cd php-5.6.27/
[root@localhost php-5.6.27]# ./configure --prefix=/usr/local/php --with-mysql=/usr/local/mysql --with-mysqli=/usr/local/mysql/bin/mysql_config --with-openssl --enable-mbstring --with-freetype-dir --with-jpeg-dir --with-png-dir --with-zlib --with-libxml-dir=/usr --enable-xml --enable-fpm --with-mcrypt --with-config-file-path=/etc --with-config-file-scan-dir=/etc/php.d --with-bz2 
[root@localhost php-5.6.27]# make 
[root@localhost php-5.6.27]# make install
```

##### 3) 编辑php-fpm配置文件 

```
[root@localhost ~]# cp /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf
[root@localhost ~]# vim /usr/local/php/etc/php-fpm.conf

pid = run/php-fpm.pid
error_log = log/php-fpm.log
log_level = error

listen = 127.0.0.1:9000

pm.max_children = 10		//启动最大的子进程数 
pm.start_servers = 5		//默认启动的进程数 
pm.min_spare_servers = 5	//最少的空闲进程数
pm.max_spare_servers = 10	//最多的空闲进程数
pm.max_requests = 5000	//每个进程最多可处理的请求数 

user = nginx
group = nginx
```

##### 4) 准备php扩展功能模块的配置文件

```
[root@localhost ~]# cp php-5.6.27/php.ini-production /etc/php.ini
```

##### 5) 复制php启动脚本  

```
[root@localhost fpm]# pwd
/root/php-5.6.27/sapi/fpm

[root@localhost fpm]# cp init.d.php-fpm /etc/init.d/php-fpm
[root@localhost fpm]# chmod a+x /etc/init.d/php-fpm
```

##### 6) 启动php 

```
[root@localhost fpm]# /etc/init.d/php-fpm start
Starting php-fpm  done
[root@localhost fpm]# ps -elf | grep php
1 S root      37471      1  0  80   0 - 47824 ep_pol 14:27 ?        00:00:00 php-fpm: master process (/usr/local/php/etc/php-fpm.conf)
5 S nginx     37472  37471  0  80   0 - 47824 inet_c 14:27 ?        00:00:00 php-fpm: pool www
5 S nginx     37473  37471  0  80   0 - 47824 inet_c 14:27 ?        00:00:00 php-fpm: pool www
5 S nginx     37474  37471  0  80   0 - 47824 inet_c 14:27 ?        00:00:00 php-fpm: pool www
5 S nginx     37475  37471  0  80   0 - 47824 inet_c 14:27 ?        00:00:00 php-fpm: pool www
5 S nginx     37476  37471  0  80   0 - 47824 inet_c 14:27 ?        00:00:00 php-fpm: pool www
0 S root      37478  12535  0  80   0 - 28203 pipe_w 14:27 pts/0    00:00:00 grep --color=auto php
[root@localhost fpm]# 
[root@localhost fpm]# netstat -antp | grep php
tcp        0      0 127.0.0.1:9000          0.0.0.0:*               LISTEN      37471/php-fpm: mast 

```



#### 4、整合nginx和PHP 

```
[root@localhost ~]# vim /usr/local/nginx/conf/nginx.conf

        location / {
            root   html;
            index  index.php index.html index.htm;
        }


        location ~ \.php$ {
            root           html;
            fastcgi_pass   127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
            include        fastcgi_params;
        }

[root@localhost ~]# /usr/local/nginx/sbin/nginx -t
nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok
nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful
 
[root@localhost ~]# /usr/local/nginx/sbin/nginx -s reload


```

#### 5、测试lnmp平台是否正常 

##### 1) 是否可正常显示php页面 

```
[root@localhost ~]# cat /usr/local/nginx/html/test1.php
<?php
   phpinfo();
?>

```

##### 2）测试PHP正常连接MySQL数据库

```
[root@localhost ~]# cat /usr/local/nginx/html/test2.php
<?php
   $link=mysql_connect("localhost", "root", "WWW.1.com");
   if($link)
      echo "OK!!!!!!";
   else
      echo "Error!!!!!!!!";
   mysql_close();
?>

```



### 三、PHP添加额外的功能模块 

#### 1、添加xcache模块 

```
作用：PHP加速
```

##### 1) 安装xcache模块

```
[root@localhost ~]# tar xf xcache-3.2.0.tar.gz 
[root@localhost ~]# cd xcache-3.2.0/
[root@localhost xcache-3.2.0]# /usr/local/php/bin/phpize 		//生成configure配置工具 
Configuring for:
PHP Api Version:         20131106
Zend Module Api No:      20131226
Zend Extension Api No:   220131226
[root@localhost xcache-3.2.0]# ./configure --enable-xcache --with-php-config=/usr/local/php/bin/php-config 
[root@localhost xcache-3.2.0]# make 
[root@localhost xcache-3.2.0]# make install 
Installing shared extensions:     /usr/local/php/lib/php/extensions/no-debug-non-zts-20131226/

[root@localhost xcache-3.2.0]# ls /usr/local/php/lib/php/extensions/no-debug-non-zts-20131226/
opcache.a  opcache.so  xcache.so
```

##### 2) 配置PHP加载模块

```
[root@localhost xcache-3.2.0]# vim /etc/php.ini 
extension=/usr/local/php/lib/php/extensions/no-debug-non-zts-20131226/xcache.so
```

##### 3) 重启PHP，验证模块加载成功

```
[root@localhost ~]# /etc/init.d/php-fpm restart
Gracefully shutting down php-fpm . done
Starting php-fpm  done

[root@localhost ~]# /usr/local/php/bin/php -m | grep -i xcache		//查看php加载的模块 
XCache
XCache Cacher
XCache
XCache Cacher

```





#### 2、安装redis模块 

```
作用: PHP连接redis数据库 
```

##### 1) 安装redis模块 

```
[root@localhost ~]# tar xf redis-3.1.3.tgz 
[root@localhost ~]# cd redis-3.1.3/
[root@localhost redis-3.1.3]# /usr/local/php/bin/phpize 
Configuring for:
PHP Api Version:         20131106
Zend Module Api No:      20131226
Zend Extension Api No:   220131226
[root@localhost redis-3.1.3]# ./configure --enable-redis --with-php-config=/usr/local/php/bin/php-config 
[root@localhost redis-3.1.3]# make 
[root@localhost redis-3.1.3]# make install
Installing shared extensions:     /usr/local/php/lib/php/extensions/no-debug-non-zts-20131226/

[root@localhost redis-3.1.3]# ls /usr/local/php/lib/php/extensions/no-debug-non-zts-20131226/
opcache.a  opcache.so  redis.so  xcache.so

```



##### 2) 配置PHP加载模块 

```
[root@localhost ~]# vim /etc/php.ini 

extension=/usr/local/php/lib/php/extensions/no-debug-non-zts-20131226/redis.so
```



##### 3) 重启PHP，验证模块加载成功 

```
[root@localhost ~]# /etc/init.d/php-fpm restart
Gracefully shutting down php-fpm . done
Starting php-fpm  done

[root@localhost ~]# /usr/local/php/bin/php -m | grep -i redis
redis
```










## nginx管理操作

### 一、nginx平滑升级

```
支持在不影响客户端访问的情况下进行升级 

信号: 
	USR2	启动新版本nginx的进程 
	WINCH	平缓关闭旧的worker process


```

#### 1、查看nginx安装参数

```
[root@localhost ~]# /usr/local/nginx/sbin/nginx -V
nginx version: nginx/1.18.0
built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) 
built with OpenSSL 1.0.2k-fips  26 Jan 2017
TLS SNI support enabled
configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_flv_module --with-http_stub_status_module --with-http_gzip_static_module --http-client-body-temp-path=/var/tmp/nginx/client/ --http-proxy-temp-path=/var/tmp/nginx/proxy/ --http-fastcgi-temp-path=/var/tmp/nginx/fastcgi/ --http-uwsgi-temp-path=/var/tmp/nginx/uwsgi/ --http-scgi-temp-path=/var/tmp/nginx/scgi/ --with-pcre --with-file-aio --with-http_secure_link_module --with-threads

```

#### 2、配置新版本的nginx

```
[root@localhost ~]# tar xf nginx-1.19.7.tar.gz 
[root@localhost ~]# cd nginx-1.19.7/
[root@localhost nginx-1.19.7]# ./configure --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_flv_module --with-http_stub_status_module --with-http_gzip_static_module --http-client-body-temp-path=/var/tmp/nginx/client/ --http-proxy-temp-path=/var/tmp/nginx/proxy/ --http-fastcgi-temp-path=/var/tmp/nginx/fastcgi/ --http-uwsgi-temp-path=/var/tmp/nginx/uwsgi/ --http-scgi-temp-path=/var/tmp/nginx/scgi/ --with-pcre --with-file-aio --with-http_secure_link_module --with-threads
[root@localhost nginx-1.19.7]# make 

============================不要执行make install==========================

[root@localhost nginx-1.19.7]# ls objs/
autoconf.err  Makefile  nginx  nginx.8  ngx_auto_config.h  ngx_auto_headers.h  ngx_modules.c  ngx_modules.o  src

[root@localhost nginx-1.19.7]# objs/nginx -v
nginx version: nginx/1.19.7

```

#### 3、备份旧版本的二进制程序，将新版本程序拷贝到 nginx安装目录 

```
[root@localhost nginx-1.19.7]# mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak
[root@localhost nginx-1.19.7]# 
[root@localhost nginx-1.19.7]# cp objs/nginx /usr/local/nginx/sbin/
[root@localhost nginx-1.19.7]# 
[root@localhost nginx-1.19.7]# ls /usr/local/nginx/sbin/
nginx  nginx.bak
```

#### 4、启动新版本的nginx

```
[root@localhost ~]# kill -USR2 $(cat /usr/local/nginx/logs/nginx.pid)

[root@localhost ~]# ps -elf | grep nginx
1 S root       9713      1  0  80   0 - 11499 sigsus 09:23 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx
5 S nginx      9714   9713  0  80   0 - 11612 ep_pol 09:23 ?        00:00:00 nginx: worker process
0 S root      12570   9713  0  80   0 - 11503 sigsus 09:31 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx
5 S nginx     12571  12570  0  80   0 - 11617 ep_pol 09:31 ?        00:00:00 nginx: worker process

```

#### 5、平缓的关闭旧nginx产生的工作进程  

```
[root@localhost ~]# kill -WINCH $(cat /usr/local/nginx/logs/nginx.pid.oldbin)
[root@localhost ~]# ps -elf | grep nginx
1 S root       9713      1  0  80   0 - 11499 sigsus 09:23 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx
0 S root      12570   9713  0  80   0 - 11503 sigsus 09:31 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx
5 S nginx     12571  12570  0  80   0 - 11617 ep_pol 09:31 ?        00:00:00 nginx: worker process

```

#### 6、清除旧的nginx主进程、旧的二进制工具

```
[root@localhost ~]# kill $(cat /usr/local/nginx/logs/nginx.pid.oldbin)
[root@localhost ~]# ps -elf | grep nginx
0 S root      12570      1  0  80   0 - 11503 sigsus 09:31 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx
5 S nginx     12571  12570  0  80   0 - 11617 ep_pol 09:31 ?        00:00:00 nginx: worker process
0 S root      12596  12535  0  80   0 - 28203 pipe_w 09:36 pts/0    00:00:00 grep --color=auto nginx
[root@localhost ~]# 
[root@localhost ~]# rm -rf /usr/local/nginx/sbin/nginx.bak 

```

#### 7、验证nginx版本

```
[root@localhost ~]# /usr/local/nginx/sbin/nginx -v
nginx version: nginx/1.19.7
```



#### 二、添加第三方功能模块 

#### 1、查看nginx安装参数

```
[root@localhost ~]# /usr/local/nginx/sbin/nginx -V
nginx version: nginx/1.19.7
built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) 
built with OpenSSL 1.0.2k-fips  26 Jan 2017
TLS SNI support enabled
configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_flv_module --with-http_stub_status_module --with-http_gzip_static_module --http-client-body-temp-path=/var/tmp/nginx/client/ --http-proxy-temp-path=/var/tmp/nginx/proxy/ --http-fastcgi-temp-path=/var/tmp/nginx/fastcgi/ --http-uwsgi-temp-path=/var/tmp/nginx/uwsgi/ --http-scgi-temp-path=/var/tmp/nginx/scgi/ --with-pcre --with-file-aio --with-http_secure_link_module --with-threads
```

#### 2、添加功能模块

```
[root@localhost ~]# tar xf nginx-1.19.7.tar.gz 
[root@localhost ~]# cd nginx-1.19.7/
[root@localhost nginx-1.19.7]# ./configure --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_flv_module --with-http_stub_status_module --with-http_gzip_static_module --http-client-body-temp-path=/var/tmp/nginx/client/ --http-proxy-temp-path=/var/tmp/nginx/proxy/ --http-fastcgi-temp-path=/var/tmp/nginx/fastcgi/ --http-uwsgi-temp-path=/var/tmp/nginx/uwsgi/ --http-scgi-temp-path=/var/tmp/nginx/scgi/ --with-pcre --with-file-aio --with-http_secure_link_module --with-threads --add-module=/root/ngx_cache_purge-2.3
[root@localhost nginx-1.19.7]# make 

```

#### 3、替换旧的nginx可执行程序 

##### 1、备份旧执行程序 

```
[root@localhost nginx-1.19.7]# mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak
[root@localhost nginx-1.19.7]# cp objs/nginx /usr/local/nginx/sbin/
[root@localhost nginx-1.19.7]# ls /usr/local/nginx/sbin/
nginx  nginx.bak

```

##### 2、启动新版本的执行程序 

```
[root@localhost ~]# kill -USR2 $(cat /usr/local/nginx/logs/nginx.pid)
[root@localhost ~]# ps -elf | grep nginx
0 S root      12570      1  0  80   0 - 11503 sigsus 09:31 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx
5 S nginx     12571  12570  0  80   0 - 11617 ep_pol 09:31 ?        00:00:00 nginx: worker process
0 S root      15539  12570  0  80   0 - 11507 sigsus 10:37 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx
5 S nginx     15540  15539  0  80   0 - 11621 ep_pol 10:37 ?        00:00:00 nginx: worker process

```

##### 3、平缓关闭旧程序 的worker process

```
[root@localhost ~]# kill -WINCH $(cat /usr/local/nginx/logs/nginx.pid.oldbin)
[root@localhost ~]# ps -elf | grep nginx
0 S root      12570      1  0  80   0 - 11503 sigsus 09:31 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx
0 S root      15539  12570  0  80   0 - 11507 sigsus 10:37 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx
5 S nginx     15540  15539  0  80   0 - 11621 ep_pol 10:37 ?        00:00:00 nginx: worker process

```

##### 4、关闭旧master process

```
[root@localhost ~]# kill 12570
[root@localhost ~]# rm -rf /usr/local/nginx/sbin/nginx.bak 

[root@localhost ~]# /usr/local/nginx/sbin/nginx -V
nginx version: nginx/1.19.7
built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) 
built with OpenSSL 1.0.2k-fips  26 Jan 2017
TLS SNI support enabled
configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_flv_module --with-http_stub_status_module --with-http_gzip_static_module --http-client-body-temp-path=/var/tmp/nginx/client/ --http-proxy-temp-path=/var/tmp/nginx/proxy/ --http-fastcgi-temp-path=/var/tmp/nginx/fastcgi/ --http-uwsgi-temp-path=/var/tmp/nginx/uwsgi/ --http-scgi-temp-path=/var/tmp/nginx/scgi/ --with-pcre --with-file-aio --with-http_secure_link_module --with-threads --add-module=/root/ngx_cache_purge-2.3
[root@localhost ~]# 

```





### 三、stub_status模块

```
作用: 查看nginx工作状态  
```

```
        location = /status {
            stub_status;
            allow 192.168.140.1;
            deny all;
        }

```

```
Active connections: 1 		//并发连接数 
server accepts handled requests
 2[接收的连接数] 2[处理的连接数] 65[请求数] 
Reading: 0 Writing: 1 Waiting: 0 
 
 Reading: 正在读取请求头的连接数
 Writing: 正在构建响应的连接数
 Waiting: 空闲客户端的连接数
```


























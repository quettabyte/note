## nginx作为web服务应用

### 一、 nginx配置文件解析

#### 1、配置文件语法结构 

```
1、全局配置

2、事件驱动模型配置
events {
	...........
	...........
}

3、http服务相关配置
http {

	http服务全局配置
	
	server {
	
		location {				//匹配客户端访问请求，根据不同的请求做不同的响应
		
		}
		
		location {
		
		}
		
		location {
		
		}
	
	}
	
	server {
	
	}
	
	server {
	
	}

}

server {}: 虚拟主机配置
```



#### 2、全局配置

##### 1) 指定启动工作进程的用户

```
#user  nobody
```

##### 2) 默认启动的工作进程的数量

```
worker_processes  1;

建议指定与CPU数量一致或CPU数量的两倍
```

##### 3) 指定错误日志存放位置及日志级别

```
error_log  logs/error.log  error;
```

##### 4) 指定pid文件

```
pid        logs/nginx.pid;
```



#### 3、事件驱动模型配置 

```
events {
    use epoll;					//指定事件驱动模型
    worker_connections  4096;	//每个工作进程所能接受的最大连接数 
}
```



#### 4、http服务相关配置

##### 1) 指定子配置文件

```
include   子配置文件名称; 
```

##### 2） 定义访问日志格式

```
log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
                      

$remote_addr	客户端IP地址
$remote_user	客户端用户
$time_local		访问时间
$request		访问请求(请求方法   文件名称    HTTP协议版本)
$status			状态码
$body_bytes_sent	响应数据大小
$http_referer		超链接地址
$http_user_agent	浏览器类型

```

##### 3) 访问日志的存放位置

```
access_log  logs/access.log  main;
```

##### 4) 长连接超时时间

```
keepalive_timeout  65;
```

##### 5) 限制长连接所能发送的最大请求数 

```
keepalive_requests 100;
```

##### 6) 启用gzip压缩 

```
gzip  on;
```

##### 7) 启用sendfile机制，加快nginx工作效率

```
sendfile        on;

默认的行为是内核获取到文件内容，将内容加载到内核对应的内存，再从内核内存拷贝nginx对应的内存空间，比较耗时
sendfile机制：
	由内核直接将内容复制到nginx进程对应的内容，节省中间拷贝的时间 
```



### 二、虚拟主机配置

```
http {
	server {
		location {			//匹配不同的客户端请求
			......
			......			//响应方式
		}
        location {
        	.....
        	.....
        }
	}
	
	server {
	
	}
}
```

#### 1、指定监听地址及端口

```
listen       80;

	listen 80;
	listen ip:port; 	listen 192.168.183.10:80;
```

#### 2、指定网站名称

```
server_name	 shell.linux.com   linux.com;
```

#### 3、location配置

```
location  uri地址 {
	.........
	.........
}
```

```
location / {						//匹配所有访问请求
    root   html;					//指定网页目录 
    index  index.html index.htm;	//指定首页名称 
}
```

```
        location / {
            root   /test1;
            index  index.html index.htm;
        }

        location /test2 {
             root /web;    
             index index.html;
        }
```



#### 案例: 虚拟主机配置 

```
类型:
	基于名称的虚拟主机 
		shell.linux.com		/data/shell
		python.linux.com	/data/python
	基于IP地址的虚拟主机
```



##### shell.linux.com配置

```
[root@localhost ~]# cat /usr/local/nginx/conf/conf.d/shell.conf
server {
    listen 80;
    server_name shell.linux.com;

    access_log /usr/local/nginx/logs/shell.access.log main;
    error_log /usr/local/nginx/logs/shell.error.log;

    location / {
        root /data/shell;
        index index.html;
    }
}

[root@localhost ~]# vim /usr/local/nginx/conf/nginx.conf
include /usr/local/nginx/conf/conf.d/*.conf;

[root@localhost ~]# /usr/local/nginx/sbin/nginx -t
[root@localhost ~]# /usr/local/nginx/sbin/nginx -s reloa
```

##### python.linux.com配置

```
[root@localhost ~]# cat /usr/local/nginx/conf/conf.d/python.conf
server {
   listen 80;
   server_name python.linux.com linux.com;

   access_log /usr/local/nginx/logs/python.access.log main;
   error_log /usr/local/nginx/logs/python.error.log;

   location / {
      root /data/python;
      index index.html;
   }
}
```



#### 案例: 基于https的虚拟主机 

```
https://www.linux.com		/data/www 
```

##### 1、配置CA服务器

```
[root@ca ~]# touch /etc/pki/CA/index.txt
[root@ca ~]# echo 01 > /etc/pki/CA/serial

[root@ca ~]# openssl genrsa -out /etc/pki/CA/private/cakey.pem 1024
Generating RSA private key, 1024 bit long modulus
.................++++++
......++++++
e is 65537 (0x10001)

[root@ca ~]# openssl genrsa -out /etc/pki/CA/private/cakey.pem 1024
Generating RSA private key, 1024 bit long modulus
.................++++++
......++++++
e is 65537 (0x10001)

[root@ca ~]# openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -out /etc/pki/CA/cacert.pem -days 3650
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:cn
State or Province Name (full name) []:bj
Locality Name (eg, city) [Default City]:bj
Organization Name (eg, company) [Default Company Ltd]:bj
Organizational Unit Name (eg, section) []:bj
Common Name (eg, your name or your server's hostname) []:ca.linux.com
Email Address []:bj@qq.com
```

##### 2、为网站生成密钥、申请证书

```
[root@localhost ~]# openssl genrsa -out /usr/local/nginx/conf/conf.d/ssl/www.key 1024
Generating RSA private key, 1024 bit long modulus
.............................++++++
..++++++
e is 65537 (0x10001)

[root@localhost ~]# openssl req -new -key /usr/local/nginx/conf/conf.d/ssl/www.key -out /usr/local/nginx/conf/conf.d/ssl/www.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:cn
State or Province Name (full name) []:bj
Locality Name (eg, city) [Default City]:bj
Organization Name (eg, company) [Default Company Ltd]:bj
Organizational Unit Name (eg, section) []:bj
Common Name (eg, your name or your server's hostname) []:www.linux.com
Email Address []:bj@qq.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:

[root@localhost ~]# rsync -av /usr/local/nginx/conf/conf.d/ssl/www.csr root@192.168.183.11:/tmp/


[root@ca ~]# openssl ca -in /tmp/www.csr -out /etc/pki/CA/certs/www.crt
Using configuration from /etc/pki/tls/openssl.cnf
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: 1 (0x1)
        Validity
            Not Before: Feb 24 08:22:59 2021 GMT
            Not After : Feb 24 08:22:59 2022 GMT
        Subject:
            countryName               = cn
            stateOrProvinceName       = bj
            organizationName          = bj
            organizationalUnitName    = bj
            commonName                = www.linux.com
            emailAddress              = bj@qq.com
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                C5:C5:EE:EA:97:B3:52:69:A5:DB:EB:8D:1F:A4:62:1E:03:F9:21:13
            X509v3 Authority Key Identifier: 
                keyid:7C:AB:5D:44:9B:16:75:26:04:6C:44:3C:3B:71:99:7B:BD:D6:97:67

Certificate is to be certified until Feb 24 08:22:59 2022 GMT (365 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated

[root@ca ~]# rsync -av /etc/pki/CA/certs/www.crt root@192.168.183.10:/usr/local/nginx/conf/conf.d/ssl
```



##### 3、编辑nginx配置文件

```
 [root@localhost ~]# vim /usr/local/nginx/conf/nginx.conf
 
 server {
        listen       443 ssl;
        server_name  www.linux.com;

        ssl_certificate      /usr/local/nginx/conf/conf.d/ssl/www.crt;
        ssl_certificate_key  /usr/local/nginx/conf/conf.d/ssl/www.key;

        ssl_session_cache    shared:SSL:1m;
        ssl_session_timeout  5m;

        ssl_ciphers  HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers  on;

        location / {
            root   /data/www;
            index  index.html index.htm;
        }
    }
    
[root@localhost ~]# /usr/local/nginx/sbin/nginx -s reload
[root@localhost ~]# netstat -antp | grep nginx
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      939/nginx: master p 
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      939/nginx: master p 
```



##### 4、测试访问 

```
https://www.linux.com/
```



### 三、认证功能 

```
类型: 
	1、基于客户端地址的认证
	2、基于用户的认证
```

#### 1、基于客户端地址的认证

```
location uri地址 {
	allow 192.168.183.11;
	deny all;
}
```

#### 2、基于用户的认证

```
1、创建存放web认证用户的文件

[root@python ~]# htpasswd -c /usr/local/nginx/conf/conf.d/.webuser martin
New password: 
Re-type new password: 
Adding password for user martin

[root@python ~]# cat /usr/local/nginx/conf/conf.d/.webuser 
martin:$apr1$6MkuPcYq$JfeBXkU8hthxoEyRSPKFy.

2、编辑虚拟主机配置文件 

    location / {
        root /data/shell;
        index index.html;
        auth_basic "need to Login";
        auth_basic_user_file /usr/local/nginx/conf/conf.d/.webuser;
    }
```



### 四、autoindex模型

```
作用: 无首页时，自动列出网页目录下的文件；默认403

location {
	autoindex on;
}
```












































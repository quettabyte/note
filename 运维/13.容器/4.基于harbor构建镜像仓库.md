## 基于Harbor构建私有仓库

### 一、镜像仓库

```
类型: 
	公有仓库	DockerHub	hub.docker.com
	私有仓库
    	registry镜像
    	Harbor
```

#### 1、公有仓库

```
hub.docker.com 
```

#### 2、上传镜像

```
[root@test ~]# docker login
Login Succeeded

[root@test ~]# docker tag ubuntu:latest martinwjc/test01:v1
[root@test ~]# docker push martinwjc/test01:v1

[root@test ~]# docker logout

```



### 二、基于Harbor构建私有仓库

#### 一、Harbor简介

```
Harbor是一个用于存储和分发Docker镜像的企业级Registry服务器，通过添加一些企业必需的功能特性，例如安全、标识和管理等
基于Vmware开源 
```

```
特性：

    1. 基于角色的访问控制
    2. 镜像复制
    3. 图形化用户界面
    4. AD/LDAP 支持
    5. 审计管理
    6. 国际化
    7. RESTful API
    8. 部署简单
```

```
Harbor安装部署:
	1、on-line
	2、off-line
	
支持http, https协议进行数据传输 
```



#### 二、Harbor安装部署

##### 1、添加主机名解析 

```
[root@harbor ~]# vim /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.140.11	harbor.linux.com

```

##### 2、安装docker-ce

```
[root@harbor ~]# rpm -q docker-ce
docker-ce-20.10.5-3.el7.x86_64

[root@harbor ~]# cat /etc/docker/daemon.json 
{
"registry-mirrors": ["http://f1361db2.m.daocloud.io"]
}

[root@harbor ~]# systemctl restart docker 

```

##### 3、安装docker-compose工具

```
[root@harbor ~]# curl -L "https://github.com/docker/compose/releases/download/1.29.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

[root@harbor ~]# chmod a+x /usr/local/bin/docker-compose

[root@harbor ~]# docker-compose version
docker-compose version 1.29.0, build 07737305
docker-py version: 5.0.0
CPython version: 3.7.10
OpenSSL version: OpenSSL 1.1.0l  10 Sep 2019

```

##### 4、解压缩harbor

```
[root@harbor ~]# tar xf harbor-offline-installer-v2.2.1.tgz 
```

##### 5、配置CA服务器

```
[root@ca ~]# touch /etc/pki/CA/index.txt
[root@ca ~]# echo 01 > /etc/pki/CA/serial

[root@ca ~]# openssl genrsa -out /etc/pki/CA/private/cakey.pem 1024
Generating RSA private key, 1024 bit long modulus
......++++++
....................++++++
e is 65537 (0x10001)

[root@ca ~]# openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -out /etc/pki/CA/cacert.pem -days 3650

```

```
[root@harbor ~]# mkdir /root/harbor/ssl
[root@harbor ~]# openssl genrsa -out /root/harbor/ssl/harbor.key 2048
[root@harbor ~]# openssl req -new -key /root/harbor/ssl/harbor.key -out /root/harbor/ssl/harbor.csr

[root@harbor ~]# rsync -av /root/harbor/ssl/harbor.csr root@192.168.140.12:/tmp/
[root@ca ~]# openssl ca -in /tmp/harbor.csr  -out /etc/pki/CA/certs/harbor.crt -days 3650
[root@ca ~]# rsync -av /etc/pki/CA/certs/harbor.crt root@192.168.140.11:/root/harbor/ssl

[root@harbor ~]# ls /root/harbor/ssl/
harbor.crt  harbor.csr  harbor.key

```

##### 6、编辑harbor的配置文件 

```
[root@harbor ~]# cp harbor/harbor.yml.tmpl harbor/harbor.yml
[root@harbor ~]# vim harbor/harbor.yml

hostname: harbor.linux.com

http:
  # port for http, default is 80. If https enabled, this port will redirect to https port
  port: 80

# https related config
https:
  # https port for harbor, default is 443
  port: 443
  # The path of cert and key files for nginx
  certificate: /root/harbor/ssl/harbor.crt
  private_key: /root/harbor/ssl/harbor.key

harbor_admin_password: redhat

```

##### 7、启动harbor

```
[root@harbor harbor]# ./prepare 
[root@harbor harbor]# ./install.sh 

[root@harbor harbor]# docker image ls
[root@harbor harbor]# docker ps -a
```

##### 8、访问harbor

```
https://harbor.linux.com

默认管理员用户: admin
```



### 三、harbor使用

#### 1、说明 

```
Harbor仓库启用了https后，docker服务器要能正常登录访问仓库，需要将harbor的证书拷贝到docker服务器
```

```
[root@test ~]# mkdir /etc/docker/certs.d/harbor.linux.com -p

[root@harbor ~]# rsync -av harbor/ssl/harbor.crt root@192.168.140.10:/etc/docker/certs.d/harbor.linux.com
```

```
[root@test ~]# docker login harbor.linux.com
Username: martin
Password: 
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded

[root@test ~]# docker tag ubuntu:latest harbor.linux.com/project01/ubuntu:v1
[root@test ~]# docker push harbor.linux.com/project01/ubuntu:v1

[root@test ~]# docker logout harbor.linux.com

```
















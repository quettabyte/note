## 容器管理操作

### 一、创建容器时常用选项

#### 1、基本选项

```
-d	后台运行
-ti	分配操作终端
--name	容器名称
--restart=always	设置容器的重启策略 / 开机自启动 
```

```
[root@test ~]# docker run -tid --name test1 --restart=always nginx
```

#### 2、-p	发布服务 

```
-p 物理机端口:容器端口 

注意: 端口冲突！！！！
```

```
[root@test ~]# docker run -tid --name test2 -p 8000:80 nginx
```

#### 3、资源限制

```
针对CPU、内存进行限制

默认创建容器时，物理机是不会对容器做资源限制的，如果容器数量过多，导致oom现象，物理机启动oom-killler机制随机杀进程，可能会容器不能正常工作
```

##### 1) 内存资源限制   --memory=

```
[root@test ~]# docker run -tid --memory=512M nginx 
[root@test ~]# docker stats 7b95
```

```
[root@test ~]# docker run -tid --memory=512M polinux/stress /bin/bash
[root@test ~]# docker exec -ti 61e7 bash 
bash-5.0# stress --vm 10 --vm-bytes 500M --verbose 

```

##### 2) CPU资源限制	--cpus=

```
[root@test ~]# docker run -tid --cpus=2 polinux/stress /bin/bash
[root@test ~]# docker exec -ti 3722 bash

bash-5.0# stress --cpu 2 --io 4 --vm 2 --vm-bytes 128M --timeout 60s &
```

```
在物理机使用top查看CPU使用率 
```



#### 4、数据持久化存储 

```
通过数据卷实现容器数据的持久化存储  

数据卷本质上就是目录
默认存储到 /var/lib/docker/volumes 
```

##### 1） 数据卷管理操作

```
[root@test ~]# docker volume 

Usage:  docker volume COMMAND

Manage volumes

Commands:
  create      Create a volume
  inspect     Display detailed information on one or more volumes
  ls          List volumes
  prune       Remove all unused local volumes
  rm          Remove one or more volumes

```

##### 2) 创建数据卷 

```
[root@test ~]# docker volume create test_volume
test_volume
[root@test ~]# docker volume ls
DRIVER    VOLUME NAME
local     test_volume
[root@test ~]# 
[root@test ~]# ls /var/lib/docker/volumes/
backingFsBlockDev  metadata.db  test_volume
[root@test ~]# ls /var/lib/docker/volumes/test_volume/
_data

```

##### 3) 挂载使用卷

```
[root@test ~]# docker run -tid --mount src=test_volume,dst=/data centos /bin/bash
```

##### 一个数据卷可以同时被多个容器挂载使用

```
[root@test ~]# docker run -tid --mount src=test_volume,dst=/data centos /bin/bash
```

##### 4）另外一种方式    -v 

```
[root@test ~]# docker run -tid -p 16000:80 -v /webdata/:/usr/share/nginx/html nginx 
```



#### 5、定义变量

```
[root@test ~]# docker run -tid -e DATA="test" centos /bin/bash

[root@test ~]# docker run -tid -e MYSQL_ROOT_PASSWORD="redhat" mysql 

```



### 二、docker网络管理

#### 1、网络模式

```
[root@test ~]# docker network ls 
NETWORK ID     NAME      DRIVER    SCOPE
264e7a4174e8   bridge    bridge    local
98e7226268a2   host      host      local
1669e662c095   none      null      local
```

##### 1) bridge

```
NAT模式的网络
```

##### 2) host

```
容器与物理机共享同一个网络命名空间，注意端口冲突 
```

```
[root@test ~]# docker run -tid --net=host nginx
```

##### 3) none

```
容器不会有自己独立的网络配置
```

```
[root@test ~]# docker run -tid --net=none centos /bin/bash
```



#### 2、创建自定义网络

```
[root@test ~]# docker network create --subnet 10.1.1.0/24 --gateway 10.1.1.1 net_01
84b949edd379644166168b7a2ac750743f8ec5a2badcf69812088552e5721551

[root@test ~]# docker network ls
NETWORK ID     NAME      DRIVER    SCOPE
264e7a4174e8   bridge    bridge    local
98e7226268a2   host      host      local
84b949edd379   net_01    bridge    local

```

```
[root@test ~]# docker run -tid --net=net_01 centos /bin/bash
```

```
[root@test ~]# docker run -tid --net=net_01 --ip=10.1.1.100 centos /bin/bash
```



#### 3、网络通信

```
[root@test ~]# docker network connect net_01 acae
```



### 三、配置flannel+ectd实现容器间的通信

```
作用: 
	实现跨物理机间的容器通信 
	etcd：键值对数据库
```

```
flannel的作用:

    1、跨物理机间的容器通信
    2、改变容器获取IP的方式

etcd:
    NoSQL
    记录网段的分配信息
```



#### 1、配置主机名解析  

```
[root@test ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.140.10	test.linux.com
192.168.140.11	test02.linux.com

```

#### 2、两台服务器分配安装docker, flannel软件

```
[root@test ~]# yum install -y docker-ce flannel 
```

#### 3、在第一台服务器安装etcd数据库

```
[root@test ~]# yum install -y etcd 
```

#### 4、配置etcd数据库

```
[root@test ~]# vim /etc/etcd/etcd.conf 

#[Member]
ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379"

#
#[Clustering]
ETCD_ADVERTISE_CLIENT_URLS="http://0.0.0.0:2379"

[root@test ~]# systemctl start etcd
[root@test ~]# systemctl enable etcd
[root@test ~]# netstat -antp | grep 2379
tcp        0      0 127.0.0.1:50654         127.0.0.1:2379          ESTABLISHED 17820/etcd          
tcp6       0      0 :::2379                 :::*                    LISTEN      17820/etcd          
tcp6       0      0 127.0.0.1:2379          127.0.0.1:50654         ESTABLISHED 17820/etcd  

```

#### 5、测试etcd数据库是否正常

```
[root@test ~]# etcdctl ls
[root@test ~]# 
[root@test ~]# etcdctl set file01/name martin
martin
[root@test ~]# etcdctl get file01/name
martin
[root@test ~]# etcdctl ls
/file01

```

#### 6、编辑flannel配置文件

```
[root@test ~]# vim /etc/sysconfig/flanneld 

FLANNEL_ETCD_ENDPOINTS="http://192.168.140.10:2379"
FLANNEL_ETCD_PREFIX="/atomic.io/network"  
```

#### 7、在etcd数据库创建保存flannel网络的文件信息

```
[root@test ~]# etcdctl mk /atomic.io/network/config '{"Network":"10.0.0.0/16"}'
{"Network":"10.0.0.0/16"}
 
[root@test ~]# etcdctl ls /atomic.io/network
/atomic.io/network/config

```

#### 8、启动flanneld服务 

```
[root@test ~]# systemctl start flanneld.service 
[root@test ~]# systemctl enable flanneld.service 
```

#### 9、修改docker启动脚本，允许flannel接管docker网络

```
[root@test ~]# vim /usr/lib/systemd/system/docker.service 

ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock $DOCKER_NETWORK_OPTIONS


[root@test ~]# systemctl daemon-reload 
[root@test ~]# systemctl restart docker

```

```
[root@test ~]# ifconfig docker0
docker0: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500
        inet 10.0.3.1  netmask 255.255.255.0  broadcast 10.0.3.255
        inet6 fe80::42:50ff:fe12:fc8  prefixlen 64  scopeid 0x20<link>
        ether 02:42:50:12:0f:c8  txqueuelen 0  (Ethernet)
        RX packets 65  bytes 7534 (7.3 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 78  bytes 7405 (7.2 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

```

#### 10、在第二台服务器配置flannel

```
[root@test02 ~]# vim /etc/sysconfig/flanneld 

FLANNEL_ETCD_ENDPOINTS="http://192.168.140.10:2379"

FLANNEL_ETCD_PREFIX="/atomic.io/network"

[root@test02 ~]# systemctl start flanneld.service 
[root@test02 ~]# systemctl enable flanneld.service
```

```
[root@test ~]# vim /usr/lib/systemd/system/docker.service 

ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock $DOCKER_NETWORK_OPTIONS


[root@test ~]# systemctl daemon-reload 
[root@test ~]# systemctl restart docker
```

```
[root@test02 ~]# ifconfig docker0
docker0: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500
        inet 10.0.77.1  netmask 255.255.255.0  broadcast 10.0.77.255
        ether 02:42:2f:11:82:26  txqueuelen 0  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

```

#### 11、测试容器通信

```
[root@test ~]# iptables -P FORWARD ACCEPT
[root@test02 ~]# iptables -P FORWARD ACCEPT
```








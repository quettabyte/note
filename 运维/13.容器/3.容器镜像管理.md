## 容器镜像管理

### 一、镜像格式介绍

```
命名格式: 

	仓库地址/镜像名称:标记TAG 
	
	test.linux.com/data/nginx:v12 
	test.linux.com/nginx  ---------->  test.linux.com/nginx:latest 
	nginx
		hub.docker.com/library/nginx:latest 
```

### 二、镜像管理操作

#### 1、删除镜像

```
[root@test ~]# docker image rm polinux/stress:latest 
```

```
[root@test ~]# docker image inspect nginx:latest 
```

#### 2、导出镜像

```
[root@test ~]# docker image save -o nginx.tar nginx:latest 
```

#### 3、导入镜像

```
[root@test ~]# docker image load -i nginx.tar 

[root@test ~]# docker image import nginx.tar nginx:v1

```

#### 4、上传镜像

```
[root@test ~]# docker image tag nginx:latest testserver/nginx:v1.16
[root@test ~]# docker image ls
REPOSITORY         TAG       IMAGE ID       CREATED         SIZE
nginx              v1        8c6afc13fd44   2 minutes ago   137MB
nginx              latest    519e12e2a84a   2 days ago      133MB
testserver/nginx   v1.16     519e12e2a84a   2 days ago      133MB
mysql              latest    cbe8815cbea8   2 days ago      546MB
centos             latest    300e315adb2f   4 months ago    209MB

[root@test ~]# docker push testserver/nginx:v1.16 

```

### 三、容器镜像

```
只读的、分层的文件系统

核心技术:

1、cow机制   copy on write 写时复制 

	创建容器时，镜像会在最上层添加一个读写层，只有修改文件时，该才会被复制到读写层进行修改
	容器删除时，读写层会随之删除，所有容器对关键数据进行持久化存储 
	
2、Union FS	联合文件系统 
	
	支持将多个不同的文件系统挂载到同一个虚拟文件系统中 
	
	overlay2 

[root@test ~]# docker info 
Client:
 Context:    default
 Debug Mode: false
 Plugins:
  app: Docker App (Docker Inc., v0.9.1-beta3)
  buildx: Build with BuildKit (Docker Inc., v0.5.1-docker)

Server:
 Containers: 5
  Running: 4
  Paused: 0
  Stopped: 1
 Images: 6
 Server Version: 20.10.5
 Storage Driver: overlay2
  Backing Filesystem: xfs

```



### 四、dockerfile

```
作用: 定制镜像 

本质上就是文本文件 
```

#### 1、基本使用流程

```
1、规划建立目录

2、在目录创建名称为Dockerfile的文件

[root@test test1]# cat Dockerfile 
FROM centos:latest
RUN yum install -y net-tools

3、构建镜像

[root@test test1]# docker build -t centos:v1 ./ 
```

#### 2、dockerfile指令

##### 1) FROM 

```
指定基础镜像

FROM 镜像名称
```

##### 2) MAINTAINER

```
指定镜像的作者相关信息，可以使用docker image inspet查看信息
```

##### 3) RUN

```
RUN shell命令 && shell命令

在基础镜像上执行命令实现定制
```

##### 4) CMD

```
CMD shell命令

定义基于镜像启动容器时自动执行的命令 

注意:
	1、CMD在Dockerfile只能出现一次
	2、如果用户启动容器时手动指定了命令，用户指定的命令会覆盖CMD指定的命令 
	3、启动服务时需要按照前台的方式启动 
```

```
FROM centos:v1
MAINTAINER Martin
RUN yum install -y httpd \
    && rm -rf /etc/httpd/conf.d/welcome.conf \
    && echo "docker file cmd test" > /var/www/html/index.html
CMD ["/usr/sbin/httpd","-D","FOREGROUND"]
```

##### 5) EXPOSE

```
EXPOSE <port> [<port>/<protocol>...]

声明容器要发布的端口
```

```
[root@test httpd]# docker run -tid -P http:v3 
	-P： 在物理机上随机生成服务端口
    
[root@test httpd]# docker run -tid -p 80:80 http:v3 
```

##### 6) ADD

```
ADD [--chown=<user>:<group>] <src>... <dest>

	src: 
		本地文件
		URL地址

将物理机的文件拷贝到容器中 
如果源文件是压缩文件，ADD拷贝时会自动解压(gzip, bzip2 or xz)
```

##### 7) COPY

```
COPY [--chown=<user>:<group>] <src>... <dest>

	COPY:
		本地文件 

将文件推送到容器中
```

##### 8) ENV

```
ENV <key>=<value> ..

在容器中定义环境变量 
```

##### 9) VOLUME

```
VOLUME "/data"

声明持久化存储的目录, 使用docker run创建容器时，docker自动创建匿名卷进行持久化 

# docker inspect 容器ID
```

##### 10) USER

```
USER <user>

声明启动容器的用户
```

##### 11) WORKDIR

```
WORKDIR /path/to/workdir
```

##### 12）ENTRYPOINT

```
ENTRYPOINT command param1 param2

指定创建容器时自动执行的命令

注意: 
	1、ENTRYPOINT只能存在一条 
	2、ENTRYPOINT不会被覆盖

配置docker-entrypoint.sh脚本使用，通过ENTRYPOINT指定让容器创建时自动执行脚本中的内容
如果Dockerfile后续有CMD指令的话，在docker-entrypoint.sh脚本最后要存在一条exec "$@"
```

##### 配合CMD使用

```
ENTRYPOINT <command>
CMD ['参数1','参数2']

```

##### 示例: 编写nginx dockerfile 

```
[root@test nginxfile]# tree 
.
├── Dockerfile
├── index.html
└── nginx-1.19.9.tar.gz

0 directories, 3 files

```

```
FROM centos:latest

RUN yum install -y gcc openssl-devel zlib-devel pcre-devel make

ADD ./nginx-1.19.9.tar.gz /tmp/

WORKDIR /tmp

RUN cd nginx-1.19.9 \
    && ./configure --prefix=/usr/local/nginx \
    && make \
    && make install \
    && rm -rf /tmp/nginx*

ADD ./index.html /usr/local/nginx/html

EXPOSE 80 

CMD /usr/local/nginx/sbin/nginx -g "daemon off;" 

```































